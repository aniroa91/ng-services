@(rs: churn.models.OverviewResponse, arrayMonth: Array[String])
@import play.api.libs.json.Json
@import services.domain.CommonService

<script type="text/javascript">
        var width = '60%'
        var left = 'auto'
        var right = 'auto'
        if($(window).width() <= 600) {
            left = 110
            right = 0
            width = '70%'
        }
        else if($(window).width() > 600 && $(window).width() <= 800) {
            left = 'auto'
            right = 10
            width = '70%'
        }
        else if($(window).width() > 800 && $(window).width() <= 1024) {
            left = 'auto'
            right = 10
            width = '80%'
        }
        var options = {
            title: 'Churn Rate (%)',
            hAxis: {
                title: '',
                gridlines: {
                    count: 13,
                    color: 'transparent'
                },
                maxAlternation: 2, // use a maximum of 1 line of labels
                showTextEvery: 1, // show every label if possible
                minTextSpacing: 10 // minimum spacing between adjacent labels, in pixels
            },
            vAxis: {
                title: '',
                gridlines: {
                    count: 9,
                    color: '#f0f0f0'
                }
            },
            chartArea: {
                height: "70%",
                width: width,
                left: left,
                right: right
            },
            sizeAxis: {
                maxSize: 25
            },
            colorAxis: {colors: ['#F5F6CE', 'green']},
            bubble: {
                textStyle: {
                    auraColor: 'none',
                },
                cursor: 'pointer',
                opacity: 1
            },
            tooltip: {
                trigger: 'none'
            }
        };
        var optionsRegion = {
            title: 'Churn Rate (%)',
            hAxis: {
                title: '',
                gridlines: {
                    count: 14,
                    color: 'transparent'
                },
                viewWindow: {
                    min:0
                },
                textStyle : {
                    color:'#1c2752',
                    fontSize: 11
                },
                slantedText:true
                /*
                maxAlternation: 2, // use a maximum of 1 line of labels
                showTextEvery: 1, // show every label if possible
                minTextSpacing: 20 // minimum spacing between adjacent labels, in pixels*/
            },
            vAxis: {
                title: '',
                gridlines: {
                    count: @rs.trendRegionMonth._1.size+2,
                    color: '#f0f0f0'
                }
            },
            chartArea: {
                height: "74%",
                width: "73%",
                left: 150,
                right: 20
            },
            width: '100%',
            height: '100%',
            sizeAxis: {
                maxSize: 20
            },
            colorAxis: {colors: ['#F6CECE', '#B40404']},
            bubble: {
                textStyle: {
                    auraColor: 'none',
                },
                cursor: 'pointer',
                opacity: 1
            },
            tooltip: {
                trigger: 'none'
            }
        };
        var optionsPackage = {
            title: 'Churn Rate (%)',
            hAxis: {
                title: '',
                gridlines: {
                    count: 14,
                    color: 'transparent'
                },
                viewWindow: {
                    min:0
                },
                textStyle : {
                    color:'#1c2752',
                    fontSize: 11
                },
                slantedText: true
            },
            vAxis: {
                title: '',
                gridlines: {
                    count: 10,
                    color: '#f0f0f0'
                }
            },
            chartArea: {
                height: "74%",
                width: "73%",
                left: 150,
                right: 20
            },
            width: '100%',
            height: '100%',
            sizeAxis: {
                maxSize: 20
            },
            colorAxis: {colors: ['#F5F6CE', 'green']},
            bubble: {
                textStyle: {
                    auraColor: 'none',
                },
                cursor: 'pointer',
                opacity: 1
            },
            tooltip: {
                trigger: 'none'
            }
        };
        google.load('visualization', '1.0', {
            'packages' : [ 'corechart' ]
        });
        google.setOnLoadCallback(drawChart);

        function drawChart() {
            // click tab
            $('.nav-tabs li').click(function () {
                var tabCurr = $('.nav-tabs li.active').find('a').attr('class')
                var tab = $(this).find('a').attr('class')
                if(tabCurr != tab){
                    $('#tabName').val(tab)
                    $('.nav-tabs li').removeClass('in').removeClass('active')
                    $('.panel-body .tab-pane').removeClass('in').removeClass('active')
                    $('#'+tab).addClass('in').addClass('active')
                    $(this).addClass('in').addClass('active')
                    if(tab == "tabOverview"){
                        getAjaxChurn()
                    }
                    else{
                        getChurnByTab(tab)
                    }
                }
            })
            $('.sparkline1').sparkline('html',{
                type: 'line',
                width: '320px',
                height: '15px',
                lineColor: '#16a085',
                fillColor: '#ffffff',
                lineWidth: 1,
                spotColor: '#e21212',
                minSpotColor: '#132186',
                maxSpotColor: '#132186',
                highlightLineColor: '#ffffff',
                valueSpots:{'0:':'#e21212'},
                tooltipFormat: '{{offset:names}}: <b>{{y:value}}</b>',
                tooltipValueLookups: {
                    names: @Html(Json.stringify(Json.toJson(arrayMonth)))
                }
            });
            $(".slAge").select2({
                placeholder: "Choose age group ..."
            });
            $(".slPackage").select2({
                placeholder: "Choose package ..."
            });
            $('.radio').iCheck({
                radioClass: 'iradio_square-purple'
            });
            $('.checkbox').iCheck({
                checkboxClass: 'icheckbox_square-purple'
            });
            $('.monthPicker').datepicker({
                autoclose: true,
                minViewMode: 1,
                endDate: '0m',
                format: 'yyyy-mm'
            }).on('changeDate', function (selected) {
                var startDate = new Date(selected.date.valueOf());
                var yr = startDate.getFullYear();
                var month = startDate.getMonth() < 9 ? ('0' + Number(startDate.getMonth() + 1)) : (Number(startDate.getMonth() + 1));
                var newDate = yr + '-' + month;
                $('#month').val(newDate)
                // change highlight filters
                $('.monthGrp').removeAttr('style')
            });
            // jsTree Region and province
            $('.region').jstree({
                "plugins" : ["checkbox"],
                'checkbox': {
                    deselect_all: true,
                    three_state: false
                },
                'core' : {
                    multiple: false,
                    expand_selected_onload : false,
                    "themes":{
                        "icons":false
                    },
                    'data' : getJsonTreeListRegion(@Html(Json.stringify(Json.toJson(rs.province))),@Html(Json.stringify(Json.toJson( rs.province.map(x => x._1).distinct.sorted ))))
                }
            }).on('changed.jstree', function (e, data) {
                var i, j, nodes = [], provinces = [];
                for (i = 0, j = data.selected.length; i < j; i++) {
                    nodes.push(data.instance.get_node(data.selected[i]).id);
                }
                var regionArr = nodes.join(', ').split(',')
                for (var i = 0; i < regionArr.length; i++) {
                    provinces.push(regionArr[i])
                }
                $('#province').val(provinces)
            })

            // trend region and month charts bubble
            var containerBuble   = document.getElementById('bubleChurn')
            var catesMonth   = @Html(Json.stringify(Json.toJson(rs.trendRegionMonth._2)))
            var catesLocation = @Html(Json.stringify(Json.toJson(rs.trendRegionMonth._1)))

            var internetChurnHuyDv = getDataChurn(@Html(Json.stringify(Json.toJson(rs.trendRegionMonth._3))), "Month", "Location")
            var dataHuyDv = google.visualization.arrayToDataTable(internetChurnHuyDv)
            var chartHuyDv = new google.visualization.BubbleChart(containerBuble);
            google.visualization.events.addListener(chartHuyDv, 'ready', function () {
                Array.prototype.forEach.call(containerBuble.getElementsByTagName('text'), function(text) {
                    if ((text.getAttribute('text-anchor') === 'end') && (text.getAttribute('fill') === '#444444')) {
                        if(text.innerHTML == 0 || text.innerHTML == Object.keys(catesLocation).length+1)
                            text.setAttribute('fill-opacity',0)
                        else{
                            text.innerHTML = keyByValue(catesLocation, Number(text.innerHTML)) ;
                        }
                    }
                    // change label month
                    if ((text.getAttribute('text-anchor') === 'end') && (text.getAttribute('fill') === '#1c2752')) {
                        if(text.innerHTML == 0 || text.innerHTML == Object.keys(catesMonth).length + 1)
                            text.setAttribute('fill-opacity',0)
                        else{
                            text.innerHTML = keyByValue(catesMonth, Number(text.innerHTML))
                        }
                    }
                });
                // remove circle value =0
                Array.prototype.forEach.call(document.getElementById('bubleChurn').getElementsByTagName('circle'), function(circle) {
                    if(circle.getAttribute('r') == 5 && $('#minRatemonthRegion').val() == 0 && $('#minPertmonthRegion').val() == 0)
                        circle.setAttribute('r', 1)
                })
            });
            if(Object.keys(catesMonth).length == 1)
                optionsRegion.hAxis.gridlines.count = 4
            else
                optionsRegion.hAxis.gridlines.count = Object.keys(catesMonth).length+2
            chartHuyDv.draw(dataHuyDv, optionsRegion);
            var mouseX;
            var mouseY;
            $(document).mousemove(function(e) {
                if($(window).width() < 992){
                    mouseY = e.pageY - 790
                }
                else{
                    mouseY = e.pageY -490;
                }
            });

            function handlerOut() {
                $('.custom_tooltip').hide()
            }

            google.visualization.events.addListener(chartHuyDv, 'onmouseover', function (event) {
                var rate = dataHuyDv.getValue(event.row, 3);
                var xAxis = dataHuyDv.getValue(event.row, 1);
                var yAxis = dataHuyDv.getValue(event.row, 2);
                var percent = dataHuyDv.getValue(event.row, 4);
                var contracts = dataHuyDv.getValue(event.row, 5);
                var x = mouseX - 225;
                if($(window).width() < 992){
                    mouseY = mouseY - 870
                }
                else{
                    mouseY = mouseY -600
                }
                var y = mouseY
                if(!(Number(percent == 0) && Number(rate) == 0)){
                    $('#bubleChurn_tooltip').html('<div><p><b>Month:</b> ' + keyByValue(catesMonth, xAxis) +'</p><p><b>Location:</b> '+ keyByValue( catesLocation, yAxis) +
                            '</p><p><b>Rate:</b> '+ rate +' %</p><p><b>Percent:</b> '+ percent +' %</p><p><b>Number of contracts: </b>'+contracts+'</p></div>').css({
                        'top': y,
                        'left': x
                    }).fadeIn('slow');
                }
                // remove circle value =0
                Array.prototype.forEach.call(document.getElementById('bubleChurn').getElementsByTagName('circle'), function(circle) {
                    if($('#minRatemonthProf').val() == 0 && $('#minPertmonthProf').val() == 0 && (circle.getAttribute('fill') == 'none' || circle.getAttribute('r') == 5)){
                        circle.setAttribute('r', 1)
                    }
                })
            });
            google.visualization.events.addListener(chartHuyDv, 'onmouseout', handlerOut);

            var track1 = Highcharts.chart('track1', {
                chart: {
                    type: 'column'
                },
                title: {
                    text: ''
                },
                xAxis: {
                    categories: @Html(Json.stringify(Json.toJson(rs.numofMonth.map(x=> x._1).distinct.sorted)))
                },
                yAxis: {
                    title: {
                        text: ''
                    },
                    stackLabels: {
                        enabled: true,
                        style: {
                            fontWeight: 'bold'
                        }
                    }
                },
                plotOptions: {
                    column: {
                        stacking: 'normal'
                    }
                },
                colors : ['#fe7096','#3498DB'],
                tooltip: {
                    shared: true
                },
                series: [{
                    name: 'HSSD',
                    data: @Html(Json.stringify(Json.toJson(rs.numofMonth.filter(x=> x._2.toInt == 1).sorted.map(x=> x._3))))
                }, {
                    name: 'CTBDV',
                    data: @Html(Json.stringify(Json.toJson(rs.numofMonth.filter(x=> x._2.toInt == 3).sorted.map(x=> x._3))))
                }]
            });

            var track2 = Highcharts.chart('track2', {
                chart: {
                    zoomType: 'xy'
                },

                title: {
                    text: ''
                },

                colors : ['rgb(126,223,114)', '#73879C', 'rgb(255,122,86)'],

                xAxis: {
                    categories: @Html(Json.stringify(Json.toJson(rs.trendRatePert.map(x=> x._1).distinct.sorted)))
                },

                yAxis: [{
                    labels: {
                        format: '{value}',
                        style: {
                            color: "rgb(255,122,86)"
                        }
                    },
                    title: {
                        text: 'Churn Rate(%) & F1',
                        style: {
                            color: "rgb(255,122,86)"
                        }
                    }
                }, { // Secondary yAxis
                    max: 100,
                    min: 0,
                    title: {
                        text: 'Churn Percent',
                        style: {
                            color: "#73879C"
                        }
                    },
                    labels: {
                        format: '{value} %',
                        style: {
                            color: "#73879C"
                        }
                    },
                    opposite: true
                }],

                tooltip: {
                    shared: true
                },

                series: [{
                    type: 'column',
                    name: 'Churn Rate(%)',
                    yAxis: 0,
                    data: @Html(Json.stringify(Json.toJson(rs.trendRatePert.map(x=> x._2))))
                }, {
                    type: 'column',
                    name: 'Churn Percent(%)',
                    yAxis: 1,
                    data: @Html(Json.stringify(Json.toJson(rs.trendRatePert.map(x=> x._3))))
                }, {
                    type: 'spline',
                    name: 'F1',
                    yAxis: 0,
                    data: @Html(Json.stringify(Json.toJson(rs.trendRatePert.map(x=> x._4))))
                }]

            });

            var dailyTrend = Highcharts.chart('dailyTrend', {
                chart:{
                    zoomType: 'x'
                },
                title: {
                    text: ''
                },
                xAxis: {
                    categories: []
                },
                yAxis: {
                    title: {
                        text: null
                    }
                },
                tooltip: {
                    crosshairs: true,
                    shared: true
                },
                series: []
            });

            // click tooltip title
            var specifiedElement = document.getElementsByClassName('aMore');
            document.addEventListener('click', function(event) {
                var isClickInside = specifiedElement[Number($('#indexChart').val())].contains(event.target)
                if(!isClickInside && String(event.target.className).indexOf('tooltipSL')<0){
                    $('.ddMore').hide()
                    $('.dots').show()
                    $('.more').hide()
                    $('.tooltipSL').removeClass('fa-angle-double-up').addClass('fa-angle-double-down')
                }
            });

            $('.slPoint').on('change', function () {
                $('#point').val(this.value)
                getChurnByTab($('#tabName').val())
            })

            function getAjaxChurn() {
                var fields = getParamFields(document.querySelector('input[name=csrfToken]').value)
                $.ajax({
                    url: "/overview/getJsonOverview",
                    cache: false,
                    data:  fields,
                    type:"POST",
                    beforeSend: function () {
                        $('.divLeft').waitMe({
                            effect: 'progressBar',
                            text: 'Please wait...',
                            bg: 'rgba(255,255,255,0.7)',
                            color: '#000',
                            textPos: 'vertical'
                        });
                    },
                    success: function (dta) {
                        if(dta != "Error"){
                            $('.monthGrp').attr('style','background-color: #16a085!important;color: #fff')
                            /* update box number */
                            // box Active Contract
                            $('#boxCtActive .currCtActive').text(dta.numContract.actives.curr)
                            var prevCtActive = '<h4>'+dta.numContract.actives.prev+' <i class="fa fa-info-circle iconTip" title="Tổng số hợp đồng tháng cùng kỳ năm ngoái"></i></h4>';
                            prevCtActive += (Number(dta.numContract.actives.prev.replace(",","")) > Number(dta.numContract.actives.curr.replace(",","")))? '<span class="down"><i class="fa fa-arrow-down fadeInDown animated" aria-hidden="true"></i> ' : '<span class="up"><i class="fa fa-arrow-up fadeInUp animated" aria-hidden="true"></i> '
                            prevCtActive += dta.numContract.actives.perct+' % </span> from '+dta.lastYYYYmm
                            $('#boxCtActive .prevCtActive').html("").append(prevCtActive)
                            if(dta.numContract.actives.curr == "0" && dta.numContract.actives.prev == "0") $('#boxCtActive').attr('style','opacity:0.2')
                            else $('#boxCtActive').removeAttr('style')

                            // box HUYDV Contract
                            $('#boxCtHuydv .currCtHuydv').text(dta.numContract.huydv.curr)
                            var prevCthuydv = '<h4>'+dta.numContract.huydv.prev+' <i class="fa fa-info-circle iconTip" title="Tổng số hợp đồng HSSD cùng kỳ năm ngoái"></i></h4>';
                            prevCthuydv += (Number(dta.numContract.huydv.prev.replace(",","")) > Number(dta.numContract.huydv.curr.replace(",",""))) ? '<span class="down"><i class="fa fa-arrow-down fadeInDown animated" aria-hidden="true"></i> ' : '<span class="up"><i class="fa fa-arrow-up fadeInUp animated" aria-hidden="true"></i> '
                            prevCthuydv += dta.numContract.huydv.perct+' % </span> from '+dta.lastYYYY
                            $('#boxCtHuydv .prevCtHuydv').html("").append(prevCthuydv)
                            if(dta.numContract.huydv.curr == "0" && dta.numContract.huydv.prev == "0") $('#boxCtHuydv').attr('style','opacity:0.2')
                            else $('#boxCtHuydv').removeAttr('style')

                            // box CTBDV Contract
                            $('#boxCtCtbdv .currCtCtbdv').text(dta.numContract.ctbdv.curr)
                            var prevCtCtbdv = '<h4>'+dta.numContract.ctbdv.prev+' <i class="fa fa-info-circle iconTip" title="Tổng số hợp đồng CTBDV cùng kỳ năm ngoái"></i></h4>';
                            prevCtCtbdv += (Number(dta.numContract.ctbdv.prev.replace(",","")) > Number(dta.numContract.ctbdv.curr.replace(",","")))? '<span class="down"><i class="fa fa-arrow-down fadeInDown animated" aria-hidden="true"></i> ' : '<span class="up"><i class="fa fa-arrow-up fadeInUp animated" aria-hidden="true"></i> '
                            prevCtCtbdv += dta.numContract.ctbdv.perct+' % </span> from '+dta.lastYYYY
                            $('#boxCtCtbdv .prevCtCtbdv').html("").append(prevCtCtbdv)
                            if(dta.numContract.ctbdv.curr == "0" && dta.numContract.ctbdv.prev == "0") $('#boxCtCtbdv').attr('style','opacity:0.2')
                            else $('#boxCtCtbdv').removeAttr('style')

                            // box Total Churn Rate
                            $('.currMonth').text($('.monthGrp').val())
                            $('#boxRateTotal .avgRateTotal').text(dta.churnRate.totalRate.avg)
                            $('#boxRateTotal .currRateTotal').html(dta.churnRate.totalRate.curr+' % <i class="fa fa-info-circle iconTip" title="Tỷ lệ rời mạng, bao gồm HSSD và CTBDV, của tháng hiện tại"></i>')
                            if(dta.churnRate.totalRate.curr == 0 && dta.churnRate.totalRate.avg == 0) $('#boxRateTotal').attr('style','opacity:0.2')
                            else $('#boxRateTotal').removeAttr('style')

                            // box HUYDV Churn Rate
                            $('#boxRateHuydv .avgRateHuydv').text(dta.churnRate.huydvRate.avg)
                            $('#boxRateHuydv .currRateHuydv').html(dta.churnRate.huydvRate.curr+' % <i class="fa fa-info-circle iconTip" title="Tỷ lệ rời mạng, tính theo HSSD, của tháng hiện tại"></i>')
                            if(dta.churnRate.huydvRate.curr == 0 && dta.churnRate.huydvRate.avg == 0) $('#boxRateHuydv').attr('style','opacity:0.2')
                            else $('#boxRateHuydv').removeAttr('style')

                            // box CTBDV Churn Rate
                            $('#boxRateCtbdv .avgRateCtbdv').text(dta.churnRate.ctbdvRate.avg)
                            $('#boxRateCtbdv .currRateCtbdv').html(dta.churnRate.ctbdvRate.curr+ ' % <i class="fa fa-info-circle iconTip" title="Tỷ lệ rời mạng, tính theo CTBDV, của tháng hiện tại"></i>')
                            if(dta.churnRate.ctbdvRate.curr == 0 && dta.churnRate.ctbdvRate.avg == 0) $('#boxRateCtbdv').attr('style','opacity:0.2')
                            else $('#boxRateCtbdv').removeAttr('style')

                            // comment Chart
                            $('.comment').text(dta.cmtChart)

                            // sparkline table
                            var tBody = parseTbChurnRate(dta.tbChurn, dta.tbChurn.arrMonth, 1)
                            $('#tbChurn1').html("").append(tBody)
                            $('.sparkline1').sparkline('html',{
                                type: 'line',
                                width: '320px',
                                height: '15px',
                                lineColor: '#16a085',
                                fillColor: '#ffffff',
                                lineWidth: 1,
                                spotColor: '#e21212',
                                minSpotColor: '#132186',
                                maxSpotColor: '#132186',
                                highlightLineColor: '#ffffff',
                                valueSpots:{'0:':'#e21212'},
                                tooltipFormat: '{{offset:names}}: <b>{{y:value}}</b>',
                                tooltipValueLookups: {
                                    names: dta.tbChurn.arrMonth
                                }
                            });
                            $('#tbChurnFirst .thFirst').text(dta.location)
                            // bubble charts
                            if(dta.churnBubble.data.length <= 0){
                                $('#buble_overlay').hide()
                                $('#bubleChurn').hide()
                            }
                            else{
                                $('#buble_overlay').show()
                                $('#bubleChurn').show()
                            }
                            $('#churn1_txtMin').text(dta.churnBubble.minPercent)
                            $('#churn1_txtMax').text(dta.churnBubble.maxPercent)
                            $('#churn1_circle2').text(Number(dta.churnBubble.minPercent + (dta.churnBubble.maxPercent-dta.churnBubble.minPercent)/5*2).toFixed(2))
                            $('#churn1_circle3').text(Number(dta.churnBubble.minPercent + (dta.churnBubble.maxPercent-dta.churnBubble.minPercent)/5*3).toFixed(2))
                            Object.keys(dta.churnBubble.catesRegion).length >8 ? $('#bubleChurn').attr('style','height: 420px'): $('#bubleChurn').attr('style','height: 340px')
                            var chartRegionMonth = new google.visualization.BubbleChart(document.getElementById('bubleChurn'))
                            google.visualization.events.addListener(chartRegionMonth, 'ready', function () {
                                Array.prototype.forEach.call(document.getElementById('bubleChurn').getElementsByTagName('text'), function(text) {
                                    if ((text.getAttribute('text-anchor') === 'end') && (text.getAttribute('fill') === '#444444')) {
                                        if(text.innerHTML == 0 || text.innerHTML == undefined || text.innerHTML == Object.keys(dta.churnBubble.catesRegion).length+1)
                                            text.setAttribute('fill-opacity',0)
                                        else{
                                            text.innerHTML = keyByValue(dta.churnBubble.catesRegion, Number(text.innerHTML))
                                        }
                                    }
                                    // change label month
                                    if ((text.getAttribute('text-anchor') === 'end') && (text.getAttribute('fill') === '#1c2752')) {
                                        if(Object.keys(dta.churnBubble.catesMonth).length == 1){
                                            if (text.innerHTML == 0.5 || text.innerHTML == 0.0 || text.innerHTML == 1.5)
                                                text.setAttribute('fill-opacity', 0)
                                            else {
                                                if(text.innerHTML == 1.0){
                                                    text.innerHTML = keyByValue(dta.churnBubble.catesMonth, 1)
                                                }
                                            }
                                        }
                                        else{
                                            if(text.innerHTML == 0 || text.innerHTML >= Object.keys(dta.churnBubble.catesMonth).length+1)
                                                text.setAttribute('fill-opacity',0)
                                            else{
                                                text.innerHTML = keyByValue(dta.churnBubble.catesMonth, Number(text.innerHTML))
                                            }
                                        }
                                    }
                                });
                                // remove circle value =0
                                Array.prototype.forEach.call(document.getElementById('bubleChurn').getElementsByTagName('circle'), function(circle) {
                                    if(circle.getAttribute('r') == 5 && Number(dta.churnBubble.isNull) == 1)
                                        circle.setAttribute('r', 1)
                                })
                            })
                            var dataRegionMonth = google.visualization.arrayToDataTable(getDataChurn(dta.churnBubble.data,  "Month", "Location"))
                            if(Object.keys(dta.churnBubble.catesMonth).length == 1)
                                optionsRegion.hAxis.gridlines.count = 4
                            else
                                optionsRegion.hAxis.gridlines.count = Object.keys(dta.churnBubble.catesMonth).length+2
                            optionsRegion.vAxis.gridlines.count = Object.keys(dta.churnBubble.catesRegion).length+2
                            optionsRegion.chartArea.left =170;
                            chartRegionMonth.draw(dataRegionMonth, optionsRegion)
                            google.visualization.events.addListener(chartRegionMonth, 'onmouseover', function (event) {
                                var rate = dataRegionMonth.getValue(event.row, 3);
                                var xAxis = dataRegionMonth.getValue(event.row, 1);
                                var yAxis = dataRegionMonth.getValue(event.row, 2);
                                var percent = dataRegionMonth.getValue(event.row, 4);
                                var contracts = dataRegionMonth.getValue(event.row, 5);
                                var x = mouseX - 225;
                                if($(window).width() < 992){
                                    mouseY = mouseY - 870
                                }
                                else{
                                    mouseY = mouseY -600
                                }
                                var y = mouseY
                                if(!(Number(percent == 0) && Number(rate) == 0)){
                                    $('#bubleChurn_tooltip').html('<div><p><b>Month:</b> ' + keyByValue(dta.churnBubble.catesMonth, xAxis) +'</p><p><b>Location:</b> '+ keyByValue( dta.churnBubble.catesRegion, yAxis) +
                                            '</p><p><b>Rate:</b> '+ rate +' %</p><p><b>Percent:</b> '+ percent +' %</p><p><b>Number of contracts: </b>'+contracts+'</p></div>').css({
                                        'top': y,
                                        'left': x
                                    }).fadeIn('slow');
                                }
                                // remove circle value =0
                                Array.prototype.forEach.call(document.getElementById('bubleChurn').getElementsByTagName('circle'), function(circle) {
                                    if(Number(dta.churnBubble.isNull) == 1 && (circle.getAttribute('fill') == 'none' || circle.getAttribute('r') == 5)){
                                        circle.setAttribute('r', 1)
                                    }
                                })
                            })
                            google.visualization.events.addListener(chartRegionMonth, 'onmouseout', handlerOut)

                            $('.counter').counterUp({
                                delay: 10,
                                time: 500
                            });

                            // update chart: Number of Contracts By Status
                            track1.xAxis[0].update({categories: dta.numofMonth.cates})
                            updateChartOverview(track1, getJsonChurnSeries(dta.numofMonth, 0))

                            // udpate chart:Churn Rate and Percent By Status
                            track2.xAxis[0].update({categories: dta.trendRatePert.totalTrend.cates})
                            track2.yAxis[1].update({
                                max: Number(dta.trendRatePert.totalTrend.maxPercent)
                            })
                            updateChartOverview(track2, getJsonChurnSeries(dta.trendRatePert.totalTrend, 1))
                        }
                        else{
                            alert("Error when execute query. Please check again your system!")
                        }
                    },
                    complete: function () {
                        $('.divLeft').waitMe("hide");
                    }
                });
            }

            // click tab and get json data
            function getChurnByTab(tab_name) {
                var fields = getParamFields(document.querySelector('input[name=csrfToken]').value)
                $.ajax({
                    url: "/overview/getJsonByTab",
                    cache: false,
                    data:  fields,
                    type:"POST",
                    beforeSend: function () {
                        $('#'+tab_name).waitMe({
                            effect: 'facebook',
                            text: '',
                            bg: 'rgba(255,255,255,0.7)',
                            color: '#2A3F54',
                            textPos: 'vertical'
                        });
                    },
                    success: function (dta) {
                        if(dta != "Error"){
                            $('.monthGrp').attr('style','background-color: #16a085!important;color: #fff')
                            // comment Chart
                            $('.comment').text(dta.cmtChart)
                            if(tab_name == "tabAge"){
                                // bubble charts Age & Location
                                if(dta.churnAgeLocation.data.length <= 0){
                                    $('#bubleLocation_overlay').hide()
                                    $('#bubleLocation').hide()
                                }
                                else{
                                    $('#bubleLocation_overlay').show()
                                    $('#bubleLocation').show()
                                }
                                $('#churn3_txtMin').text(dta.churnAgeLocation.minPercent)
                                $('#churn3_txtMax').text(dta.churnAgeLocation.maxPercent)
                                $('#churn3_circle2').text(Number(dta.churnAgeLocation.minPercent + (dta.churnAgeLocation.maxPercent-dta.churnAgeLocation.minPercent)/5*2).toFixed(2))
                                $('#churn3_circle3').text(Number(dta.churnAgeLocation.minPercent + (dta.churnAgeLocation.maxPercent-dta.churnAgeLocation.minPercent)/5*3).toFixed(2))
                                var chartRegionAge = new google.visualization.BubbleChart(document.getElementById('bubleLocation'))
                                Object.keys(dta.churnAgeLocation.catesRegion).length >8 ? $('#bubleLocation').attr('style','height: 550px'): $('#bubleLocation').attr('style','height: 450px')
                                google.visualization.events.addListener(chartRegionAge, 'ready', function () {
                                    Array.prototype.forEach.call(document.getElementById('bubleLocation').getElementsByTagName('text'), function(text) {
                                        if ((text.getAttribute('text-anchor') === 'end') && (text.getAttribute('fill') === '#444444')) {
                                            if(text.innerHTML == 0 || text.innerHTML == undefined || text.innerHTML == Object.keys(dta.churnAgeLocation.catesRegion).length+1)
                                                text.setAttribute('fill-opacity',0)
                                            else{
                                                text.innerHTML = keyByValue(dta.churnAgeLocation.catesRegion, Number(text.innerHTML))
                                            }
                                        }
                                        // change label month
                                        if ((text.getAttribute('text-anchor') === 'middle') && (text.getAttribute('fill') === '#444444')) {
                                            if(Object.keys(dta.churnAgeLocation.catesMonth).length == 1){
                                                if (text.innerHTML == 0.5 || text.innerHTML == 0.0 || text.innerHTML == 1.5)
                                                    text.setAttribute('fill-opacity', 0)
                                                else {
                                                    if(text.innerHTML == 1.0){
                                                        text.innerHTML = keyByValue(dta.churnAgeLocation.catesMonth, 1)
                                                    }
                                                }
                                            }
                                            else{
                                                if(text.innerHTML == 0 || text.innerHTML >= Object.keys(dta.churnAgeLocation.catesMonth).length+1)
                                                    text.setAttribute('fill-opacity',0)
                                                else{
                                                    text.innerHTML = keyByValue(dta.churnAgeLocation.catesMonth, Number(text.innerHTML))
                                                }
                                            }
                                        }
                                    });
                                    // remove circle value =0
                                    Array.prototype.forEach.call(document.getElementById('bubleLocation').getElementsByTagName('circle'), function(circle) {
                                        if(circle.getAttribute('r') == 5 && Number(dta.churnAgeLocation.isNull) == 1)
                                            circle.setAttribute('r', 1)
                                    })
                                })
                                var dataRegionAge = google.visualization.arrayToDataTable(getDataChurn(dta.churnAgeLocation.data,  "Location", "Age"))
                                if(Object.keys(dta.churnAgeLocation.catesMonth).length == 1)
                                    options.hAxis.gridlines.count = 4
                                else
                                    options.hAxis.gridlines.count = Object.keys(dta.churnAgeLocation.catesMonth).length+2
                                options.vAxis.gridlines.count = Object.keys(dta.churnAgeLocation.catesRegion).length+2
                                //options.chartArea.left =170;
                                chartRegionAge.draw(dataRegionAge, options)
                                google.visualization.events.addListener(chartRegionAge, 'onmouseover', function (event) {
                                    var rate = dataRegionAge.getValue(event.row, 3);
                                    var xAxis = dataRegionAge.getValue(event.row, 1);
                                    var yAxis = dataRegionAge.getValue(event.row, 2);
                                    var percent = dataRegionAge.getValue(event.row, 4);
                                    var contracts = dataRegionAge.getValue(event.row, 5);
                                    var x = 255;
                                    if($(window).width() < 992){
                                        mouseY = mouseY - 970
                                    }
                                    else{
                                        mouseY = mouseY -740
                                    }
                                    var y = mouseY
                                    if(!(Number(percent == 0) && Number(rate) == 0)){
                                        $('#bubleLocation_tooltip').html('<div><p><b>Age:</b> ' + keyByValue(dta.churnAgeLocation.catesMonth, xAxis) +'</p><p><b>Location:</b> '+ keyByValue( dta.churnAgeLocation.catesRegion, yAxis) +
                                                '</p><p><b>Rate:</b> '+ rate +' %</p><p><b>Percent:</b> '+ percent +' %</p><p><b>Number of contracts: </b>'+contracts+'</p></div>').css({
                                            'top': y,
                                            'left': x
                                        }).fadeIn('slow');
                                    }
                                    // remove circle value =0
                                    Array.prototype.forEach.call(document.getElementById('bubleLocation').getElementsByTagName('circle'), function(circle) {
                                        if(Number(dta.churnAgeLocation.isNull) == 1 && (circle.getAttribute('fill') == 'none' || circle.getAttribute('r') == 5)){
                                            circle.setAttribute('r', 1)
                                        }
                                    })
                                })
                                google.visualization.events.addListener(chartRegionAge, 'onmouseout', handlerOut)

                                // bubble charts Age & Month
                                if(dta.churnAgeMonth.data.length <= 0){
                                    $('#bubleAge_overlay').hide()
                                    $('#bubleAge').hide()
                                }
                                else{
                                    $('#bubleAge_overlay').show()
                                    $('#bubleAge').show()
                                }
                                $('#churn2_txtMin').text(dta.churnAgeMonth.minPercent)
                                $('#churn2_txtMax').text(dta.churnAgeMonth.maxPercent)
                                $('#churn2_circle2').text(Number(dta.churnAgeMonth.minPercent + (dta.churnAgeMonth.maxPercent-dta.churnAgeMonth.minPercent)/5*2).toFixed(2))
                                $('#churn2_circle3').text(Number(dta.churnAgeMonth.minPercent + (dta.churnAgeMonth.maxPercent-dta.churnAgeMonth.minPercent)/5*3).toFixed(2))
                                var chartRegionMonth = new google.visualization.BubbleChart(document.getElementById('bubleAge'))
                                google.visualization.events.addListener(chartRegionMonth, 'ready', function () {
                                    Array.prototype.forEach.call(document.getElementById('bubleAge').getElementsByTagName('text'), function(text) {
                                        if ((text.getAttribute('text-anchor') === 'end') && (text.getAttribute('fill') === '#444444')) {
                                            if(text.innerHTML == 0 || text.innerHTML == undefined || text.innerHTML == Object.keys(dta.churnAgeMonth.catesRegion).length+1)
                                                text.setAttribute('fill-opacity',0)
                                            else{
                                                text.innerHTML = keyByValue(dta.churnAgeMonth.catesRegion, Number(text.innerHTML))
                                            }
                                        }
                                        // change label month
                                        if ((text.getAttribute('text-anchor') === 'end') && (text.getAttribute('fill') === '#1c2752')) {
                                            if(Object.keys(dta.churnAgeMonth.catesMonth).length == 1){
                                                if (text.innerHTML == 0.5 || text.innerHTML == 0.0 || text.innerHTML == 1.5)
                                                    text.setAttribute('fill-opacity', 0)
                                                else {
                                                    if(text.innerHTML == 1.0){
                                                        text.innerHTML = keyByValue(dta.churnAgeMonth.catesMonth, 1)
                                                    }
                                                }
                                            }
                                            else{
                                                if(text.innerHTML == 0 || text.innerHTML >= Object.keys(dta.churnAgeMonth.catesMonth).length+1)
                                                    text.setAttribute('fill-opacity',0)
                                                else{
                                                    text.innerHTML = keyByValue(dta.churnAgeMonth.catesMonth, Number(text.innerHTML))
                                                }
                                            }
                                        }
                                    });
                                    // remove circle value =0
                                    Array.prototype.forEach.call(document.getElementById('bubleAge').getElementsByTagName('circle'), function(circle) {
                                        if(circle.getAttribute('r') == 5 && Number(dta.churnAgeMonth.isNull) == 1)
                                            circle.setAttribute('r', 1)
                                    })
                                })
                                var dataRegionMonth = google.visualization.arrayToDataTable(getDataChurn(dta.churnAgeMonth.data,  "Month", "Age"))
                                if(Object.keys(dta.churnAgeMonth.catesMonth).length == 1)
                                    optionsRegion.hAxis.gridlines.count = 4
                                else
                                    optionsRegion.hAxis.gridlines.count = Object.keys(dta.churnAgeMonth.catesMonth).length+2
                                optionsRegion.vAxis.gridlines.count = Object.keys(dta.churnAgeMonth.catesRegion).length+2
                                optionsRegion.chartArea.left =170;
                                chartRegionMonth.draw(dataRegionMonth, optionsRegion)
                                google.visualization.events.addListener(chartRegionMonth, 'onmouseover', function (event) {
                                    var rate = dataRegionMonth.getValue(event.row, 3);
                                    var xAxis = dataRegionMonth.getValue(event.row, 1);
                                    var yAxis = dataRegionMonth.getValue(event.row, 2);
                                    var percent = dataRegionMonth.getValue(event.row, 4);
                                    var contracts = dataRegionMonth.getValue(event.row, 5);
                                    var x = mouseX - 225;
                                    if($(window).width() < 992){
                                        mouseY = mouseY - 870
                                    }
                                    else{
                                        mouseY = mouseY -200
                                    }
                                    var y = mouseY
                                    if(!(Number(percent == 0) && Number(rate) == 0)){
                                        $('#bubleAge_tooltip').html('<div><p><b>Month:</b> ' + keyByValue(dta.churnAgeMonth.catesMonth, xAxis) +'</p><p><b>Age:</b> '+ keyByValue( dta.churnAgeMonth.catesRegion, yAxis) +
                                                '</p><p><b>Rate:</b> '+ rate +' %</p><p><b>Percent:</b> '+ percent +' %</p><p><b>Number of contracts: </b>'+contracts+'</p></div>').css({
                                            'top': y,
                                            'left': x
                                        }).fadeIn('slow');
                                    }
                                    // remove circle value =0
                                    Array.prototype.forEach.call(document.getElementById('bubleAge').getElementsByTagName('circle'), function(circle) {
                                        if(Number(dta.churnAgeMonth.isNull) == 1 && (circle.getAttribute('fill') == 'none' || circle.getAttribute('r') == 5)){
                                            circle.setAttribute('r', 1)
                                        }
                                    })
                                })
                                google.visualization.events.addListener(chartRegionMonth, 'onmouseout', handlerOut)

                                // sparkline table
                                var tBodyAge = parseTbChurnRate(dta.tbAge, dta.tbAge.arrMonth, 2)
                                $('#tbChurn2').html("").append(tBodyAge)
                                $('.sparkline2').sparkline('html',{
                                    type: 'line',
                                    width: '320px',
                                    height: '15px',
                                    lineColor: '#16a085',
                                    fillColor: '#ffffff',
                                    lineWidth: 1,
                                    spotColor: '#e21212',
                                    minSpotColor: '#132186',
                                    maxSpotColor: '#132186',
                                    highlightLineColor: '#ffffff',
                                    valueSpots:{'0:':'#e21212'},
                                    tooltipFormat: '{{offset:names}}: <b>{{y:value}}</b>',
                                    tooltipValueLookups: {
                                        names: dta.tbAge.arrMonth
                                    }
                                });
                            }
                            else if(tab_name == "tabPackage"){
                                // bubble charts Package & Location
                                if(dta.churnPkgLocation.data.length <= 0){
                                    $('#bublePkgLoc_overlay').hide()
                                    $('#bublePkgLoc').hide()
                                }
                                else{
                                    $('#bublePkgLoc_overlay').show()
                                    $('#bublePkgLoc').show()
                                }
                                $('#churn5_txtMin').text(dta.churnPkgLocation.minPercent)
                                $('#churn5_txtMax').text(dta.churnPkgLocation.maxPercent)
                                $('#churn5_circle2').text(Number(dta.churnPkgLocation.minPercent + (dta.churnPkgLocation.maxPercent-dta.churnPkgLocation.minPercent)/5*2).toFixed(2))
                                $('#churn5_circle3').text(Number(dta.churnPkgLocation.minPercent + (dta.churnPkgLocation.maxPercent-dta.churnPkgLocation.minPercent)/5*3).toFixed(2))
                                var chartRegionPkg = new google.visualization.BubbleChart(document.getElementById('bublePkgLoc'))
                                Object.keys(dta.churnPkgLocation.catesRegion).length >8 ? $('#bublePkgLoc').attr('style','height: 550px'): $('#bublePkgLoc').attr('style','height: 450px')
                                google.visualization.events.addListener(chartRegionPkg, 'ready', function () {
                                    Array.prototype.forEach.call(document.getElementById('bublePkgLoc').getElementsByTagName('text'), function(text) {
                                        if ((text.getAttribute('text-anchor') === 'end') && (text.getAttribute('fill') === '#444444')) {
                                            if(text.innerHTML == 0 || text.innerHTML == undefined || text.innerHTML == Object.keys(dta.churnPkgLocation.catesRegion).length+1)
                                                text.setAttribute('fill-opacity',0)
                                            else{
                                                text.innerHTML = keyByValue(dta.churnPkgLocation.catesRegion, Number(text.innerHTML))
                                            }
                                        }
                                        // change label month
                                        if ((text.getAttribute('text-anchor') === 'end') && (text.getAttribute('fill') === '#1c2752')) {
                                            if(Object.keys(dta.churnPkgLocation.catesMonth).length == 1){
                                                if (text.innerHTML == 0.5 || text.innerHTML == 0.0 || text.innerHTML == 1.5)
                                                    text.setAttribute('fill-opacity', 0)
                                                else {
                                                    if(text.innerHTML == 1.0){
                                                        text.innerHTML = keyByValue(dta.churnPkgLocation.catesMonth, 1)
                                                    }
                                                }
                                            }
                                            else{
                                                if(text.innerHTML == 0 || text.innerHTML >= Object.keys(dta.churnPkgLocation.catesMonth).length+1)
                                                    text.setAttribute('fill-opacity',0)
                                                else{
                                                    text.innerHTML = keyByValue(dta.churnPkgLocation.catesMonth, Number(text.innerHTML))
                                                }
                                            }
                                        }
                                    });
                                    // remove circle value =0
                                    Array.prototype.forEach.call(document.getElementById('bublePkgLoc').getElementsByTagName('circle'), function(circle) {
                                        if(circle.getAttribute('r') == 5 && Number(dta.churnPkgLocation.isNull) == 1)
                                            circle.setAttribute('r', 1)
                                    })
                                })
                                var dataRegionPkg = google.visualization.arrayToDataTable(getDataChurn(dta.churnPkgLocation.data,  "Location", "Package"))
                                if(Object.keys(dta.churnPkgLocation.catesMonth).length == 1)
                                    optionsPackage.hAxis.gridlines.count = 4
                                else
                                    optionsPackage.hAxis.gridlines.count = Object.keys(dta.churnPkgLocation.catesMonth).length+2
                                optionsPackage.vAxis.gridlines.count = Object.keys(dta.churnPkgLocation.catesRegion).length+2
                                optionsPackage.colorAxis.colors = ['#F5F6CE', 'green']
                                chartRegionPkg.draw(dataRegionPkg, optionsPackage)
                                google.visualization.events.addListener(chartRegionPkg, 'onmouseover', function (event) {
                                    var rate = dataRegionPkg.getValue(event.row, 3);
                                    var xAxis = dataRegionPkg.getValue(event.row, 1);
                                    var yAxis = dataRegionPkg.getValue(event.row, 2);
                                    var percent = dataRegionPkg.getValue(event.row, 4);
                                    var contracts = dataRegionPkg.getValue(event.row, 5);
                                    var x = 155;
                                    if($(window).width() < 992){
                                        mouseY = mouseY - 670
                                    }
                                    else{
                                        mouseY = mouseY -240
                                    }
                                    var y = mouseY
                                    if(!(Number(percent == 0) && Number(rate) == 0)){
                                        $('#bublePkgLoc_tooltip').html('<div><p><b>Package:</b> ' + keyByValue(dta.churnPkgLocation.catesMonth, xAxis) +'</p><p><b>Location:</b> '+ keyByValue( dta.churnPkgLocation.catesRegion, yAxis) +
                                                '</p><p><b>Rate:</b> '+ rate +' %</p><p><b>Percent:</b> '+ percent +' %</p><p><b>Number of contracts: </b>'+contracts+'</p></div>').css({
                                            'top': y,
                                            'left': x
                                        }).fadeIn('slow');
                                    }
                                    // remove circle value =0
                                    Array.prototype.forEach.call(document.getElementById('bublePkgLoc').getElementsByTagName('circle'), function(circle) {
                                        if(Number(dta.churnPkgLocation.isNull) == 1 && (circle.getAttribute('fill') == 'none' || circle.getAttribute('r') == 5)){
                                            circle.setAttribute('r', 1)
                                        }
                                    })
                                })
                                google.visualization.events.addListener(chartRegionPkg, 'onmouseout', handlerOut)

                                // bubble charts Package & Age
                                if(dta.churnPkgAge.data.length <= 0){
                                    $('#bublePkgAge_overlay').hide()
                                    $('#bublePkgAge').hide()
                                }
                                else{
                                    $('#bublePkgAge_overlay').show()
                                    $('#bublePkgAge').show()
                                }
                                $('#churn6_txtMin').text(dta.churnPkgAge.minPercent)
                                $('#churn6_txtMax').text(dta.churnPkgAge.maxPercent)
                                $('#churn6_circle2').text(Number(dta.churnPkgAge.minPercent + (dta.churnPkgAge.maxPercent-dta.churnPkgAge.minPercent)/5*2).toFixed(2))
                                $('#churn6_circle3').text(Number(dta.churnPkgAge.minPercent + (dta.churnPkgAge.maxPercent-dta.churnPkgAge.minPercent)/5*3).toFixed(2))
                                var chartAgePkg = new google.visualization.BubbleChart(document.getElementById('bublePkgAge'))
                                Object.keys(dta.churnPkgAge.catesRegion).length >8 ? $('#bublePkgAge').attr('style','height: 550px'): $('#bublePkgAge').attr('style','height: 450px')
                                google.visualization.events.addListener(chartAgePkg, 'ready', function () {
                                    Array.prototype.forEach.call(document.getElementById('bublePkgAge').getElementsByTagName('text'), function(text) {
                                        if ((text.getAttribute('text-anchor') === 'end') && (text.getAttribute('fill') === '#444444')) {
                                            if(text.innerHTML == 0 || text.innerHTML == undefined || text.innerHTML == Object.keys(dta.churnPkgAge.catesRegion).length+1)
                                                text.setAttribute('fill-opacity',0)
                                            else{
                                                text.innerHTML = keyByValue(dta.churnPkgAge.catesRegion, Number(text.innerHTML))
                                            }
                                        }
                                        // change label age
                                        if ((text.getAttribute('text-anchor') === 'end') && (text.getAttribute('fill') === '#1c2752')) {
                                            if(Object.keys(dta.churnPkgAge.catesMonth).length == 1){
                                                if (text.innerHTML == 0.5 || text.innerHTML == 0.0 || text.innerHTML == 1.5)
                                                    text.setAttribute('fill-opacity', 0)
                                                else {
                                                    if(text.innerHTML == 1.0){
                                                        text.innerHTML = keyByValue(dta.churnPkgAge.catesMonth, 1)
                                                    }
                                                }
                                            }
                                            else{
                                                if(text.innerHTML == 0 || text.innerHTML >= Object.keys(dta.churnPkgAge.catesMonth).length+1)
                                                    text.setAttribute('fill-opacity',0)
                                                else{
                                                    text.innerHTML = keyByValue(dta.churnPkgAge.catesMonth, Number(text.innerHTML))
                                                }
                                            }
                                        }
                                    });
                                    // remove circle value =0
                                    Array.prototype.forEach.call(document.getElementById('bublePkgAge').getElementsByTagName('circle'), function(circle) {
                                        if(circle.getAttribute('r') == 5 && Number(dta.churnPkgAge.isNull) == 1)
                                            circle.setAttribute('r', 1)
                                    })
                                })
                                var dataAgePkg = google.visualization.arrayToDataTable(getDataChurn(dta.churnPkgAge.data,  "Age", "Package"))
                                if(Object.keys(dta.churnPkgAge.catesMonth).length == 1)
                                    optionsPackage.hAxis.gridlines.count = 4
                                else
                                    optionsPackage.hAxis.gridlines.count = Object.keys(dta.churnPkgAge.catesMonth).length+2
                                optionsPackage.vAxis.gridlines.count = Object.keys(dta.churnPkgAge.catesRegion).length+2
                                optionsPackage.colorAxis.colors = ['#fdd0a2', '#d94801']
                                chartAgePkg.draw(dataAgePkg, optionsPackage)
                                google.visualization.events.addListener(chartAgePkg, 'onmouseover', function (event) {
                                    var rate = dataAgePkg.getValue(event.row, 3);
                                    var xAxis = dataAgePkg.getValue(event.row, 1);
                                    var yAxis = dataAgePkg.getValue(event.row, 2);
                                    var percent = dataAgePkg.getValue(event.row, 4);
                                    var contracts = dataAgePkg.getValue(event.row, 5);
                                    var x = 155;
                                    if($(window).width() < 992){
                                        mouseY = mouseY - 670
                                    }
                                    else{
                                        mouseY = mouseY -240
                                    }
                                    var y = mouseY
                                    if(!(Number(percent == 0) && Number(rate) == 0)){
                                        $('#bublePkgAge_tooltip').html('<div><p><b>Package:</b> ' + keyByValue(dta.churnPkgLocation.catesMonth, xAxis) +'</p><p><b>Age:</b> '+ keyByValue( dta.churnPkgAge.catesRegion, yAxis) +
                                                '</p><p><b>Rate:</b> '+ rate +' %</p><p><b>Percent:</b> '+ percent +' %</p><p><b>Number of contracts: </b>'+contracts+'</p></div>').css({
                                            'top': y,
                                            'left': x
                                        }).fadeIn('slow');
                                    }
                                    // remove circle value =0
                                    Array.prototype.forEach.call(document.getElementById('bublePkgAge').getElementsByTagName('circle'), function(circle) {
                                        if(Number(dta.churnPkgAge.isNull) == 1 && (circle.getAttribute('fill') == 'none' || circle.getAttribute('r') == 5)){
                                            circle.setAttribute('r', 1)
                                        }
                                    })
                                })
                                google.visualization.events.addListener(chartAgePkg, 'onmouseout', handlerOut)

                                // bubble charts Package & Month
                                if(dta.churnPkgMonth.data.length <= 0){
                                    $('#bublePkg_overlay').hide()
                                    $('#bublePkg').hide()
                                }
                                else{
                                    $('#bublePkg_overlay').show()
                                    $('#bublePkg').show()
                                }
                                $('#churn4_txtMin').text(dta.churnPkgMonth.minPercent)
                                $('#churn4_txtMax').text(dta.churnPkgMonth.maxPercent)
                                $('#churn4_circle2').text(Number(dta.churnPkgMonth.minPercent + (dta.churnPkgMonth.maxPercent-dta.churnPkgMonth.minPercent)/5*2).toFixed(2))
                                $('#churn4_circle3').text(Number(dta.churnPkgMonth.minPercent + (dta.churnPkgMonth.maxPercent-dta.churnPkgMonth.minPercent)/5*3).toFixed(2))
                                var chartRegionMonth = new google.visualization.BubbleChart(document.getElementById('bublePkg'))
                                google.visualization.events.addListener(chartRegionMonth, 'ready', function () {
                                    Array.prototype.forEach.call(document.getElementById('bublePkg').getElementsByTagName('text'), function(text) {
                                        if ((text.getAttribute('text-anchor') === 'end') && (text.getAttribute('fill') === '#444444')) {
                                            if(text.innerHTML == 0 || text.innerHTML == undefined || text.innerHTML == Object.keys(dta.churnPkgMonth.catesRegion).length+1)
                                                text.setAttribute('fill-opacity',0)
                                            else{
                                                text.innerHTML = keyByValue(dta.churnPkgMonth.catesRegion, Number(text.innerHTML))
                                            }
                                        }
                                        // change label month
                                        if ((text.getAttribute('text-anchor') === 'end') && (text.getAttribute('fill') === '#1c2752')) {
                                            if(Object.keys(dta.churnPkgMonth.catesMonth).length == 1){
                                                if (text.innerHTML == 0.5 || text.innerHTML == 0.0 || text.innerHTML == 1.5)
                                                    text.setAttribute('fill-opacity', 0)
                                                else {
                                                    if(text.innerHTML == 1.0){
                                                        text.innerHTML = keyByValue(dta.churnPkgMonth.catesMonth, 1)
                                                    }
                                                }
                                            }
                                            else{
                                                if(text.innerHTML == 0 || text.innerHTML >= Object.keys(dta.churnPkgMonth.catesMonth).length+1)
                                                    text.setAttribute('fill-opacity',0)
                                                else{
                                                    text.innerHTML = keyByValue(dta.churnPkgMonth.catesMonth, Number(text.innerHTML))
                                                }
                                            }
                                        }
                                    });
                                    // remove circle value =0
                                    Array.prototype.forEach.call(document.getElementById('bublePkg').getElementsByTagName('circle'), function(circle) {
                                        if(circle.getAttribute('r') == 5 && Number(dta.churnPkgMonth.isNull) == 1)
                                            circle.setAttribute('r', 1)
                                    })
                                })
                                var dataRegionMonth = google.visualization.arrayToDataTable(getDataChurn(dta.churnPkgMonth.data,  "Month", "Pkg"))
                                if(Object.keys(dta.churnPkgMonth.catesMonth).length == 1)
                                    optionsRegion.hAxis.gridlines.count = 4
                                else
                                    optionsRegion.hAxis.gridlines.count = Object.keys(dta.churnPkgMonth.catesMonth).length+2
                                optionsRegion.vAxis.gridlines.count = Object.keys(dta.churnPkgMonth.catesRegion).length+2
                                optionsRegion.chartArea.left =180;
                                chartRegionMonth.draw(dataRegionMonth, optionsRegion)
                                google.visualization.events.addListener(chartRegionMonth, 'onmouseover', function (event) {
                                    var rate = dataRegionMonth.getValue(event.row, 3);
                                    var xAxis = dataRegionMonth.getValue(event.row, 1);
                                    var yAxis = dataRegionMonth.getValue(event.row, 2);
                                    var percent = dataRegionMonth.getValue(event.row, 4);
                                    var contracts = dataRegionMonth.getValue(event.row, 5);
                                    var x = mouseX - 225;
                                    if($(window).width() < 992){
                                        mouseY = mouseY - 870
                                    }
                                    else{
                                        mouseY = mouseY -830
                                    }
                                    var y = mouseY
                                    if(!(Number(percent == 0) && Number(rate) == 0)){
                                        $('#bublePkg_tooltip').html('<div><p><b>Month:</b> ' + keyByValue(dta.churnPkgMonth.catesMonth, xAxis) +'</p><p><b>Package:</b> '+ keyByValue( dta.churnPkgMonth.catesRegion, yAxis) +
                                                '</p><p><b>Rate:</b> '+ rate +' %</p><p><b>Percent:</b> '+ percent +' %</p><p><b>Number of contracts: </b>'+contracts+'</p></div>').css({
                                            'top': y,
                                            'left': x
                                        }).fadeIn('slow');
                                    }
                                    // remove circle value =0
                                    Array.prototype.forEach.call(document.getElementById('bublePkg').getElementsByTagName('circle'), function(circle) {
                                        if(Number(dta.churnPkgMonth.isNull) == 1 && (circle.getAttribute('fill') == 'none' || circle.getAttribute('r') == 5)){
                                            circle.setAttribute('r', 1)
                                        }
                                    })
                                })
                                google.visualization.events.addListener(chartRegionMonth, 'onmouseout', handlerOut)

                                // Rotate vAxis labels.
                                var array = $('#bublePkg g');
                                for(var i = 0; i < array.length; i++) {
                                    var logicalname = array[i].logicalname;
                                    var text = $(array[i].children[0]);
                                    if(logicalname != null &&
                                            logicalname.indexOf("vAxis") == 0 &&
                                            logicalname.indexOf("label") > 0) {

                                        text.attr("transform",
                                                "rotate(-30 "+$(text[0]).attr('x')+" "+$(text[0]).attr('y')+")");

                                    }
                                }

                                // sparkline table
                                var tBodyPkg = parseTbChurnRate(dta.tbPkg, dta.tbPkg.arrMonth, 3)
                                $('#tbChurn3').html("").append(tBodyPkg)
                                $('.sparkline3').sparkline('html',{
                                    type: 'line',
                                    width: '320px',
                                    height: '15px',
                                    lineColor: '#16a085',
                                    fillColor: '#ffffff',
                                    lineWidth: 1,
                                    spotColor: '#e21212',
                                    minSpotColor: '#132186',
                                    maxSpotColor: '#132186',
                                    highlightLineColor: '#ffffff',
                                    valueSpots:{'0:':'#e21212'},
                                    tooltipFormat: '{{offset:names}}: <b>{{y:value}}</b>',
                                    tooltipValueLookups: {
                                        names: dta.tbPkg.arrMonth
                                    }
                                });
                            }
                            else{
                                // table Trend
                                $('.idQuarter').text(dta.arrTbTrend.quarter)
                                var tbTrend = $('#tbTrend').DataTable( {
                                    "lengthChange": false,
                                    "info":     false,
                                    "sort":     false,
                                    responsive: true,
                                    destroy: true,
                                    "scrollX": true
                                });
                                tbTrend.rows().remove().draw();
                                for(var i=0;i< dta.arrTbTrend.data.length;i++){
                                    tbTrend.row.add([dta.arrTbTrend.data[i][0], dta.arrTbTrend.data[i][1], dta.arrTbTrend.data[i][2], dta.arrTbTrend.data[i][3], 0, 0,
                                        dta.arrTbTrend.data[i][4], 0, 0, dta.arrTbTrend.data[i][5], 0, 0, dta.arrTbTrend.data[i][6], 0, 0]).draw( false );
                                }
                                $('#tfooter').html('').append('<td>Tổng</td><td>'+dta.arrTbTrend.total[0][0]+'</td><td>'+dta.arrTbTrend.total[0][1]+'</td>'+
                                        '<td>'+dta.arrTbTrend.total[0][2]+'</td><td>0</td><td>0</td><td>'+dta.arrTbTrend.total[0][3]+'</td><td>0</td><td>0</td><td>'+
                                        dta.arrTbTrend.total[0][4]+'</td><td>0</td><td>0</td><td>'+dta.arrTbTrend.total[0][5]+'</td><td>0</td><td>0</td>')
                                // update chart daily
                                dailyTrend.xAxis[0].update({categories: dta.chartDaily.cateX})
                                updateCharts(dailyTrend, getJsonDaily(dta.chartDaily.realDaily, dta.chartDaily.rangeDaily, dta.chartDaily.planDaily))
                            }
                        }
                        else{
                            alert("Error when execute query. Please check again your system!")
                        }
                    },
                    complete: function () {
                        $('#'+tab_name).waitMe("hide");
                    }
                });
            }

            function filterCallAjax(){
                if($('#tabName').val() == "tabOverview"){
                    getAjaxChurn()
                }
                else{
                    getChurnByTab($('#tabName').val())
                }
            }

            // click apply fitler
            $('.apply').click(function () {
                filterCallAjax()
            });
            // click refresh fitler
            $('.btnRefresh').click(function () {
                $('.slAge').val('').trigger('change')
                $('.slPackage').val('').trigger('change')
                $('.radio').removeAttr('checked').iCheck('update')
                $('.checkbox').removeAttr('checked').iCheck('update')
                $(".monthPicker").datepicker("update", $('#monthCurr').val())
                $(".region").jstree("deselect_all")
                $('#combo').val("")
                filterCallAjax()
            })
            $('.radio').on('ifChecked', function(){
                $('#combo').val($(this).val())
            });
            // click comment insert
            $('.btnCmt').click(function () {
                var fields = {
                    "csrfToken": document.querySelector('input[name=csrfToken]').value,
                    "comment"  : $(this).parent().parent().find('.comment').val(),
                    "tabName"  : "Overview_"+$('#tabName').val()
                }
                insertComment(fields)
            });
        }

    function getJsonChurnSeries(data, _type){
        // _type: 0 -> 2 series
        // _type : 1 -> combo chart col and line
        var rs = []
        if(_type == 0){
            if($('#status').val() == "1"){
                rs.push({
                            name: data.titSeries1,
                            data: data.huydv
                        })
            }
            else if($('#status').val() == "3"){
                rs.push(
                        {
                            name: data.titSeries2,
                            data: data.ctbdv
                        })
            }
            else{
                rs.push({
                            name: data.titSeries1,
                            data: data.huydv
                        },
                        {
                            name: data.titSeries2,
                            data: data.ctbdv
                        })
            }
        }
        else{
            rs.push({
                    name: "Churn Rate(%)",
                    type: 'column',
                    yAxis: 0,
                    data: data.rate
                },
                {
                    name: "Churn Percent(%)",
                    type: 'column',
                    yAxis: 1,
                    data: data.perct
                },
                {
                    name: "F1",
                    type: 'spline',
                    yAxis: 0,
                    data: data.f1
                })
        }

        return rs
    }

    function updateChartOverview(charts, data){
        var seriesLength = charts.series.length;
        for(var i = seriesLength -1; i > -1; i--) {
            charts.series[i].remove();
        }
        for(var i=0; i< data.length; i++) {
            charts.addSeries(data[i]);
        }
    }

    function getParamFields(token){
        var boxes = $('.statusDiv .checkbox:checked');
        var status = ""
        boxes.each(function(i, chkbox) {
            status += chkbox.value
        });
        $('#status').val(status)
        var obj = {
            "csrfToken" : token,
            "province"  : $('#province').val() == "All" ? "": $('#province').val(),
            "combo"  : $('#combo').val(),
            "age"    : $('.ageDiv .select2-selection__choice').text().substring(1,$('.ageDiv .select2-selection__choice').text().length).split('x').join(','),
            "package": $('.packageDiv .select2-selection__choice').text().substring(1,$('.packageDiv .select2-selection__choice').text().length).split('x').join(','),
            "month"  : $('.monthGrp').val(),
            "status" : status,
            "tabName" : $('#tabName').val(),
            "dataPoint" : $('#point').val()
        }
        //console.log(obj)
        return obj
    }
</script>