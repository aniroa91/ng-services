@(rs: churn.models.OverviewResponse)
@import play.api.libs.json.Json
@import services.domain.CommonService

<script type="text/javascript">
    $(document).ready(function () {
        $(".slAge").select2({
            placeholder: "Choose age group ..."
        });
        $(".slPackage").select2({
            placeholder: "Choose package ..."
        });
        $('.radio').iCheck({
            radioClass: 'iradio_square-purple'
        });
        $('.monthPicker').datepicker({
            autoclose: true,
            minViewMode: 1,
            endDate: '-1m',
            format: 'yyyy-mm'
        }).on('changeDate', function (selected) {
            var startDate = new Date(selected.date.valueOf());
            var yr = startDate.getFullYear();
            var month = startDate.getMonth() < 9 ? ('0' + Number(startDate.getMonth() + 1)) : (Number(startDate.getMonth() + 1));
            var newDate = yr + '-' + month;
            $('#month').val(newDate)
            // change highlight filters
            $('.monthGrp').removeAttr('style')
        });
        // jsTree Region and province
        $('.region').jstree({
            "plugins" : ["checkbox"],
            'checkbox': {
                three_state: true
            },
            'core' : {
                expand_selected_onload : false,
                "themes":{
                    "icons":false
                },
                'data' : getJsonTreeListRegion(@Html(Json.stringify(Json.toJson(rs.province))),@Html(Json.stringify(Json.toJson( rs.province.map(x => x._1).distinct.sorted ))))
            }
        }).on('changed.jstree', function (e, data) {
            var i, j, nodes = [], regions = [], provinces= [];
            for(i = 0, j = data.selected.length; i < j; i++) {
                nodes.push(data.instance.get_node(data.selected[i]).id);
            }
            var regionArr = nodes.join(', ').split(',')
            for(var i=0;i< regionArr.length;i++){
                if(isNaN(regionArr[i])){
                    provinces.push(regionArr[i])
                }
                else{
                    regions.push(regionArr[i])
                }
            }
            $('#region').val(regions)
            $('#province').val(provinces)
        })

        var track1 = Highcharts.chart('track1', {
            chart: {
                type: 'column'
            },
            title: {
                text: ''
            },
            xAxis: {
                categories: @Html(Json.stringify(Json.toJson(rs.numofMonth.map(x=> x._1).distinct.sorted)))
            },
            yAxis: {
                title: {
                    text: ''
                }
            },
            colors : ['#fe7096','#3498DB'],
            tooltip: {
                shared: true
            },
            series: [{
                name: 'HSSD',
                data: @Html(Json.stringify(Json.toJson(rs.numofMonth.filter(x=> x._2.toInt == 1).sorted.map(x=> x._3))))
            }, {
                name: 'CTBDV',
                data: @Html(Json.stringify(Json.toJson(rs.numofMonth.filter(x=> x._2.toInt == 3).sorted.map(x=> x._3))))
            }]
        });

        var track2 = Highcharts.chart('track2', {
            chart: {
                zoomType: 'xy'
            },

            title: {
                text: ''
            },

            colors : ['#73879C', 'rgb(126,223,114)', 'rgb(255,122,86)'],

            xAxis: {
                categories: @Html(Json.stringify(Json.toJson(rs.trendRatePert._1.map(x=> x._1).distinct.sorted)))
            },

            yAxis: [{
                labels: {
                    format: '{value} %',
                    style: {
                        color: "rgb(255,122,86)"
                    }
                },
                title: {
                    text: 'Churn Rate & F1',
                    style: {
                        color: "rgb(255,122,86)"
                    }
                }
            }, { // Secondary yAxis
                title: {
                    text: 'Churn Percent',
                    style: {
                        color: "rgb(126,223,114)"
                    }
                },
                labels: {
                    format: '{value}',
                    style: {
                        color: "rgb(126,223,114)"
                    }
                },
                opposite: true
            }],

            tooltip: {
                shared: true
            },

            series: [{
                type: 'column',
                name: 'Churn Rate(%)',
                yAxis: 0,
                data: @Html(Json.stringify(Json.toJson(rs.trendRatePert._1.map(x=> x._2))))
            }, {
                type: 'column',
                name: 'Churn Percent(%)',
                yAxis: 1,
                data: @Html(Json.stringify(Json.toJson(rs.trendRatePert._1.map(x=> x._3))))
            }, {
                type: 'spline',
                name: 'F1',
                yAxis: 0,
                data: @Html(Json.stringify(Json.toJson(rs.trendRatePert._1.map(x=> x._4))))
            }]

        });

        var track3 = Highcharts.chart('track3', {
            chart: {
                zoomType: 'xy'
            },

            title: {
                text: ''
            },

            colors : ['#73879C','rgb(126,223,114)', 'rgb(255,122,86)'],

            xAxis: {
                categories: @Html(Json.stringify(Json.toJson(rs.trendRatePert._2.map(x=> x._1).distinct.sorted)))
            },

            yAxis: [{
                labels: {
                    format: '{value} %',
                    style: {
                        color: "rgb(255,122,86)"
                    }
                },
                title: {
                    text: 'Churn Rate & F1',
                    style: {
                        color: "rgb(255,122,86)"
                    }
                }
            }, { // Secondary yAxis
                title: {
                    text: 'Churn Percent',
                    style: {
                        color: "rgb(126,223,114)"
                    }
                },
                labels: {
                    format: '{value}',
                    style: {
                        color: "rgb(126,223,114)"
                    }
                },
                opposite: true
            }],

            tooltip: {
                shared: true
            },

            series: [{
                type: 'column',
                name: 'Churn Rate(%)',
                yAxis: 0,
                data: @Html(Json.stringify(Json.toJson(rs.trendRatePert._2.map(x=> x._2))))
            }, {
                type: 'column',
                name: 'Churn Percent(%)',
                yAxis: 1,
                data: @Html(Json.stringify(Json.toJson(rs.trendRatePert._2.map(x=> x._3))))
            }, {
                type: 'spline',
                name: 'F1',
                yAxis: 0,
                data: @Html(Json.stringify(Json.toJson(rs.trendRatePert._2.map(x=> x._4))))
            }]

        });

        var track4 = Highcharts.chart('track4', {
            chart: {
                zoomType: 'xy'
            },

            title: {
                text: ''
            },

            colors : ['#73879C','rgb(126,223,114)', 'rgb(255,122,86)'],

            xAxis: {
                categories: @Html(Json.stringify(Json.toJson(rs.trendRatePert._3.map(x=> x._1).distinct.sorted)))
            },

            yAxis: [{
                labels: {
                    format: '{value} %',
                    style: {
                        color: "rgb(255,122,86)"
                    }
                },
                title: {
                    text: 'Churn Rate & F1',
                    style: {
                        color: "rgb(255,122,86)"
                    }
                }
            }, { // Secondary yAxis
                title: {
                    text: 'Churn Percent',
                    style: {
                        color: "rgb(126,223,114)"
                    }
                },
                labels: {
                    format: '{value}',
                    style: {
                        color: "rgb(126,223,114)"
                    }
                },
                opposite: true
            }],

            tooltip: {
                shared: true
            },

            series: [{
                type: 'column',
                name: 'Churn Rate(%)',
                yAxis: 0,
                data: @Html(Json.stringify(Json.toJson(rs.trendRatePert._3.map(x=> x._2))))
            }, {
                type: 'column',
                name: 'Churn Percent(%)',
                yAxis: 1,
                data: @Html(Json.stringify(Json.toJson(rs.trendRatePert._3.map(x=> x._3))))
            }, {
                type: 'spline',
                name: 'F1',
                yAxis: 0,
                data: @Html(Json.stringify(Json.toJson(rs.trendRatePert._3.map(x=> x._4))))
            }]

        });

        // click tooltip title
        var specifiedElement = document.getElementsByClassName('aMore');
        document.addEventListener('click', function(event) {
            var isClickInside = specifiedElement[Number($('#indexChart').val())].contains(event.target)
            if(!isClickInside && String(event.target.className).indexOf('tooltipSL')<0){
                $('.ddMore').hide()
                $('.dots').show()
                $('.more').hide()
                $('.tooltipSL').removeClass('fa-angle-double-up').addClass('fa-angle-double-down')
            }
        });

        // click refresh fitler
        $('.btnRefresh').click(function () {
            $('.slAge').val('').trigger('change')
            $('.slPackage').val('').trigger('change')
            $('.radio').removeAttr('checked').iCheck('update')
            $(".monthPicker").datepicker("update", $('#monthCurr').val())
            $(".region").jstree("check_all")
            getAjaxChurn()
        })

        // click apply fitler
        $('.apply').click(function () {
            getAjaxChurn()
        });
        $('.radio').on('ifChecked', function(){
            $('#combo').val($(this).val())
        });

        function getAjaxChurn() {
            var fields = getParamFields(document.querySelector('input[name=csrfToken]').value)
            $.ajax({
                url: "/internet/overview/getJsonChurn",
                cache: false,
                data:  fields,
                type:"POST",
                beforeSend: function () {
                    $('.divLeft').waitMe({
                        effect: 'progressBar',
                        text: 'Please wait...',
                        bg: 'rgba(255,255,255,0.7)',
                        color: '#000',
                        textPos: 'vertical'
                    });
                },
                success: function (dta) {
                    if(dta != "Error"){
                        /* update box number */
                        // box Active Contract
                        $('#boxCtActive .currCtActive').text(dta.numContract.actives.curr)
                        var prevCtActive = '<h4>'+dta.numContract.actives.prev+' <i class="fa fa-info-circle iconTip" title="Tổng số hợp đồng tháng cùng kỳ năm ngoái"></i></h4>';
                        prevCtActive += (Number(dta.numContract.actives.prev.replace(",","")) > Number(dta.numContract.actives.curr.replace(",","")))? '<span class="down"><i class="fa fa-arrow-down fadeInDown animated" aria-hidden="true"></i> ' : '<span class="up"><i class="fa fa-arrow-up fadeInUp animated" aria-hidden="true"></i> '
                        prevCtActive += dta.numContract.actives.perct+' % </span> from '+dta.lastYYYYmm
                        $('#boxCtActive .prevCtActive').html("").append(prevCtActive)

                        // box HUYDV Contract
                        $('#boxCtHuydv .currCtHuydv').text(dta.numContract.huydv.curr)
                        var prevCthuydv = '<h4>'+dta.numContract.huydv.prev+' <i class="fa fa-info-circle iconTip" title="Tổng số hợp đồng HSSD cùng kỳ năm ngoái"></i></h4>';
                        prevCthuydv += (Number(dta.numContract.huydv.prev.replace(",","")) > Number(dta.numContract.huydv.curr.replace(",",""))) ? '<span class="down"><i class="fa fa-arrow-down fadeInDown animated" aria-hidden="true"></i> ' : '<span class="up"><i class="fa fa-arrow-up fadeInUp animated" aria-hidden="true"></i> '
                        prevCthuydv += dta.numContract.huydv.perct+' % </span> from '+dta.lastYYYY
                        $('#boxCtHuydv .prevCtHuydv').html("").append(prevCthuydv)

                        // box CTBDV Contract
                        $('#boxCtCtbdv .currCtCtbdv').text(dta.numContract.ctbdv.curr)
                        var prevCtCtbdv = '<h4>'+dta.numContract.ctbdv.prev+' <i class="fa fa-info-circle iconTip" title="Tổng số hợp đồng CTBDV cùng kỳ năm ngoái"></i></h4>';
                        prevCtCtbdv += (Number(dta.numContract.ctbdv.prev.replace(",","")) > Number(dta.numContract.ctbdv.curr.replace(",","")))? '<span class="down"><i class="fa fa-arrow-down fadeInDown animated" aria-hidden="true"></i> ' : '<span class="up"><i class="fa fa-arrow-up fadeInUp animated" aria-hidden="true"></i> '
                        prevCtCtbdv += dta.numContract.ctbdv.perct+' % </span> from '+dta.lastYYYY
                        $('#boxCtCtbdv .prevCtCtbdv').html("").append(prevCtCtbdv)

                        // box Total Churn Rate
                        $('.currMonth').text($('.monthGrp').val())
                        $('#boxRateTotal .avgRateTotal').text(dta.churnRate.totalRate.avg)
                        $('#boxRateTotal .currRateTotal').html(dta.churnRate.totalRate.curr+' % <i class="fa fa-info-circle iconTip" title="Tỷ lệ rời mạng, bao gồm HSSD và CTBDV, của tháng hiện tại"></i>')

                        // box HUYDV Churn Rate
                        $('#boxRateHuydv .avgRateHuydv').text(dta.churnRate.huydvRate.avg)
                        $('#boxRateHuydv .currRateHuydv').html(dta.churnRate.huydvRate.curr+' % <i class="fa fa-info-circle iconTip" title="Tỷ lệ rời mạng, tính theo HSSD, của tháng hiện tại"></i>')

                        // box CTBDV Churn Rate
                        $('#boxRateCtbdv .avgRateCtbdv').text(dta.churnRate.ctbdvRate.avg)
                        $('#boxRateCtbdv .currRateCtbdv').html(dta.churnRate.ctbdvRate.curr+ ' % <i class="fa fa-info-circle iconTip" title="Tỷ lệ rời mạng, tính theo CTBDV, của tháng hiện tại"></i>')

                        $('.counter').counterUp({
                            delay: 10,
                            time: 500
                        });

                        // update series charts
                        track1.xAxis[0].update({categories: dta.numofMonth.cates})
                        updateChartOverview(track1, getJsonChurnSeries(dta.numofMonth, 0))
                        track2.xAxis[0].update({categories: dta.trendRatePert.totalTrend.cates})
                        updateChartOverview(track2, getJsonChurnSeries(dta.trendRatePert.totalTrend, 1))
                        track3.xAxis[0].update({categories: dta.trendRatePert.huydvTrend.cates})
                        updateChartOverview(track3, getJsonChurnSeries(dta.trendRatePert.huydvTrend, 1))
                        track4.xAxis[0].update({categories: dta.trendRatePert.ctbdvTrend.cates})
                        updateChartOverview(track4, getJsonChurnSeries(dta.trendRatePert.ctbdvTrend, 1))
                    }
                    else{
                        alert("Error when execute query. Please check again your system!")
                    }
                },
                complete: function () {
                    $('.divLeft').waitMe("hide");
                }
            });
        }
    })

    function getJsonChurnSeries(data, _type){
        // _type: 0 -> 2 series
        // _type : 1 -> combo chart col and line
        var rs = []
        if(_type == 0){
            rs.push({
                name: data.titSeries1,
                data: data.huydv
                },
                {
                    name: data.titSeries2,
                    data: data.ctbdv
                })
        }
        else{
            rs.push({
                    name: "Churn Rate(%)",
                    type: 'column',
                    yAxis: 0,
                    data: data.rate
                },
                {
                    name: "Churn Percent(%)",
                    type: 'column',
                    yAxis: 1,
                    data: data.perct
                },
                {
                    name: "F1",
                    type: 'spline',
                    yAxis: 0,
                    data: data.f1
                })
        }

        return rs
    }

    function updateChartOverview(charts, data){
        var seriesLength = charts.series.length;
        for(var i = seriesLength -1; i > -1; i--) {
            charts.series[i].remove();
        }
        for(var i=0; i< data.length; i++) {
            charts.addSeries(data[i]);
        }
    }

    function getParamFields(token){
        var obj = {
            "csrfToken" : token,
            "province"  : $('#province').val(),
            "region"  : $('#region').val(),
            "combo"  : $('#combo').val(),
            "age"    : $('.ageDiv .select2-selection__choice').text().substring(1,$('.ageDiv .select2-selection__choice').text().length).split('x').join(','),
            "package": $('.packageDiv .select2-selection__choice').text().substring(1,$('.packageDiv .select2-selection__choice').text().length).split('x').join(','),
            "month"  : $('.monthGrp').val()
        }
        //console.log(obj)
        return obj
    }

    function getJsonTreeListRegion(dta, arrKey){
        /*[
               { "id" : "ajson1", "parent" : "#", "text" : "Simple root node" },
               { "id" : "ajson2", "parent" : "#", "text" : "Root node 2" },
               { "id" : "ajson3", "parent" : "ajson2", "text" : "Child 1" },
               { "id" : "ajson4", "parent" : "ajson2", "text" : "Child 2" },
                ]*/
        var jsArray = []
        jsArray.push({
            "text": "Choose Region",
            "id": "All",
            "parent": "#",
            'state' : {
                'opened' : false,
                'selected' : true
            }
        })
        for(var key=0;key<arrKey.length;key++){
            jsArray.push({
                "text": "Region "+arrKey[key],
                "id": arrKey[key],
                "parent": "All"
            })
            for(var i=0;i<dta.length;i++){
                if(arrKey[key] == dta[i][0]){
                    jsArray.push({
                        "text": dta[i][1],
                        "id": dta[i][1],
                        "parent": arrKey[key]
                    })
                }
            }
        }
        return jsArray
    }
</script>