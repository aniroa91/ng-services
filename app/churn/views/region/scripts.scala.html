@(rs: churn.models.RegionResponse)
@import play.api.libs.json.Json
@import services.domain.CommonService
@import churn.utils.AgeGroupUtil

<script type="text/javascript">
        var widthChart  = $(window).height() * 0.75
        var heightChart = $(window).height() * 0.42
        var spaceText = 20
        if($(window).width() >= 600){
            spaceText = 40
        }
        var optionsProfile = {
            title: 'Churn Rate (%)',
            hAxis: {
                title: '',
                gridlines: {
                    count: 14,
                    color: 'transparent'
                },
                viewWindow: {
                  min:0
                },
                textStyle : {
                    fontSize: 10
                }
            },
            vAxis: {
                title: '',
                gridlines: {
                    count: 10,
                    color: '#f0f0f0'
                },
                textStyle : {
                    fontSize: 9
                }
            },
            chartArea: {
                height: "67%",
                width: "73%",
                left: 150,
                right: 10
            },
            width: widthChart,
            height: heightChart,
            sizeAxis: {
                maxSize: 20
            },
            colorAxis: {colors: ['#F5F6CE', 'green']},
            bubble: {
                textStyle: {
                    auraColor: 'none',
                },
                cursor: 'pointer',
                opacity: 1
            },
            tooltip: {
                trigger: 'none'
            }
        };
        var optionsProfileAge = {
            title: 'Churn Rate (%)',
            hAxis: {title: 'Age',gridlines: {count: 13,color: 'transparent'}},
            vAxis: {
                title: '',
                gridlines: {count: 10,color: '#f0f0f0'},
                textStyle : {
                    fontSize: 9
                }
            },
            chartArea: {
                height: "67%",
                width: "73%",
                left: 150,
                right: 30
            },
            width: widthChart,
            height: heightChart,
            sizeAxis: {
                maxSize: 20
            },
            colorAxis: {colors: ['#fdd0a2', '#d94801']},
            bubble: {
                textStyle: {
                    auraColor: 'none',
                },
                cursor: 'pointer',
                opacity: 1
            },
            tooltip: {
                trigger: 'none'
            }
        };
        var optionsRegion = {
            title: 'Churn Rate (%)',
            hAxis: {
                title: '',
                gridlines: {
                    count: 14,
                    color: 'transparent'
                },
                viewWindow: {
                   min:0
                },
                textStyle : {
                    color:'#1c2752',
                    fontSize: 11
                },
            },
            vAxis: {
                title: '',
                gridlines: {
                    count: 9,
                    color: '#f0f0f0'
                }
            },
            chartArea: {
                height: "74%",
                width: "73%",
                left: 150,
                right: 20
            },
            width: '100%',
            height: '100%',
            sizeAxis: {
                maxSize: 20
            },
            colorAxis: {colors: ['#F6CECE', '#B40404']},
            bubble: {
                textStyle: {
                    auraColor: 'none',
                },
                cursor: 'pointer',
                opacity: 1
            },
            tooltip: {
                trigger: 'none'
            }
        };
        google.load('visualization', '1.0', {
            'packages' : [ 'corechart' ]
        });
        google.setOnLoadCallback(drawChart);

        function drawChart() {
            $('.monthPicker').datepicker({
                autoclose: true,
                minViewMode: 1,
                startDate: '-12m',
                endDate: '-1m',
                format: 'yyyy-mm'
            }).on('changeDate', function (selected) {
                var startDate = new Date(selected.date.valueOf());
                var yr = startDate.getFullYear();
                var month = startDate.getMonth() < 9 ? ('0' + Number(startDate.getMonth() + 1)) : (Number(startDate.getMonth() + 1));
                var newDate = yr + '-' + month;
                $('#month').val(newDate)
                // change highlight filters
                $('.monthGrp').removeAttr('style')
            });

            // trend profile and month charts bubble
            var container4   = document.getElementById('churn4')
            var catesMonth   = @Html(Json.stringify(Json.toJson(rs.trendProfileMonth._2)))
            var catesProfile = @Html(Json.stringify(Json.toJson(rs.trendProfileMonth._1)))

            var internetChurnHuyDv = getDataChurn(@Html(Json.stringify(Json.toJson(rs.trendProfileMonth._3))), "Month", "Profile")
            var dataHuyDv = google.visualization.arrayToDataTable(internetChurnHuyDv)
            var chartHuyDv = new google.visualization.BubbleChart(container4);
            google.visualization.events.addListener(chartHuyDv, 'ready', function () {
                Array.prototype.forEach.call(container4.getElementsByTagName('text'), function(text) {
                    if ((text.getAttribute('text-anchor') === 'end') && (text.getAttribute('fill') === '#444444')) {
                        if(text.innerHTML == 0 || text.innerHTML == 9)
                            text.setAttribute('fill-opacity',0)
                        else{
                            switch ( text.innerHTML){
                                case "1" :
                                    text.innerHTML = keyByValue(catesProfile, 1) ;break;
                                case "2" :
                                    text.innerHTML = keyByValue(catesProfile, 2) ;break;
                                case "3" :
                                    text.innerHTML = keyByValue(catesProfile, 3) ;break;
                                case "4" :
                                    text.innerHTML = keyByValue(catesProfile, 4) ;break;
                                case "5" :
                                    text.innerHTML = keyByValue(catesProfile, 5) ;break;
                                case "6" :
                                    text.innerHTML = keyByValue(catesProfile, 6) ;break;
                                case "7" :
                                    text.innerHTML = keyByValue(catesProfile, 7) ;break;
                                case "8" :
                                    text.innerHTML = keyByValue(catesProfile, 8) ;break;
                            }
                        }
                    }
                    // change label month
                    if ((text.getAttribute('text-anchor') === 'middle') && (text.getAttribute('fill') === '#444444')) {
                        if(text.innerHTML == 0 || text.innerHTML == Object.keys(catesMonth).length + 1)
                            text.setAttribute('fill-opacity',0)
                        else{
                            text.innerHTML = keyByValue(catesMonth, Number(text.innerHTML))
                        }
                    }
                });
                // remove circle value =0
                Array.prototype.forEach.call(document.getElementById('churn4').getElementsByTagName('circle'), function(circle) {
                    if(circle.getAttribute('r') == 5 && $('#minRatemonthProf').val() == 0 && $('#minPertmonthProf').val() == 0)
                        circle.setAttribute('r', 1)
                })
            });
            if(Object.keys(catesMonth).length == 1)
                optionsProfile.hAxis.gridlines.count = 4
            else
                optionsProfile.hAxis.gridlines.count = Object.keys(catesMonth).length+2
            chartHuyDv.draw(dataHuyDv, optionsProfile);
            google.visualization.events.addListener(chartHuyDv, 'select', function () {
                var selection = chartHuyDv.getSelection();
                if(selection.length >0) {
                    var row = selection[0].row;
                    var profile = dataHuyDv.getValue(row, 2)
                    var month = dataHuyDv.getValue(row, 1)
                    $(".monthPicker").datepicker("update", keyByValue(catesMonth, month));
                    $('#profile').val(keyByValue(catesProfile, profile))
                    $('.txtProfile').text(keyByValue(catesProfile, profile))
                    $('.profileDiv').show()
                    // highlight region when click1
                    Array.prototype.forEach.call(document.getElementById('churn4').getElementsByTagName('text'), function(text) {
                        if ((text.getAttribute('text-anchor') === 'end') && (text.getAttribute('fill') === '#444444' || text.getAttribute('fill') === 'green') && text.innerHTML != 0 && text.innerHTML != undefined && text.innerHTML != Object.keys(catesProfile).length+1) {
                            if (text.innerHTML == keyByValue(catesProfile, profile)) {
                                text.setAttribute('fill-opacity', 1)
                                text.setAttribute('fill', "green")
                                text.setAttribute('font-weight', "bold")
                                text.setAttribute('font-size', "11px")
                            }
                            else {
                                text.setAttribute('fill', "#444444")
                                text.setAttribute('fill-opacity', 0.5)
                                text.removeAttribute('font-weight')
                                text.setAttribute('font-size', "9px")
                            }
                        }
                    })
                }
                else{
                    $(".monthPicker").datepicker("update", $('#month').val());
                    $('#profile').val("")
                    $('.txtProfile').text("")
                    $('.profileDiv').hide()
                    // highlight region when click
                    Array.prototype.forEach.call(document.getElementById('churn4').getElementsByTagName('text'), function(text) {
                        if ((text.getAttribute('text-anchor') === 'end') && (text.getAttribute('fill') === '#444444' || text.getAttribute('fill') === 'green') && text.innerHTML != 0 && text.innerHTML != undefined && text.innerHTML != Object.keys(catesProfile).length+1) {
                            text.setAttribute('fill-opacity', 1)
                            text.setAttribute('fill', "#444444")
                            text.removeAttribute('font-weight')
                            text.setAttribute('font-size', "9px")
                        }
                    })
                }
                $('.slRegion').val("*")
                $('#age').val("")
                $('.txtAge').text("")
                $('.ageDiv').hide()
                ajaxGetChurn("profileMonth")
            });
            // tam remove qua v2
            /*google.visualization.events.addListener(chartHuyDv, 'onmousedown', function (event) {
                document.oncontextmenu = function() {
                    var month = dataHuyDv.getValue(Number(event.targetID.split('#')[2]), 1)
                    var profile = dataHuyDv.getValue(Number(event.targetID.split('#')[2]), 2)
                    window.location.href = "/churn/search?contract=Month:"+keyByValue(catesMonth, month)+"_TenGoi:"+keyByValue( catesProfile, profile)
                };
            });*/
            var mouseX;
            var mouseY;
            $(document).mousemove(function(e) {
                if($(window).width() < 992){
                    mouseY = e.pageY - 790
                }
                else{
                    mouseY = e.pageY -290;
                }
            });

            function handlerOut() {
                $('.custom_tooltip').hide()
            }

            google.visualization.events.addListener(chartHuyDv, 'onmouseover', function (event) {
                var rate = dataHuyDv.getValue(event.row, 3);
                var xAxis = dataHuyDv.getValue(event.row, 1);
                var yAxis = dataHuyDv.getValue(event.row, 2);
                var percent = dataHuyDv.getValue(event.row, 4);
                var contracts = dataHuyDv.getValue(event.row, 5);
                var x = mouseX - 225;
                if($(window).width() < 992){
                    mouseY = mouseY - 870
                }
                else{
                    mouseY = mouseY -450
                }
                var y = mouseY
                if(!(Number(percent == 0) && Number(rate) == 0)){
                    $('#churn4_tooltip').html('<div><p><b>Month:</b> ' + keyByValue(catesMonth, xAxis) +'</p><p><b>Profile:</b> '+ keyByValue( catesProfile, yAxis) +
                            '</p><p><b>Rate:</b> '+ rate +' %</p><p><b>Percent:</b> '+ percent +' %</p><p><b>Number of contracts: </b>'+contracts+'</p></div>').css({
                        'top': y,
                        'left': x
                    }).fadeIn('slow');
                }
                // remove circle value =0
                Array.prototype.forEach.call(document.getElementById('churn4').getElementsByTagName('circle'), function(circle) {
                    if($('#minRatemonthProf').val() == 0 && $('#minPertmonthProf').val() == 0 && (circle.getAttribute('fill') == 'none' || circle.getAttribute('r') == 5)){
                        circle.setAttribute('r', 1)
                    }
                })
            });
            google.visualization.events.addListener(chartHuyDv, 'onmouseout', handlerOut);

            // trend profile and age charts bubble
            var container5   = document.getElementById('churn5')
            var catesAge = @Html(Json.stringify(Json.toJson(AgeGroupUtil.AGE)))
            var catesProfAge = @Html(Json.stringify(Json.toJson(rs.trendAgeProfile._1)))
            var trendAgeProfHuyDv = getDataChurn(@Html(Json.stringify(Json.toJson(rs.trendAgeProfile._2))), "Age", "Profile")
            var dataAgeProfHuyDv = google.visualization.arrayToDataTable(trendAgeProfHuyDv)
            var chartAgeProfHuyDv = new google.visualization.BubbleChart(container5);
            google.visualization.events.addListener(chartAgeProfHuyDv, 'ready', function () {
                Array.prototype.forEach.call(container5.getElementsByTagName('text'), function(text) {
                    if ((text.getAttribute('text-anchor') === 'end') && (text.getAttribute('fill') === '#444444')) {
                        if(text.innerHTML == 0 || text.innerHTML == 9)
                            text.setAttribute('fill-opacity',0)
                        else{
                            switch ( text.innerHTML){
                                case "1" :
                                    text.innerHTML = keyByValue(catesProfAge, 1) ;break;
                                case "2" :
                                    text.innerHTML = keyByValue(catesProfAge, 2) ;break;
                                case "3" :
                                    text.innerHTML = keyByValue(catesProfAge, 3) ;break;
                                case "4" :
                                    text.innerHTML = keyByValue(catesProfAge, 4) ;break;
                                case "5" :
                                    text.innerHTML = keyByValue(catesProfAge, 5) ;break;
                                case "6" :
                                    text.innerHTML = keyByValue(catesProfAge, 6) ;break;
                                case "7" :
                                    text.innerHTML = keyByValue(catesProfAge, 7) ;break;
                                case "8" :
                                    text.innerHTML = keyByValue(catesProfAge, 8) ;break;
                            }
                        }
                    }
                    // change label month
                    if ((text.getAttribute('text-anchor') === 'middle') && (text.getAttribute('fill') === '#444444')) {
                        if(text.innerHTML == 0 || text.innerHTML == 72)
                            text.setAttribute('fill-opacity',0)
                        else{
                            switch ( text.innerHTML){
                                case "6" :
                                    text.innerHTML = "0-6";break;
                                case "12" :
                                    text.innerHTML = "06-12";break;
                                case "18" :
                                    text.innerHTML = "12-18";break;
                                case "24" :
                                    text.innerHTML = "18-24";break;
                                case "30" :
                                    text.innerHTML = "24-30";break;
                                case "36" :
                                    text.innerHTML = "30-36";break;
                                case "42" :
                                    text.innerHTML = "36-42";break;
                                case "48" :
                                    text.innerHTML = "42-48";break;
                                case "54" :
                                    text.innerHTML = "48-54";break;
                                case "60" :
                                    text.innerHTML = "54-60";break;
                                case "66" :
                                    text.innerHTML = ">60";break;
                            }
                        }
                    }
                });
                // remove circle value =0
                Array.prototype.forEach.call(document.getElementById('churn5').getElementsByTagName('circle'), function(circle) {
                    if(circle.getAttribute('r') == 5 && $('#minRateAgeProf').val() == 0 && $('#minPertAgeProf').val() == 0)
                        circle.setAttribute('r', 1)
                })
            });
            chartAgeProfHuyDv.draw(dataAgeProfHuyDv, optionsProfileAge);
            google.visualization.events.addListener(chartAgeProfHuyDv, 'select', function () {
                var selection = chartAgeProfHuyDv.getSelection();
                if(selection.length >0) {
                    var row = selection[0].row;
                    var profile = keyByValue(catesProfAge, dataAgeProfHuyDv.getValue(row, 2))
                    var age = keyByValue(catesAge, dataAgeProfHuyDv.getValue(row, 1))
                    Array.prototype.forEach.call(container5.getElementsByTagName('text'), function(text) {
                        if ((text.getAttribute('text-anchor') === 'end') && (text.getAttribute('fill') === '#444444' || text.getAttribute('fill') === '#d94801') && (text.innerHTML != 0) && (text.innerHTML != 9)) {
                            if (text.innerHTML == profile){
                                text.setAttribute('fill-opacity', 1)
                                text.setAttribute('fill', "#d94801")
                                text.setAttribute('font-weight', "bold")
                                text.setAttribute('font-size', "11px")
                            }
                            else {
                                text.setAttribute('fill', "#444444")
                                text.setAttribute('fill-opacity', 0.5)
                                text.removeAttribute('font-weight')
                                text.setAttribute('font-size', "9px")
                            }
                        }
                        // change label age
                        if ((text.getAttribute('text-anchor') === 'middle') && (text.getAttribute('fill') === '#444444' || text.getAttribute('fill') === '#d94801')) {
                            if (text.innerHTML != 0 && text.innerHTML != 72)
                                if(age == text.textContent){
                                    text.setAttribute('fill-opacity', 1)
                                    text.setAttribute('fill', "#d94801")
                                    text.setAttribute('font-weight', "bold")
                                    text.setAttribute('font-size', "11px")
                                }
                                else {
                                    text.setAttribute('fill', "#444444")
                                    text.setAttribute('fill-opacity', 0.5)
                                    text.removeAttribute('font-weight')
                                    text.setAttribute('font-size', "9px")
                                }
                        }
                    })
                    $('#profile').val(profile)
                    $('#age').val(age)
                    $('.txtProfile').text(profile)
                    $('.profileDiv').show()
                    $('.txtAge').text(age)
                    $('.ageDiv').show()
                }
                else{
                    Array.prototype.forEach.call(container5.getElementsByTagName('text'), function(text) {
                        if ((text.getAttribute('text-anchor') === 'end') && (text.getAttribute('fill') === '#444444' || text.getAttribute('fill') === '#d94801') && (text.innerHTML != 0) && (text.innerHTML != 9)) {
                            text.setAttribute('fill-opacity', 1)
                            text.setAttribute('fill', "#444444")
                            text.removeAttribute('font-weight')
                            text.setAttribute('font-size', "9px")
                        }
                        if ((text.getAttribute('text-anchor') === 'middle') && (text.getAttribute('fill') === '#444444' || text.getAttribute('fill') === '#d94801')) {
                            if (text.innerHTML != 0 && text.innerHTML != 72){
                                text.setAttribute('fill-opacity', 1)
                                text.setAttribute('fill', "#444444")
                                text.removeAttribute('font-weight')
                                text.setAttribute('font-size', "9px")
                            }
                        }
                    })
                    $('#profile').val("")
                    $('#age').val("")
                    $('.txtProfile').text("")
                    $('.profileDiv').hide()
                    $('.txtAge').text("")
                    $('.ageDiv').hide()
                }
                $('.slRegion').val("*")
                $(".monthPicker").datepicker("update", $('#month').val());
                ajaxGetChurn("profileAge")
            });
            // tam remove qua v2
            /*google.visualization.events.addListener(chartAgeProfHuyDv, 'onmousedown', function (event) {
                document.oncontextmenu = function() {
                    var age = dataAgeProfHuyDv.getValue(Number(event.targetID.split('#')[2]), 1)
                    var profile = dataAgeProfHuyDv.getValue(Number(event.targetID.split('#')[2]), 2)
                    var ageGroup = keyByValue( catesAge, age)
                    if(ageGroup == "06-12") ageGroup = "6-12"
                    window.location.href = "/churn/search?contract=Age:"+ageGroup+"_TenGoi:"+keyByValue( catesProfAge, profile)
                };
            });*/
            google.visualization.events.addListener(chartAgeProfHuyDv, 'onmouseover', function (event) {
                var rate = dataAgeProfHuyDv.getValue(event.row, 3);
                var xAxis = dataAgeProfHuyDv.getValue(event.row, 1);
                var yAxis = dataAgeProfHuyDv.getValue(event.row, 2);
                var percent = dataAgeProfHuyDv.getValue(event.row, 4);
                var contracts = dataAgeProfHuyDv.getValue(event.row, 5);
                var x = mouseX - 225;
                if($(window).width() < 992){
                    mouseY = mouseY - 870
                }
                else{
                    mouseY = mouseY -450
                }
                var y = mouseY
                if(!(Number(percent == 0) && Number(rate) == 0)){
                    $('#churn5_tooltip').html('<div><p><b>Age:</b> ' + keyByValue( catesAge, xAxis) +'</p><p><b>Profile:</b> '+ keyByValue( catesProfAge, yAxis) +
                            '</p><p><b>Rate:</b> '+ rate +' %</p><p><b>Percent:</b> '+ percent +' %</p><p><b>Number of contracts: </b>'+contracts+'</p></div>').css({
                        'top': y,
                        'left': x
                    }).fadeIn('slow');
                }
                // remove circle value =0
                Array.prototype.forEach.call(document.getElementById('churn5').getElementsByTagName('circle'), function(circle) {
                    if($('#minRateAgeProf').val() == 0 && $('#minPertAgeProf').val() == 0 && (circle.getAttribute('fill') == 'none' || circle.getAttribute('r') == 5)){
                        circle.setAttribute('r', 1)
                    }
                })
            });
            google.visualization.events.addListener(chartAgeProfHuyDv, 'onmouseout', handlerOut);

            // trend region and month charts bubble
            var container3    = document.getElementById('churn3')
            var catesMonthRegion   = @Html(Json.stringify(Json.toJson(rs.trendRegionMonth._1)))
            var trendRegionHuyDv = getDataChurn(@Html(Json.stringify(Json.toJson(rs.trendRegionMonth._2))), "Month", "Region")
            var dataRegionHuyDv = google.visualization.arrayToDataTable(trendRegionHuyDv)
            var chartRegionHuyDv = new google.visualization.BubbleChart(container3)
            google.visualization.events.addListener(chartRegionHuyDv, 'ready', function () {
                Array.prototype.forEach.call(container3.getElementsByTagName('text'), function(text) {
                    if ((text.getAttribute('text-anchor') === 'end') && (text.getAttribute('fill') === '#444444')) {
                        if(text.innerHTML == 0 || text.innerHTML == 8)
                            text.setAttribute('fill-opacity',0)
                        text.innerHTML = "Vung "+text.innerHTML
                    }
                    if((text.getAttribute('text-anchor') === 'middle') && (text.getAttribute('fill') === '#222222')){
                        text.setAttribute('x', 22.55)
                    }
                    // change label month
                    if ((text.getAttribute('text-anchor') === 'middle') && (text.getAttribute('fill') === '#1c2752')) {
                        if(text.innerHTML == 0 || text.innerHTML == Object.keys(catesMonthRegion).length + 1)
                            text.setAttribute('fill-opacity',0)
                        else{
                            text.innerHTML = keyByValue(catesMonthRegion, Number(text.innerHTML))
                        }
                    }
                });
                // remove circle value =0
                Array.prototype.forEach.call(document.getElementById('churn3').getElementsByTagName('circle'), function(circle) {
                    if(circle.getAttribute('r') == 5 && $('#minRatemonthRegion').val() == 0 && $('#minPertmonthRegion').val() == 0)
                        circle.setAttribute('r', 1)
                })
            });
            if(Object.keys(catesMonthRegion).length == 1)
                optionsRegion.hAxis.gridlines.count = 4
            else
                optionsRegion.hAxis.gridlines.count = Object.keys(catesMonthRegion).length+2
            optionsRegion.vAxis.gridlines.count = Number(@Html(Json.stringify(Json.toJson(rs.trendRegionMonth._2.map(x=> x._1).max))))+2
            chartRegionHuyDv.draw(dataRegionHuyDv, optionsRegion);
            google.visualization.events.addListener(chartRegionHuyDv, 'select', function () {
                var selection = chartRegionHuyDv.getSelection();
                if(selection.length >0) {
                    var row = selection[0].row;
                    var region = dataRegionHuyDv.getValue(row, 2)
                    var month = dataRegionHuyDv.getValue(row, 1)
                    $(".monthPicker").datepicker("update", keyByValue(catesMonthRegion, month));
                    $('.slRegion').val(region)
                }
                else{
                    $(".monthPicker").datepicker("update", $('#month').val());
                    $('.slRegion').val("*")
                }
                // highlight region when click
                Array.prototype.forEach.call(document.getElementById('churn3').getElementsByTagName('text'), function(text) {
                    if ((text.getAttribute('text-anchor') === 'end') && (text.getAttribute('fill') === '#444444' || text.getAttribute('fill') === '#B40404') && (text.innerHTML != "Vung 0") && (text.innerHTML != "Vung 8")) {
                        if ($('.slRegion').val() != "*") {
                            if (text.innerHTML == "Vung " + $('.slRegion').val()) {
                                text.setAttribute('fill-opacity', 1)
                                text.setAttribute('fill', "#B40404")
                                text.setAttribute('font-weight', "bold")
                                text.setAttribute('font-size', "14px")
                            }
                            else {
                                text.setAttribute('fill', "#444444")
                                text.setAttribute('fill-opacity', 0.5)
                                text.removeAttribute('font-weight')
                                text.setAttribute('font-size', "13px")
                            }
                        }
                        else {
                            text.setAttribute('fill-opacity', 1)
                            text.setAttribute('fill', "#444444")
                            text.removeAttribute('font-weight')
                            text.setAttribute('font-size', "13px")
                        }
                    }
                })
                $('#profile').val("")
                $('#age').val("")
                $('.txtProfile').text("")
                $('.profileDiv').hide()
                $('.txtAge').text("")
                $('.ageDiv').hide()
                ajaxGetChurn("regionMonth")
            });
            // tam remove qua v2
            /*google.visualization.events.addListener(chartRegionHuyDv, 'onmousedown', function (event) {
                document.oncontextmenu = function() {
                    var month = dataRegionHuyDv.getValue(Number(event.targetID.split('#')[2]), 1)
                    var region = dataRegionHuyDv.getValue(Number(event.targetID.split('#')[2]), 2)
                    window.location.href = "/churn/search?contract=Month:"+keyByValue(catesMonthRegion, month)+"_Region:"+region
                };
            });*/
            google.visualization.events.addListener(chartRegionHuyDv, 'onmouseover', function (event) {
                var rate = dataRegionHuyDv.getValue(event.row, 3);
                var xAxis = dataRegionHuyDv.getValue(event.row, 1);
                var yAxis = dataRegionHuyDv.getValue(event.row, 2);
                var percent = dataRegionHuyDv.getValue(event.row, 4);
                var contracts = dataRegionHuyDv.getValue(event.row, 5);
                var x = mouseX -225;
                var y = mouseY +50;
                if(!(Number(percent == 0) && Number(rate) == 0)){
                    $('#churn3_tooltip').html('<div><p><b>Month:</b> ' + keyByValue(catesMonthRegion, xAxis) +'</p><p><b>Region:</b> '+ yAxis +
                            '</p><p><b>Rate:</b> '+ rate +' %</p><p><b>Percent:</b> '+ percent +' %</p><p><b>NumOfContracts: </b>'+Highcharts.numberFormat(Math.abs(contracts), 0)+'</p></div>').css({
                        'top': y,
                        'left': x
                    }).fadeIn('slow');
                }
                // remove circle value =0
                Array.prototype.forEach.call(document.getElementById('churn3').getElementsByTagName('circle'), function(circle) {
                    if($('#minRatemonthRegion').val() == 0 && $('#minPertmonthRegion').val() == 0 && (circle.getAttribute('fill') == 'none' || circle.getAttribute('r') == 5)){
                        circle.setAttribute('r', 1)
                    }
                })
            });
            google.visualization.events.addListener(chartRegionHuyDv, 'onmouseout', handlerOut);

            var churn_region = Highcharts.chart('churn1', {
                chart: {
                    zoomType: 'xy'
                },

                title: {
                    text: ''
                },

                colors : ['#73879C','#dc5a78'],

                xAxis: {
                    categories: @Html(Json.stringify(Json.toJson(rs.churnRegion.map(x=> "Vung "+x._1))))
                },

                yAxis: [{ // Primary yAxis
                    /*max: rs._2.map(x=> x._3).max,
                    tickInterval:0.01,
                    min: rs._2.map(x=> x._3).min,*/
                    labels: {
                        format: '{value} %',
                        style: {
                            color: "#73879C"
                        }
                    },
                    title: {
                        text: 'Churn Percent',
                        style: {
                            color: "#73879C"
                        }
                    }
                }, { // Secondary yAxis
                    title: {
                        text: 'Churn Rate',
                        style: {
                            color: "#dc5a78"
                        }
                    },
                    labels: {
                        format: '{value} %',
                        style: {
                            color: "#dc5a78"
                        }
                    },
                    opposite: true
                }],

                tooltip: {
                    formatter: function() {
                        var s = [];

                        $.each(this.points, function(i, point) {
                            if(point.series.name == 'Churn Percent'){
                                s.push('<span>'+ point.x +'</span><br>');
                                s.push('<br><span>Number of Contracts : <b>'+ Highcharts.numberFormat(Math.abs(point.point.k), 0) +'</b><span>');
                            }
                            if(point.series.name == "Churn Rate"){
                                s.push('<span style="color: #dc5a78">'+ point.series.name +' : <b>'+ point.y +' %</b><span>');
                            }
                            else {
                                s.push('<span style="color: #73879C">'+ point.series.name +' : <b>'+ point.y +' %</b><span>');
                            }
                        });

                        return s.join(' <br> ');
                    },
                    shared: true
                },
                // tam remove qua v2
                /*plotOptions: {
                    series: {
                        cursor: 'pointer',
                        point: {
                            events: {
                                contextmenu: function () {
                                    window.location.href = "/churn/search?contract=Region:"+this.category.split(" ")[1]
                                }
                            }
                        }
                    }
                },*/

                series: getJsonChurnMonth2Col(@Html(Json.stringify(Json.toJson(rs.churnRegion.map(x=> x._2)))),@Html(Json.stringify(Json.toJson(rs.churnRegion.map(x=> x._3 -> x._4)))))

            });
            var churn_profile = Highcharts.chart('churn2', {
                chart: {
                    zoomType: 'xy'
                },

                title: {
                    text: ''
                },

                colors : ['#00a0b0','#d9534f'],

                xAxis: {
                    categories: @Html(Json.stringify(Json.toJson(rs.churnProfile.map(x=>x._1))))
                },

                yAxis: [{ // Primary yAxis
                    labels: {
                        format: '{value} %',
                        style: {
                            color: "#00a0b0"
                        }
                    },
                    title: {
                        text: 'Churn Percent',
                        style: {
                            color: "#00a0b0"
                        }
                    }
                }, { // Secondary yAxis
                    title: {
                        text: 'Churn Rate',
                        style: {
                            color: "#d9534f"
                        }
                    },
                    labels: {
                        format: '{value} %',
                        style: {
                            color: "#d9534f"
                        }
                    },
                    opposite: true
                }],
                plotOptions: {
                    series: {
                        cursor: 'pointer',
                        point: {
                            events: {
                                click: function () {
                                    var charts = churn_profile
                                    $('#age').val("")
                                    $('.slRegion').val("*")
                                    $(".monthPicker").datepicker("update", $('#month').val());
                                    $('.txtAge').text("")
                                    $('.ageDiv').hide()
                                    if(this.category == $('#profile').val()){
                                        for (var i = 0; i < charts.series[0].data.length; i++) {
                                            charts.series[0].data[i].update({ color: '#00a0b0' }, false, false)
                                            charts.series[1].data[i].update({ color: '#d9534f' }, false, false)
                                        }
                                        $('#profile').val("")
                                        $('.txtProfile').text("")
                                        $('.profileDiv').hide()
                                    }
                                    else {
                                        var isColor = 0
                                        for (var i = 0; i < charts.series[0].data.length; i++) {
                                            charts.series[0].data[i].update({ color: '#ddd' }, false, false)
                                            charts.series[1].data[i].update({ color: '#ddd' }, false, false)
                                            if(this.category == charts.series[1].data[i].category){
                                                isColor = i
                                            }
                                        }
                                        if(this.series.name == "Churn Rate") {
                                            this.update({ color: '#d9534f' })
                                            charts.series[0].data[isColor].update({ color: '#00a0b0' }, false, false)
                                        }
                                        else {
                                            this.update({ color: '#00a0b0' })
                                            charts.series[1].data[isColor].update({ color: '#d9534f' }, false, false)
                                        }
                                        $('#profile').val(this.category)
                                        $('.txtProfile').text(this.category)
                                        $('.profileDiv').show()
                                    }
                                    ajaxGetChurn("profile")
                                }
                                // tam remove qua v2
                                /*,
                                contextmenu: function () {
                                    window.location.href = "/churn/search?contract=TenGoi:"+this.category
                                }*/
                            }
                        }
                    }
                },
                tooltip: {
                    formatter: function() {
                        var s = [];

                        $.each(this.points, function(i, point) {
                            if(point.series.name == 'Churn Percent'){
                                s.push('<span>'+ point.x +'</span><br>');
                                s.push('<br><span>Number of Contracts : <b>'+ Highcharts.numberFormat(Math.abs(point.point.k), 0) +'</b><span>');
                            }
                            if(point.series.name == "Churn Rate"){
                                s.push('<span style="color: #d9534f">'+ point.series.name +' : <b>'+ point.y +' %</b><span>');
                            }
                            else {
                                s.push('<span style="color: #00a0b0">'+ point.series.name +' : <b>'+ point.y +' %</b><span>');
                            }
                        });

                        return s.join(' <br> ');
                    },
                    shared: true
                },

                series: getJsonChurnMonth2Col(@Html(Json.stringify(Json.toJson(rs.churnProfile.map(x=> x._2)))),@Html(Json.stringify(Json.toJson(rs.churnProfile.map(x=> x._3-> x._4)))))

            });
            // Heatmap Total contracts profile
            var churn_heatmap = Highcharts.chart('churn-heatmap', {
                chart: {
                    type: 'heatmap',
                    marginTop: 20,
                    marginBottom: 50,
                    plotBorderWidth: 1
                },

                title: {
                    text: ''
                },

                xAxis: {
                    categories: @Html(Json.stringify(Json.toJson(rs.numberOfContracts._1)))
                },

                yAxis: {
                    categories: @Html(Json.stringify(Json.toJson(rs.numberOfContracts._2.map(x=>x._1)))),
                    title: null
                },

                colorAxis: {
                    minColor: '#FFFFFF',
                    maxColor: '#4980b5',
                    type: 'logarithmic',
                    stops: [
                        [0, '#FFFFFF'],
                        [0.37, '#81BEF7'],
                        [1, '#4980b5']
                    ]
                },

                legend: {
                    align: 'right',
                    layout: 'vertical',
                    margin: 0,
                    verticalAlign: 'top',
                    y: 25,
                    symbolHeight: 280
                },

                tooltip: {
                    formatter: function () {
                        return 'Age: <b>' + this.series.xAxis.categories[this.point.x] +'</b><br/>Profile: <b>'+ this.series.yAxis.categories[this.point.y] + '</b><br/>Number of contracts: <b>' +
                                this.point.value +'</b>';
                    }
                },

                plotOptions: {
                    series: {
                        point: {
                            events: {
                                click: function (event) {
                                    //console.log(event.series.xAxis[0])
                                    var age = event.point.series.xAxis.categories[event.point.x]
                                    var profile = event.point.series.yAxis.categories[event.point.y]
                                    if(age == $('#age').val() && profile == $('#profile').val()){
                                        $(event.point.series.xAxis.labelGroup.element.childNodes).css('fill', '#666666')
                                        $(event.point.series.xAxis.labelGroup.element.childNodes).attr('opacity', '1')
                                        $(event.point.series.xAxis.labelGroup.element.childNodes).css('font-weight', '100')
                                        $(event.point.series.xAxis.labelGroup.element.childNodes).css('font-size', '11px')
                                        $(event.point.series.yAxis.labelGroup.element.childNodes).css('fill', '#666666')
                                        $(event.point.series.yAxis.labelGroup.element.childNodes).attr('opacity', '1')
                                        $(event.point.series.yAxis.labelGroup.element.childNodes).css('font-weight', '100')
                                        $(event.point.series.yAxis.labelGroup.element.childNodes).css('font-size', '11px')
                                        $('#profile').val("")
                                        $('#age').val("")
                                        $('.txtAge').text("")
                                        $('.ageDiv').hide()
                                        $('.txtProfile').text("")
                                        $('.profileDiv').hide()
                                    }
                                    else{
                                        $(event.point.series.xAxis.labelGroup.element.childNodes).css('fill', '#666666')
                                        $(event.point.series.xAxis.labelGroup.element.childNodes).attr('opacity', '0.5')
                                        $(event.point.series.xAxis.labelGroup.element.childNodes).css('font-weight', '100')
                                        $(event.point.series.xAxis.labelGroup.element.childNodes).css('font-size', '11px')
                                        $(event.point.series.yAxis.labelGroup.element.childNodes).css('fill', '#666666')
                                        $(event.point.series.yAxis.labelGroup.element.childNodes).attr('opacity', '0.5')
                                        $(event.point.series.yAxis.labelGroup.element.childNodes).css('font-weight', '100')
                                        $(event.point.series.yAxis.labelGroup.element.childNodes).css('font-size', '11px')
                                        // highlight xaxis and yaxis
                                        $(event.point.series.xAxis.labelGroup.element.childNodes[event.point.x]).css('fill', '#16a085')
                                        $(event.point.series.xAxis.labelGroup.element.childNodes[event.point.x]).css('font-weight', '700')
                                        $(event.point.series.xAxis.labelGroup.element.childNodes[event.point.x]).css('font-size', '13px')
                                        $(event.point.series.xAxis.labelGroup.element.childNodes[event.point.x]).attr('opacity', '1')
                                        $(event.point.series.yAxis.labelGroup.element.childNodes[event.point.y]).css('fill', '#16a085')
                                        $(event.point.series.yAxis.labelGroup.element.childNodes[event.point.y]).css('font-weight', '700')
                                        $(event.point.series.yAxis.labelGroup.element.childNodes[event.point.y]).css('font-size', '13px')
                                        $(event.point.series.yAxis.labelGroup.element.childNodes[event.point.y]).attr('opacity', '1')
                                        $('#profile').val(profile)
                                        $('#age').val(age)
                                        $('.txtAge').text(age)
                                        $('.ageDiv').show()
                                        $('.txtProfile').text(profile)
                                        $('.profileDiv').show()

                                    }
                                    $('.slRegion').val("*")
                                    $(".monthPicker").datepicker("update", $('#month').val());
                                    ajaxGetChurn("churn5_heatmap")
                                }
                                // tam remove qua v2
                                /*,
                                contextmenu: function (event) {
                                    var age = event.point.series.xAxis.categories[event.point.x]
                                    var profile = event.point.series.yAxis.categories[event.point.y]
                                    window.location.href = "/churn/search?contract=Age:"+age +"_TenGoi:"+profile
                                }*/
                            }
                        },
                        dataLabels:{
                            formatter:function(){
                                var nf = new Intl.NumberFormat();
                                return nf.format(this.point.value);
                            }
                        },
                        cursor: 'pointer'
                    }
                },

                series: [{
                    name: 'total contracts',
                    borderWidth: 0.1,
                    borderColor:'#81BEF7',
                    data: @Html(Json.stringify(Json.toJson(rs.numberOfContracts._3))),
                    dataLabels: {
                        enabled: true,
                        style: {
                            "fontSize": "10px"
                        }
                    }
                }]

            });

            // click tooltip title
            var specifiedElement = document.getElementsByClassName('aMore');
            document.addEventListener('click', function(event) {
                var isClickInside = specifiedElement[Number($('#indexChart').val())].contains(event.target)
                if(!isClickInside && String(event.target.className).indexOf('tooltipSL')<0){
                    $('.ddMore').hide()
                    $('.dots').show()
                    $('.more').hide()
                    $('.tooltipSL').removeClass('fa-angle-double-up').addClass('fa-angle-double-down')
                }
            });

            $('.nav-tabs li').click(function () {
                var tabCurr = $('.nav-tabs li.active').find('a').attr('class')
                var tab = $(this).find('a').attr('class')
                if(tabCurr != tab){
                    $('.nav-tabs li').removeClass('in').removeClass('active')
                    $('.panel-body .tab-pane').removeClass('in').removeClass('active')
                    $('#'+tab).addClass('in').addClass('active')
                    $(this).addClass('in').addClass('active')
                }
            })
            // click filter Status
            $('.slStatus').on('change',function () {
                // remove highlight filters
                $('.slStatus').removeAttr('style')
            })
            // click filter Region
            $('.slRegion').on('change',function () {
                // remove highlight filters
                $('.slRegion').removeAttr('style')
            })
            // click apply fitler
            $('.apply').click(function () {
                //$('#profile').val("")
                //$('#age').val("")
                //$('.txtAge').text("")
                //$('.ageDiv').hide()
                //$('.txtProfile').text("")
                //$('.profileDiv').hide()
                ajaxGetChurn("*")
            })

            function ajaxGetChurn(_type){
                var fields = getParamFields(document.querySelector('input[name=csrfToken]').value)
                $.ajax({
                    url: "/internet/region/getJsonChurn",
                    cache: false,
                    data:  fields,
                    type:"POST",
                    beforeSend: function () {
                        $('.divLeft').waitMe({
                            effect: 'progressBar',
                            text: 'Please wait...',
                            bg: 'rgba(255,255,255,0.7)',
                            color: '#000',
                            textPos: 'vertical'
                        });
                    },
                    success: function (dta) {
                        if(dta != "Error"){
                            /*if($('.slStatus').val() == 4) $('.trendPrf').addClass('opacityLg')
                            else $('.trendPrf').removeClass('opacityLg')*/
                            // change highlight filters
                            $('.slStatus').attr('style','border:1px solid #16a085!important')
                            $('.slRegion').attr('style','border:1px solid #16a085!important')
                            $('.monthGrp').attr('style','background-color: #16a085!important;color: #fff')
                            // update chart Region
                               churn_region.xAxis[0].update({categories: dta.churn1.cates});
                               updateCharts(churn_region, getJsonChurnMonth2Col(dta.churn1.churnRate, dta.churn1.churnPercent))
                            if($('.slRegion').val() == "*"){
                                churn_region.series[0].update({color: '#73879C'})
                            }
                            else{
                                churn_region.series[0].update({color: '#ddd'})
                                churn_region.series[0].data[Number($('.slRegion').val() -1)].update({color: '#73879C'})
                            }
                            // update chart Profile
                            if(_type != "profile"){
                               churn_profile.xAxis[0].update({categories: dta.churn2.cates});
                               updateCharts(churn_profile, getJsonChurnMonth2Col(dta.churn2.churnRate, dta.churn2.churnPercent))
                            }
                            else{
                                if($("#profile").val() == "") {
                                    churn_profile.series[0].update({color: '#00a0b0'})
                                    churn_profile.series[1].update({color: '#d9534f'})
                                }
                            }

                            // update chart Heatmap Contract
                            if(_type != "churn5_heatmap" && _type != "profileAge") {
                                churn_heatmap.xAxis[0].update({categories: dta.heat_map.xAxis})
                                churn_heatmap.yAxis[0].update({categories: dta.heat_map.yAxis})
                                churn_heatmap.series[0].setData(dta.heat_map.data, true, true, false)
                            }

                            // update chart bubble Trend region & month
                            if(_type != "regionMonth") {
                                if(dta.churn3.data.length <= 0){
                                    $('#churn3_overlay').hide()
                                    $('#churn3').hide()
                                }
                                else{
                                    $('#churn3_overlay').show()
                                    $('#churn3').show()
                                }
                                $('#churn3_txtMin').text(dta.churn3.minPercent)
                                $('#churn3_txtMax').text(dta.churn3.maxPercent)
                                $('#churn3_circle2').text(Number(dta.churn3.minPercent + (dta.churn3.maxPercent-dta.churn3.minPercent)/5*2).toFixed(2))
                                $('#churn3_circle3').text(Number(dta.churn3.minPercent + (dta.churn3.maxPercent-dta.churn3.minPercent)/5*3).toFixed(2))
                                var chartRegionMonth  = new google.visualization.BubbleChart(document.getElementById('churn3'))
                                google.visualization.events.addListener(chartRegionMonth, 'ready', function () {
                                    Array.prototype.forEach.call(document.getElementById('churn3').getElementsByTagName('text'), function(text) {
                                        if ((text.getAttribute('text-anchor') === 'end') && (text.getAttribute('fill') === '#444444')) {
                                            if(text.innerHTML == 0 || text.innerHTML == 8)
                                                text.setAttribute('fill-opacity',0)
                                            text.innerHTML = "Vung "+text.innerHTML
                                        }
                                        if((text.getAttribute('text-anchor') === 'middle') && (text.getAttribute('fill') === '#222222')){
                                            text.setAttribute('x', 22.55)
                                        }
                                        // change label month
                                        if ((text.getAttribute('text-anchor') === 'middle') && (text.getAttribute('fill') === '#1c2752')) {

                                            if(Object.keys(dta.churn3.cates).length == 1){
                                                if (text.innerHTML == 0.5 || text.innerHTML == 0.0 || text.innerHTML == 1.5)
                                                    text.setAttribute('fill-opacity', 0)
                                                else {
                                                    if(text.innerHTML == 1.0){
                                                        text.innerHTML = keyByValue(dta.churn3.cates, 1)
                                                    }
                                                }
                                            }
                                            else {
                                                if (text.innerHTML == 0 || text.innerHTML >= Object.keys(dta.churn3.cates).length + 1)
                                                    text.setAttribute('fill-opacity', 0)
                                                else {
                                                    text.innerHTML = keyByValue(dta.churn3.cates, Number(text.innerHTML))
                                                }
                                            }
                                        }
                                        // highlight region when click
                                        if ((text.getAttribute('text-anchor') === 'end') && (text.getAttribute('fill') === '#444444' || text.getAttribute('fill') === '#B40404') && (text.innerHTML != "Vung 0") && (text.innerHTML != "Vung 8")) {
                                            if ($('.slRegion').val() != "*" ){
                                                if (text.innerHTML == "Vung "+$('.slRegion').val()){
                                                    text.setAttribute('fill-opacity', 1)
                                                    text.setAttribute('fill', "#B40404")
                                                    text.setAttribute('font-weight', "bold")
                                                    text.setAttribute('font-size', "14px")
                                                }
                                                else {
                                                    text.setAttribute('fill', "#444444")
                                                    text.setAttribute('fill-opacity', 0.5)
                                                    text.removeAttribute('font-weight')
                                                    text.setAttribute('font-size', "13px")
                                                }
                                            }
                                            else{
                                                text.setAttribute('fill-opacity', 1)
                                                text.setAttribute('fill', "#444444")
                                                text.removeAttribute('font-weight')
                                                text.setAttribute('font-size', "13px")
                                            }
                                        }
                                    });
                                    // remove circle value =0
                                    Array.prototype.forEach.call(document.getElementById('churn3').getElementsByTagName('circle'), function(circle) {
                                        if(circle.getAttribute('r') == 5 && Number(dta.churn3.isNull) == 1)
                                            circle.setAttribute('r', 1)
                                    })
                                });
                                var dataRegionMonth = google.visualization.arrayToDataTable(getDataChurn(dta.churn3.data, "Month", "Region"))
                                if(Object.keys(dta.churn3.cates).length == 1)
                                    optionsRegion.hAxis.gridlines.count = 4
                                else
                                    optionsRegion.hAxis.gridlines.count = Object.keys(dta.churn3.cates).length+2
                                optionsRegion.vAxis.gridlines.count = Number(dta.churn3.numRegion)+2
                                chartRegionMonth.draw(dataRegionMonth, optionsRegion)
                                google.visualization.events.addListener(chartRegionMonth, 'select', function () {
                                    var selection = chartRegionMonth.getSelection();
                                    if(selection.length >0) {
                                        var row = selection[0].row;
                                        var region = dataRegionMonth.getValue(row, 2)
                                        var month = dataRegionMonth.getValue(row, 1)
                                        $(".monthPicker").datepicker("update", keyByValue(dta.churn3.cates, month));
                                        $('.slRegion').val(region)
                                    }
                                    else{
                                        $(".monthPicker").datepicker("update", $('#month').val());
                                        $('.slRegion').val("*")
                                    }
                                    // highlight region when click
                                    Array.prototype.forEach.call(document.getElementById('churn3').getElementsByTagName('text'), function(text) {
                                        if ((text.getAttribute('text-anchor') === 'end') && (text.getAttribute('fill') === '#444444' || text.getAttribute('fill') === '#B40404') && (text.innerHTML != "Vung 0") && (text.innerHTML != "Vung 8")) {
                                            if ($('.slRegion').val() != "*") {
                                                if (text.innerHTML == "Vung " + $('.slRegion').val()) {
                                                    text.setAttribute('fill-opacity', 1)
                                                    text.setAttribute('fill', "#B40404")
                                                    text.setAttribute('font-weight', "bold")
                                                    text.setAttribute('font-size', "14px")
                                                }
                                                else {
                                                    text.setAttribute('fill', "#444444")
                                                    text.setAttribute('fill-opacity', 0.5)
                                                    text.removeAttribute('font-weight')
                                                    text.setAttribute('font-size', "13px")
                                                }
                                            }
                                            else {
                                                text.setAttribute('fill-opacity', 1)
                                                text.setAttribute('fill', "#444444")
                                                text.removeAttribute('font-weight')
                                                text.setAttribute('font-size', "13px")
                                            }
                                        }
                                    })
                                    $('#profile').val("")
                                    $('#age').val("")
                                    $('.txtProfile').text("")
                                    $('.profileDiv').hide()
                                    $('.txtAge').text("")
                                    $('.ageDiv').hide()
                                    ajaxGetChurn("regionMonth")
                                });
                                // tam remove qua v2
                                /*google.visualization.events.addListener(chartRegionMonth, 'onmousedown', function (event) {
                                    document.oncontextmenu = function() {
                                        var month = dataRegionMonth.getValue(Number(event.targetID.split('#')[2]), 1)
                                        var region = dataRegionMonth.getValue(Number(event.targetID.split('#')[2]), 2)
                                        window.location.href = "/churn/search?contract=Month:"+keyByValue(dta.churn3.cates, month)+"_Region:"+region
                                    };
                                });*/
                                google.visualization.events.addListener(chartRegionMonth, 'onmouseover', function (event) {
                                    var rate = dataRegionMonth.getValue(event.row, 3);
                                    var xAxis = dataRegionMonth.getValue(event.row, 1);
                                    var yAxis = dataRegionMonth.getValue(event.row, 2);
                                    var percent = dataRegionMonth.getValue(event.row, 4);
                                    var contracts = dataRegionMonth.getValue(event.row, 5);
                                    var x = mouseX - 225;
                                    var y = mouseY + 50;
                                    if(!(Number(percent == 0) && Number(rate) == 0)){
                                        $('#churn3_tooltip').html('<div><p><b>Month:</b> ' + keyByValue(dta.churn3.cates, xAxis) +'</p><p><b>Region:</b> '+ yAxis +
                                                '</p><p><b>Rate:</b> '+ rate +' %</p><p><b>Percent:</b> '+ percent +' %</p><p><b>NumOfContracts: </b>'+Highcharts.numberFormat(Math.abs(contracts), 0)+'</p></div>').css({
                                            'top': y,
                                            'left': x
                                        }).fadeIn('slow');
                                    }
                                    // remove circle value =0
                                    Array.prototype.forEach.call(document.getElementById('churn3').getElementsByTagName('circle'), function(circle) {
                                        if(Number(dta.churn3.isNull) == 1 && (circle.getAttribute('fill') == 'none' || circle.getAttribute('r') == 5)){
                                            circle.setAttribute('r', 1)
                                        }
                                    })
                                });
                                google.visualization.events.addListener(chartRegionMonth, 'onmouseout', handlerOut);
                            }
                            // update chart bubble Trend profile & month
                            if(_type != "profileMonth") {
                                if(dta.churn4.data.length <= 0){
                                    $('#churn4_overlay').hide()
                                    $('#churn4').hide()
                                }
                                else{
                                    $('#churn4_overlay').show()
                                    $('#churn4').show()
                                }
                                $('#churn4_txtMin').text(dta.churn4.minPercent)
                                $('#churn4_txtMax').text(dta.churn4.maxPercent)
                                $('#churn4_circle2').text(Number(dta.churn4.minPercent + (dta.churn4.maxPercent-dta.churn4.minPercent)/5*2).toFixed(2))
                                $('#churn4_circle3').text(Number(dta.churn4.minPercent + (dta.churn4.maxPercent-dta.churn4.minPercent)/5*3).toFixed(2))
                                var chartProfileMonth = new google.visualization.BubbleChart(document.getElementById('churn4'))
                                google.visualization.events.addListener(chartProfileMonth, 'ready', function () {
                                    Array.prototype.forEach.call(document.getElementById('churn4').getElementsByTagName('text'), function(text) {
                                        if ((text.getAttribute('text-anchor') === 'end') && (text.getAttribute('fill') === '#444444')) {
                                            if(text.innerHTML == 0 || text.innerHTML == undefined || text.innerHTML == Object.keys(dta.churn4.catesProfile).length+1)
                                                text.setAttribute('fill-opacity',0)
                                            else{
                                                switch ( text.innerHTML){
                                                    case "1" :
                                                        text.innerHTML = keyByValue(dta.churn4.catesProfile, 1) ;break;
                                                    case "2" :
                                                        text.innerHTML = keyByValue(dta.churn4.catesProfile, 2) ;break;
                                                    case "3" :
                                                        text.innerHTML = keyByValue(dta.churn4.catesProfile, 3) ;break;
                                                    case "4" :
                                                        text.innerHTML = keyByValue(dta.churn4.catesProfile, 4) ;break;
                                                    case "5" :
                                                        text.innerHTML = keyByValue(dta.churn4.catesProfile, 5) ;break;
                                                    case "6" :
                                                        text.innerHTML = keyByValue(dta.churn4.catesProfile, 6) ;break;
                                                    case "7" :
                                                        text.innerHTML = keyByValue(dta.churn4.catesProfile, 7) ;break;
                                                    case "8" :
                                                        text.innerHTML = keyByValue(dta.churn4.catesProfile, 8) ;break;
                                                }
                                            }
                                        }
                                        // change label month
                                        if ((text.getAttribute('text-anchor') === 'middle') && (text.getAttribute('fill') === '#444444')) {
                                            if(Object.keys(dta.churn4.catesMonth).length == 1){
                                                if (text.innerHTML == 0.5 || text.innerHTML == 0.0 || text.innerHTML == 1.5)
                                                    text.setAttribute('fill-opacity', 0)
                                                else {
                                                    if(text.innerHTML == 1.0){
                                                        text.innerHTML = keyByValue(dta.churn4.catesMonth, 1)
                                                    }
                                                }
                                            }
                                            else{
                                                if(text.innerHTML == 0 || text.innerHTML >= Object.keys(dta.churn4.catesMonth).length+1)
                                                    text.setAttribute('fill-opacity',0)
                                                else{
                                                    text.innerHTML = keyByValue(dta.churn4.catesMonth, Number(text.innerHTML))
                                                }
                                            }
                                        }
                                    });
                                    // remove circle value =0
                                    Array.prototype.forEach.call(document.getElementById('churn4').getElementsByTagName('circle'), function(circle) {
                                        if(circle.getAttribute('r') == 5 && Number(dta.churn4.isNull) == 1)
                                            circle.setAttribute('r', 1)
                                    })
                                })
                                var dataProfileMonth = google.visualization.arrayToDataTable(getDataChurn(dta.churn4.data,  "Month", "Profile"))
                                if(Object.keys(dta.churn4.catesMonth).length == 1)
                                    optionsProfile.hAxis.gridlines.count = 4
                                else
                                    optionsProfile.hAxis.gridlines.count = Object.keys(dta.churn4.catesMonth).length+2
                                optionsProfile.vAxis.gridlines.count = Object.keys(dta.churn4.catesProfile).length+2
                                chartProfileMonth.draw(dataProfileMonth, optionsProfile)
                                google.visualization.events.addListener(chartProfileMonth, 'select', function () {
                                    var selection = chartProfileMonth.getSelection();
                                    if(selection.length >0) {
                                        var row = selection[0].row;
                                        var profile = dataProfileMonth.getValue(row, 2)
                                        var month = dataProfileMonth.getValue(row, 1)
                                        $(".monthPicker").datepicker("update", keyByValue(dta.churn4.catesMonth, month));
                                        $('#profile').val(keyByValue(dta.churn4.catesProfile, profile))
                                        $('.txtProfile').text(keyByValue(dta.churn4.catesProfile, profile))
                                        $('.profileDiv').show()
                                        // highlight region when click1
                                        Array.prototype.forEach.call(document.getElementById('churn4').getElementsByTagName('text'), function(text) {
                                            if ((text.getAttribute('text-anchor') === 'end') && (text.getAttribute('fill') === '#444444' || text.getAttribute('fill') === 'green') && text.innerHTML != 0 && text.innerHTML != undefined && text.innerHTML != Object.keys(dta.churn4.catesProfile).length+1) {
                                                if (text.innerHTML == keyByValue(dta.churn4.catesProfile, profile)) {
                                                    text.setAttribute('fill-opacity', 1)
                                                    text.setAttribute('fill', "green")
                                                    text.setAttribute('font-weight', "bold")
                                                    text.setAttribute('font-size', "11px")
                                                }
                                                else {
                                                    text.setAttribute('fill', "#444444")
                                                    text.setAttribute('fill-opacity', 0.5)
                                                    text.removeAttribute('font-weight')
                                                    text.setAttribute('font-size', "9px")
                                                }
                                            }
                                        })
                                    }
                                    else{
                                        $(".monthPicker").datepicker("update", $('#month').val());
                                        $('#profile').val("")
                                        $('.txtProfile').text("")
                                        $('.profileDiv').hide()
                                        // highlight region when click
                                        Array.prototype.forEach.call(document.getElementById('churn4').getElementsByTagName('text'), function(text) {
                                            if ((text.getAttribute('text-anchor') === 'end') && (text.getAttribute('fill') === '#444444' || text.getAttribute('fill') === 'green') && text.innerHTML != 0 && text.innerHTML != undefined && text.innerHTML != Object.keys(dta.churn4.catesProfile).length+1) {
                                                text.setAttribute('fill-opacity', 1)
                                                text.setAttribute('fill', "#444444")
                                                text.removeAttribute('font-weight')
                                                text.setAttribute('font-size', "9px")
                                            }
                                        })
                                    }
                                    $('.slRegion').val("*")
                                    $('#age').val("")
                                    $('.txtAge').text("")
                                    $('.ageDiv').hide()
                                    ajaxGetChurn("profileMonth")
                                })
                                // tam remove qua v2
                                /*google.visualization.events.addListener(chartProfileMonth, 'onmousedown', function (event) {
                                    document.oncontextmenu = function() {
                                        var month = dataProfileMonth.getValue(Number(event.targetID.split('#')[2]), 1)
                                        var profile = dataProfileMonth.getValue(Number(event.targetID.split('#')[2]), 2)
                                        window.location.href = "/churn/search?contract=Month:"+keyByValue(dta.churn4.catesMonth, month)+"_TenGoi:"+keyByValue( dta.churn4.catesProfile, profile)
                                    };
                                });*/
                                google.visualization.events.addListener(chartProfileMonth, 'onmouseover', function (event) {
                                    var rate = dataProfileMonth.getValue(event.row, 3);
                                    var xAxis = dataProfileMonth.getValue(event.row, 1);
                                    var yAxis = dataProfileMonth.getValue(event.row, 2);
                                    var percent = dataProfileMonth.getValue(event.row, 4);
                                    var contracts = dataProfileMonth.getValue(event.row, 5);
                                    var x = mouseX - 225;
                                    if($(window).width() < 992){
                                        mouseY = mouseY - 870
                                    }
                                    else{
                                        mouseY = mouseY -450
                                    }
                                    var y = mouseY
                                    if(!(Number(percent == 0) && Number(rate) == 0)){
                                        $('#churn4_tooltip').html('<div><p><b>Month:</b> ' + keyByValue(dta.churn4.catesMonth, xAxis) +'</p><p><b>Profile:</b> '+ keyByValue( dta.churn4.catesProfile, yAxis) +
                                                '</p><p><b>Rate:</b> '+ rate +' %</p><p><b>Percent:</b> '+ percent +' %</p><p><b>Number of contracts: </b>'+contracts+'</p></div>').css({
                                            'top': y,
                                            'left': x
                                        }).fadeIn('slow');
                                    }
                                    // remove circle value =0
                                    Array.prototype.forEach.call(document.getElementById('churn4').getElementsByTagName('circle'), function(circle) {
                                        if(Number(dta.churn4.isNull) == 1 && (circle.getAttribute('fill') == 'none' || circle.getAttribute('r') == 5)){
                                            circle.setAttribute('r', 1)
                                        }
                                    })
                                })
                                google.visualization.events.addListener(chartProfileMonth, 'onmouseout', handlerOut)
                            }
                            // update chart bubble Trend profile & age
                            if(_type != "profileAge" && _type != "churn5_heatmap") {
                                if(dta.churn5.data.length <= 0){
                                    $('#churn5_overlay').hide()
                                    $('#churn5').hide()
                                }
                                else{
                                    $('#churn5_overlay').show()
                                    $('#churn5').show()
                                }
                                $('#churn5_txtMin').text(dta.churn5.minPercent)
                                $('#churn5_txtMax').text(dta.churn5.maxPercent)
                                $('#churn5_circle2').text(Number(dta.churn5.minPercent + (dta.churn5.maxPercent-dta.churn5.minPercent)/5*2).toFixed(2))
                                $('#churn5_circle3').text(Number(dta.churn5.minPercent + (dta.churn5.maxPercent-dta.churn5.minPercent)/5*3).toFixed(2))
                                var chartAgeProfile = new google.visualization.BubbleChart(document.getElementById('churn5'))
                                google.visualization.events.addListener(chartAgeProfile, 'ready', function () {
                                    Array.prototype.forEach.call(document.getElementById('churn5').getElementsByTagName('text'), function(text) {
                                        if ((text.getAttribute('text-anchor') === 'end') && (text.getAttribute('fill') === '#444444')) {
                                            if(text.innerHTML == 0 | text.innerHTML == undefined || text.innerHTML == Object.keys(dta.churn5.catesProfile).length+1)
                                                text.setAttribute('fill-opacity',0)
                                            else{
                                                switch ( text.innerHTML){
                                                    case "1" :
                                                        text.innerHTML = keyByValue(dta.churn5.catesProfile, 1) ;break;
                                                    case "2" :
                                                        text.innerHTML = keyByValue(dta.churn5.catesProfile, 2) ;break;
                                                    case "3" :
                                                        text.innerHTML = keyByValue(dta.churn5.catesProfile, 3) ;break;
                                                    case "4" :
                                                        text.innerHTML = keyByValue(dta.churn5.catesProfile, 4) ;break;
                                                    case "5" :
                                                        text.innerHTML = keyByValue(dta.churn5.catesProfile, 5) ;break;
                                                    case "6" :
                                                        text.innerHTML = keyByValue(dta.churn5.catesProfile, 6) ;break;
                                                    case "7" :
                                                        text.innerHTML = keyByValue(dta.churn5.catesProfile, 7) ;break;
                                                    case "8" :
                                                        text.innerHTML = keyByValue(dta.churn5.catesProfile, 8) ;break;
                                                }
                                            }
                                        }
                                        // change label age
                                        if ((text.getAttribute('text-anchor') === 'middle') && (text.getAttribute('fill') === '#444444')) {
                                            if(text.innerHTML == 0 || text.innerHTML == 72)
                                                text.setAttribute('fill-opacity',0)
                                            else{
                                                switch ( text.innerHTML){
                                                    case "6" :
                                                        text.innerHTML = "0-6";break;
                                                    case "12" :
                                                        text.innerHTML = "06-12";break;
                                                    case "18" :
                                                        text.innerHTML = "12-18";break;
                                                    case "24" :
                                                        text.innerHTML = "18-24";break;
                                                    case "30" :
                                                        text.innerHTML = "24-30";break;
                                                    case "36" :
                                                        text.innerHTML = "30-36";break;
                                                    case "42" :
                                                        text.innerHTML = "36-42";break;
                                                    case "48" :
                                                        text.innerHTML = "42-48";break;
                                                    case "54" :
                                                        text.innerHTML = "48-54";break;
                                                    case "60" :
                                                        text.innerHTML = "54-60";break;
                                                    case "66" :
                                                        text.innerHTML = ">60";break;
                                                }
                                            }
                                        }
                                    });
                                    // remove circle value =0
                                    Array.prototype.forEach.call(document.getElementById('churn5').getElementsByTagName('circle'), function(circle) {
                                        if(circle.getAttribute('r') == 5 && Number(dta.churn5.isNull) == 1)
                                            circle.setAttribute('r', 1)
                                    })
                                })
                                var dataAgeProfile = google.visualization.arrayToDataTable(getDataChurn(dta.churn5.data,  "Age", "Profile"))
                                optionsProfileAge.vAxis.gridlines.count = Object.keys(dta.churn5.catesProfile).length+2
                                chartAgeProfile.draw(dataAgeProfile, optionsProfileAge)
                                google.visualization.events.addListener(chartAgeProfile, 'onmouseover', function (event) {
                                    var rate = dataAgeProfile.getValue(event.row, 3);
                                    var xAxis = dataAgeProfile.getValue(event.row, 1);
                                    var yAxis = dataAgeProfile.getValue(event.row, 2);
                                    var percent = dataAgeProfile.getValue(event.row, 4);
                                    var contracts = dataAgeProfile.getValue(event.row, 5);
                                    var x = mouseX - 225;
                                    if($(window).width() < 992){
                                        mouseY = mouseY - 870
                                    }
                                    else{
                                        mouseY = mouseY -450
                                    }
                                    var y = mouseY
                                    if(!(Number(percent == 0) && Number(rate) == 0)){
                                        $('#churn5_tooltip').html('<div><p><b>Age:</b> ' + keyByValue( catesAge, xAxis) +'</p><p><b>Profile:</b> '+ keyByValue( dta.churn5.catesProfile, yAxis) +
                                                '</p><p><b>Rate:</b> '+ rate +' %</p><p><b>Percent:</b> '+ percent +' %</p><p><b>Number of contracts: </b>'+contracts+'</p></div>').css({
                                            'top': y,
                                            'left': x
                                        }).fadeIn('slow');
                                    }
                                    // remove circle value =0
                                    Array.prototype.forEach.call(document.getElementById('churn5').getElementsByTagName('circle'), function(circle) {
                                        if(Number(dta.churn5.isNull) == 1 && (circle.getAttribute('fill') == 'none' || circle.getAttribute('r') == 5)){
                                            circle.setAttribute('r', 1)
                                        }
                                    })
                                })
                                // tam remove qua v2
                                /*google.visualization.events.addListener(chartAgeProfile, 'onmousedown', function (event) {
                                    document.oncontextmenu = function() {
                                        var age = dataAgeProfile.getValue(Number(event.targetID.split('#')[2]), 1)
                                        var profile = dataAgeProfile.getValue(Number(event.targetID.split('#')[2]), 2)
                                        var ageGroup = keyByValue( catesAge, age)
                                        if(ageGroup == "06-12") ageGroup = "6-12"
                                        window.location.href = "/churn/search?contract=Age:"+ageGroup+"_TenGoi:"+keyByValue( dta.churn5.catesProfile, profile)
                                    };
                                });*/
                                google.visualization.events.addListener(chartAgeProfile, 'select', function () {
                                    var selection = chartAgeProfile.getSelection();
                                    if(selection.length >0) {
                                        var row = selection[0].row;
                                        var profile = keyByValue(dta.churn5.catesProfile, dataAgeProfile.getValue(row, 2))
                                        var age = keyByValue(catesAge, dataAgeProfile.getValue(row, 1))
                                        Array.prototype.forEach.call(document.getElementById('churn5').getElementsByTagName('text'), function(text) {
                                            if ((text.getAttribute('text-anchor') === 'end') && (text.getAttribute('fill') === '#444444' || text.getAttribute('fill') === '#d94801') && (text.innerHTML != 0) && (text.innerHTML != 9)) {
                                                if (text.innerHTML == profile){
                                                    text.setAttribute('fill-opacity', 1)
                                                    text.setAttribute('fill', "#d94801")
                                                    text.setAttribute('font-weight', "bold")
                                                    text.setAttribute('font-size', "11px")
                                                }
                                                else {
                                                    text.setAttribute('fill', "#444444")
                                                    text.setAttribute('fill-opacity', 0.5)
                                                    text.removeAttribute('font-weight')
                                                    text.setAttribute('font-size', "9px")
                                                }
                                            }
                                            // change label age
                                            if ((text.getAttribute('text-anchor') === 'middle') && (text.getAttribute('fill') === '#444444' || text.getAttribute('fill') === '#d94801')) {
                                                if (text.innerHTML != 0 && text.innerHTML != 72)
                                                    if(age == text.textContent){
                                                        text.setAttribute('fill-opacity', 1)
                                                        text.setAttribute('fill', "#d94801")
                                                        text.setAttribute('font-weight', "bold")
                                                        text.setAttribute('font-size', "11px")
                                                    }
                                                    else {
                                                        text.setAttribute('fill', "#444444")
                                                        text.setAttribute('fill-opacity', 0.5)
                                                        text.removeAttribute('font-weight')
                                                        text.setAttribute('font-size', "9px")
                                                    }
                                            }
                                        })
                                        $('#profile').val(profile)
                                        $('#age').val(age)
                                        $('.txtProfile').text(profile)
                                        $('.profileDiv').show()
                                        $('.txtAge').text(age)
                                        $('.ageDiv').show()
                                    }
                                    else{
                                        Array.prototype.forEach.call(document.getElementById('churn5').getElementsByTagName('text'), function(text) {
                                            if ((text.getAttribute('text-anchor') === 'end') && (text.getAttribute('fill') === '#444444' || text.getAttribute('fill') === '#d94801') && (text.innerHTML != 0) && (text.innerHTML != 9)) {
                                                text.setAttribute('fill-opacity', 1)
                                                text.setAttribute('fill', "#444444")
                                                text.removeAttribute('font-weight')
                                                text.setAttribute('font-size', "9px")
                                            }
                                            if ((text.getAttribute('text-anchor') === 'middle') && (text.getAttribute('fill') === '#444444' || text.getAttribute('fill') === '#d94801')) {
                                                if (text.innerHTML != 0 && text.innerHTML != 72){
                                                    text.setAttribute('fill-opacity', 1)
                                                    text.setAttribute('fill', "#444444")
                                                    text.removeAttribute('font-weight')
                                                    text.setAttribute('font-size', "9px")
                                                }
                                            }
                                        })
                                        $('#profile').val("")
                                        $('#age').val("")
                                        $('.txtProfile').text("")
                                        $('.profileDiv').hide()
                                        $('.txtAge').text("")
                                        $('.ageDiv').hide()
                                    }
                                    $('.slRegion').val("*")
                                    $(".monthPicker").datepicker("update", $('#month').val());
                                    ajaxGetChurn("profileAge")
                                })
                                google.visualization.events.addListener(chartAgeProfile, 'onmouseout', handlerOut);
                            }
                        }
                        else{
                            alert("Error when execute query. Please check again your system!")
                        }
                    },
                    complete: function () {
                        $('.divLeft').waitMe("hide");
                    }
                });
            }
        }

        function getParamFields(token){
            var obj = {
                "csrfToken" : token,
                "region" : $('.slRegion').val(),
                "age"    : $('#age').val(),
                "profile": $('#profile').val(),
                "month"  : $('.monthGrp').val(),
                "status" : $('.slStatus').val()
            }
            //console.log(obj)
            return obj
        }

        function getDataChurn(dta, cateX, cateY){
            var rs = []
            rs.push(['ID', cateX, cateY,'Rate', 'Percent', 'Contract'])
            for(var i=0;i<dta.length;i++){
                var arr = []
                arr[0]=''
                arr[1]=dta[i][1]
                arr[2]=dta[i][0]
                arr[3]=dta[i][2]
                arr[4]=dta[i][3]
                arr[5]=dta[i][4]
                rs.push(arr)
            }
            return rs
        }

</script>