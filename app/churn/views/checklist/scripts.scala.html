@(rs: churn.models.ChecklistResponse, arrayMonth: Array[String])
@import play.api.libs.json.Json
@import services.domain.CommonService

    <script type="text/javascript">
        var width = '60%'
        var left = 'auto'
        var right = 'auto'
        if($(window).width() <= 600) {
            left = 110
            right = 0
            width = '70%'
        }
        else if($(window).width() > 600 && $(window).width() <= 800) {
            left = 'auto'
            right = 10
            width = '70%'
        }
        else if($(window).width() > 800 && $(window).width() <= 1024) {
            left = 'auto'
            right = 10
            width = '80%'
        }
        var options = {
            title: 'Churn Rate (%)',
            hAxis: {
                title: '',
                gridlines: {
                    count: 13,
                    color: 'transparent'
                }
            },
            vAxis: {
                title: '',
                gridlines: {
                    count: 9,
                    color: '#f0f0f0'
                }
            },
            chartArea: {
                height: "74%",
                width: "73%",
                left: 150,
                right: 20
            },
            width: '100%',
            height: '100%',
            sizeAxis: {
                maxSize: 25
            },
            colorAxis: {colors: ['#F5F6CE', 'green']},
            bubble: {
                textStyle: {
                    auraColor: 'none',
                },
                cursor: 'pointer',
                opacity: 1
            },
            tooltip: {
                trigger: 'none'
            }
        };
        var optionsRegion = {
            title: 'Churn Rate (%)',
            hAxis: {
                title: '',
                gridlines: {
                    count: 14,
                    color: 'transparent'
                },
                viewWindow: {
                    min:0
                },
                textStyle : {
                    color:'#1c2752',
                    fontSize: 11
                },
                slantedText:true
            },
            vAxis: {
                title: '',
                gridlines: {
                    count: 10,
                    color: '#f0f0f0'
                }
            },
            chartArea: {
                height: "74%",
                width: "73%",
                left: 150,
                right: 20
            },
            width: '100%',
            height: '100%',
            sizeAxis: {
                maxSize: 20
            },
            colorAxis: {colors: ['#F6CECE', '#B40404']},
            bubble: {
                textStyle: {
                    auraColor: 'none',
                },
                cursor: 'pointer',
                opacity: 1
            },
            tooltip: {
                trigger: 'none'
            }
        };
        var optionsCause = {
            title: 'Churn Rate (%)',
            hAxis: {
                title: '',
                gridlines: {
                    count: 14,
                    color: 'transparent'
                },
                viewWindow: {
                    min:0
                },
                textStyle : {
                    color:'#1c2752',
                    fontSize: 11
                },
                slantedText:true,
                slantedTextAngle: 17
            },
            vAxis: {
                title: '',
                gridlines: {
                    count: 10,
                    color: '#f0f0f0'
                }
            },
            chartArea: {
                height: "74%",
                width: "73%",
                left: 150,
                right: 20,
                bottom: 90
            },
            width: '100%',
            height: '100%',
            sizeAxis: {
                maxSize: 20
            },
            colorAxis: {colors: ['#F6CECE', '#B40404']},
            bubble: {
                textStyle: {
                    auraColor: 'none',
                },
                cursor: 'pointer',
                opacity: 1
            },
            tooltip: {
                trigger: 'none'
            }
        };
        google.load('visualization', '1.0', {
            'packages' : [ 'corechart' ]
        });
        google.setOnLoadCallback(drawChart);

        function drawChart() {
            // click tab
            $('.nav-tabs li').click(function () {
                var tabCurr = $('.nav-tabs li.active').find('a').attr('class')
                var tab = $(this).find('a').attr('class')
                if(tabCurr != tab){
                    $('#commentBox').show()
                    $('#tabName').val(tab)
                    $('.nav-tabs li').removeClass('in').removeClass('active')
                    $('.panel-body .tab-pane').removeClass('in').removeClass('active')
                    $('#'+tab).addClass('in').addClass('active')
                    $(this).addClass('in').addClass('active')
                    getChurnByTab(tab)
                }
            })
            $(".slAge").select2({
                placeholder: "Choose age group ..."
            });
            $(".slPackage").select2({
                placeholder: "Choose package ..."
            });
            $(".slPosition").select2();
            $(".slCause").select2();
            $(".slGrpChl").select2();
            $(".slTime").select2();
            $(".slProcess").select2();
            $('.radio').iCheck({
                radioClass: 'iradio_square-purple'
            });
            $('.checkbox').iCheck({
                checkboxClass: 'icheckbox_square-purple'
            });
            $('.monthPicker').datepicker({
                autoclose: true,
                minViewMode: 1,
                endDate: '-1m',
                format: 'yyyy-mm'
            }).on('changeDate', function (selected) {
                var startDate = new Date(selected.date.valueOf());
                var yr = startDate.getFullYear();
                var month = startDate.getMonth() < 9 ? ('0' + Number(startDate.getMonth() + 1)) : (Number(startDate.getMonth() + 1));
                var newDate = yr + '-' + month;
                $('#month').val(newDate)
                // change highlight filters
                $('.monthGrp').removeAttr('style')
            });
            // jsTree Region and province
            $('.region').jstree({
                "plugins" : ["checkbox"],
                'checkbox': {
                    deselect_all: true,
                    three_state: false
                },
                'core' : {
                    multiple: false,
                    expand_selected_onload : false,
                    "themes":{
                        "icons":false
                    },
                    'data' : getJsonTreeListRegion(@Html(Json.stringify(Json.toJson(rs.province))),@Html(Json.stringify(Json.toJson( rs.province.map(x => x._1).distinct.sorted ))))
                }
            }).on('changed.jstree', function (e, data) {
                var i, j, nodes = [], provinces = [];
                for (i = 0, j = data.selected.length; i < j; i++) {
                    nodes.push(data.instance.get_node(data.selected[i]).id);
                }
                var regionArr = nodes.join(', ').split(',')
                for (var i = 0; i < regionArr.length; i++) {
                    provinces.push(regionArr[i])
                }
                $('#province').val(provinces)
            })

            var churn1 = Highcharts.chart('churn1', {
                chart: {
                    zoomType: 'xy'
                },
                title: {
                    text: ''
                },
                colors : ['#f1b53d','#3498DB', '#dc5a78'],
                xAxis: {
                    categories: @Html(Json.stringify(Json.toJson(rs.ctCheckList.map(x=> x._1))))
                },
                yAxis: [{
                    labels: {
                        format: '{value}',
                        style: {
                            color: "#f1b53d"
                        }
                    },
                    title: {
                        text: '',
                        style: {
                            color: "#f1b53d"
                        }
                    }
                }, { // Secondary yAxis
                    title: {
                        text: '',
                        style: {
                            color: "#dc5a78"
                        }
                    },
                    labels: {
                        format: '{value} %',
                        style: {
                            color: "#dc5a78"
                        }
                    },
                    opposite: true
                }],
                tooltip: {
                    shared: true
                },
                series: getJson2Column1Line(@Html(Json.stringify(Json.toJson(rs.ctCheckList.map(x=> x._2)))),@Html(Json.stringify(Json.toJson(rs.ctCheckList.map(x=> x._3)))), @Html(Json.stringify(Json.toJson(rs.ctCheckList.map(x=> x._4)))),"Count Checklist")
            });
            var churn2 = Highcharts.chart('churn2', {
                chart: {
                    zoomType: 'xy'
                },
                title: {
                    text: ''
                },
                colors : ['#1ABB9C','#dc5a78'],
                xAxis: {
                    categories: @Html(Json.stringify(Json.toJson(rs.trendChecklist.map(x=> x._1))))
                },
                yAxis: [{
                    labels: {
                        format: '{value} %',
                        style: {
                            color: "#1ABB9C"
                        }
                    },
                    title: {
                        text: 'Churn Percent',
                        style: {
                            color: "#1ABB9C"
                        }
                    }
                }, { // Secondary yAxis
                    title: {
                        text: 'Churn Rate',
                        style: {
                            color: "#dc5a78"
                        }
                    },
                    labels: {
                        format: '{value} %',
                        style: {
                            color: "#dc5a78"
                        }
                    },
                    opposite: true
                }],
                tooltip: {
                    formatter: function() {
                        var s = [];

                        $.each(this.points, function(i, point) {
                            if(point.series.name == 'Churn Percent'){
                                s.push('<span>'+ point.x +'</span><br>');
                                s.push('<br><span>Number of Contracts : <b>'+ Highcharts.numberFormat(Math.abs(point.point.k), 0) +'</b><span>');
                            }
                            if(point.series.name == "Churn Rate"){
                                s.push('<span style="color: #dc5a78">'+ point.series.name +' : <b>'+ point.y +' %</b><span>');
                            }
                            else {
                                s.push('<span style="color: #1ABB9C">'+ point.series.name +' : <b>'+ point.y +' %</b><span>');
                            }
                        });

                        return s.join(' <br> ');
                    },
                    shared: true
                },
                series: getJsonChurnMonth(@Html(Json.stringify(Json.toJson(rs.trendChecklist.map(x=> x._2)))),@Html(Json.stringify(Json.toJson(rs.trendChecklist.map(x=> x._3->x._4)))))
            });

            // click tooltip title
            var specifiedElement = document.getElementsByClassName('aMore');
            document.addEventListener('click', function(event) {
                var isClickInside = specifiedElement[Number($('#indexChart').val())].contains(event.target)
                if(!isClickInside && String(event.target.className).indexOf('tooltipSL')<0){
                    $('.ddMore').hide()
                    $('.dots').show()
                    $('.more').hide()
                    $('.tooltipSL').removeClass('fa-angle-double-up').addClass('fa-angle-double-down')
                }
            });

            function ajaxGetChurnChecklist(_type){
                $('.nav-tabs li').removeClass('in').removeClass('active')
                $('.panel-body .tab-pane').removeClass('in').removeClass('active')
                var fields = getParamFields(document.querySelector('input[name=csrfToken]').value)
                $.ajax({
                    url: "/checklist/getJsonChurn",
                    cache: false,
                    data:  fields,
                    type:"POST",
                    beforeSend: function () {
                        $('.divLeft').waitMe({
                            effect: 'progressBar',
                            text: 'Please wait...',
                            bg: 'rgba(255,255,255,0.7)',
                            color: '#000',
                            textPos: 'vertical'
                        });
                    },
                    success: function (dta) {
                        if(dta != "Error"){
                            /* update box number */
                            // box Contract have Checklist
                            $('#boxNumCtChl .currNumCtChl').text(dta.contractCL.curr)
                            var prevCtCL = '<h4>'+dta.contractCL.prev+' <i class="fa fa-info-circle iconTip" title="Tổng số hợp đồng có checklist cùng kỳ năm ngoái"></i></h4>';
                            prevCtCL += (Number(dta.contractCL.prev.replace(",","")) > Number(dta.contractCL.curr.replace(",","")))? '<span class="down"><i class="fa fa-arrow-down fadeInDown animated" aria-hidden="true"></i> ' : '<span class="up"><i class="fa fa-arrow-up fadeInUp animated" aria-hidden="true"></i> '
                            prevCtCL += dta.contractCL.perct+' % </span> from '+dta.lastYYYY
                            $('#boxNumCtChl .prevNumCtChl').html("").append(prevCtCL)
                            if(dta.contractCL.curr == "0" && dta.contractCL.prev == "0") $('#boxNumCtChl').attr('style','opacity:0.2')
                            else $('#boxNumCtChl').removeAttr('style')
                            // box num of Checklist
                            $('#boxNumCl .currNumCl').text(dta.numCL.curr)
                            var prevCL = '<h4>'+dta.numCL.prev+' <i class="fa fa-info-circle iconTip" title="Tổng số checklist cùng kỳ năm ngoái"></i></h4>';
                            prevCL += (Number(dta.numCL.prev.replace(",","")) > Number(dta.numCL.curr.replace(",","")))? '<span class="down"><i class="fa fa-arrow-down fadeInDown animated" aria-hidden="true"></i> ' : '<span class="up"><i class="fa fa-arrow-up fadeInUp animated" aria-hidden="true"></i> '
                            prevCL += dta.numCL.perct+' % </span> from '+dta.lastYYYY
                            $('#boxNumCl .prevNumCl').html("").append(prevCL)
                            if(dta.numCL.curr == "0" && dta.numCL.prev == "0") $('#boxNumCl').attr('style','opacity:0.2')
                            else $('#boxNumCl').removeAttr('style')
                            // box Process time checklist 75%
                            $('#boxTimeCl .currTimeCl').text(dta.timeCL.curr)
                            var prevTimeCL = '<h4>'+dta.timeCL.prev+' hours <i class="fa fa-info-circle iconTip" title="Thời gian xử lý checklist 75% cùng kỳ năm ngoái"></i></h4>';
                            prevTimeCL += (Number(dta.timeCL.prev.replace(",","")) > Number(dta.timeCL.curr.replace(",","")))? '<span class="down"><i class="fa fa-arrow-down fadeInDown animated" aria-hidden="true"></i> ' : '<span class="up"><i class="fa fa-arrow-up fadeInUp animated" aria-hidden="true"></i> '
                            prevTimeCL += dta.timeCL.perct+' % </span> from '+dta.lastYYYY
                            $('#boxTimeCl .prevTimeCl').html("").append(prevTimeCL)
                            if(dta.timeCL.curr == "0" && dta.timeCL.prev == "0") $('#boxTimeCl').attr('style','opacity:0.2')
                            else $('#boxTimeCl').removeAttr('style')
                            // box Churn rate have checklist
                            $('#boxRmCl .currRmCl').text(dta.churnRateCL.curr)
                            var prevChurnCL = '<h4>'+dta.churnRateCL.prev+' <i class="fa fa-info-circle iconTip" title="Tỷ lệ rời mạng khách hàng có checklist, bao gồm HSSD và CTBDV, trung bình cùng kỳ năm ngoái"></i></h4>';
                            prevChurnCL += (Number(dta.churnRateCL.prev.replace(",","")) > Number(dta.churnRateCL.curr.replace(",","")))? '<span class="down"><i class="fa fa-arrow-down fadeInDown animated" aria-hidden="true"></i> ' : '<span class="up"><i class="fa fa-arrow-up fadeInUp animated" aria-hidden="true"></i> '
                            prevChurnCL += dta.churnRateCL.perct+' % </span> from '+dta.lastYYYY
                            $('#boxRmCl .prevRmCl').html("").append(prevChurnCL)
                            if(dta.churnRateCL.curr == "0" && dta.churnRateCL.prev == "0") $('#boxRmCl').attr('style','opacity:0.2')
                            else $('#boxRmCl').removeAttr('style')

                            // update chart 1
                            churn1.xAxis[0].update({categories: dta.churn1.cates})
                            updateCharts(churn1, getJson2Column1Line(dta.churn1.count_ct, dta.churn1.churnPercent, dta.churn1.count_all, "Count Checklist"))
                            // update chart 2
                            churn2.xAxis[0].update({categories: dta.churn2.cates});
                            updateCharts(churn2, getJsonChurnMonth(dta.churn2.churnRate, dta.churn2.churnPercent))
                        }
                        else{
                            alert("Error when execute query. Please check again your system!")
                        }

                    },
                    complete: function () {
                        $('.divLeft').waitMe("hide");
                    }
                });
            }

            // click tab and get json data
            function getChurnByTab(tab_name) {
                var fields = getParamFields(document.querySelector('input[name=csrfToken]').value)
                $.ajax({
                    url: "/checklist/getJsonByTab",
                    cache: false,
                    data:  fields,
                    type:"POST",
                    beforeSend: function () {
                        $("html, body").animate({ scrollTop: $("#"+tab_name).offset().top - $(window).height()/3 });
                        $('#'+tab_name).waitMe({
                            effect: 'facebook',
                            text: '',
                            bg: 'rgba(255,255,255,0.7)',
                            color: '#2A3F54',
                            textPos: 'vertical'
                        });
                    },
                    success: function (dta) {
                        if(dta != "Error"){
                            function handlerOut() {
                                $('.custom_tooltip').hide()
                            }
                            // comment Chart
                            $('.comment').text(dta.cmtChart)
                            if(tab_name == "tabRegion"){
                                // bubble charts Region and Month
                                var mouseX;
                                var mouseY;
                                $(document).mousemove(function(e) {
                                    if($(window).width() < 992){
                                        mouseY = e.pageY - 790
                                    }
                                    else{
                                        mouseY = e.pageY -490;
                                    }
                                });
                                if(dta.churnRegionMonth.data.length <= 0){
                                    $('#churn4_overlay').hide()
                                    $('#churn4').hide()
                                }
                                else{
                                    $('#churn4_overlay').show()
                                    $('#churn4').show()
                                }
                                $('#churn4_txtMin').text(dta.churnRegionMonth.minPercent)
                                $('#churn4_txtMax').text(dta.churnRegionMonth.maxPercent)
                                $('#churn4_circle2').text(Number(dta.churnRegionMonth.minPercent + (dta.churnRegionMonth.maxPercent-dta.churnRegionMonth.minPercent)/5*2).toFixed(2))
                                $('#churn4_circle3').text(Number(dta.churnRegionMonth.minPercent + (dta.churnRegionMonth.maxPercent-dta.churnRegionMonth.minPercent)/5*3).toFixed(2))
                                Object.keys(dta.churnRegionMonth.catesRegion).length >8 ? $('#churn4').attr('style','height: 420px'): $('#churn4').attr('style','height: 360px')
                                var chartRegionMonth = new google.visualization.BubbleChart(document.getElementById('churn4'))
                                google.visualization.events.addListener(chartRegionMonth, 'ready', function () {
                                    Array.prototype.forEach.call(document.getElementById('churn4').getElementsByTagName('text'), function(text) {
                                        if ((text.getAttribute('text-anchor') === 'end') && (text.getAttribute('fill') === '#444444')) {
                                            if(text.innerHTML == 0 || text.innerHTML == undefined || text.innerHTML == Object.keys(dta.churnRegionMonth.catesRegion).length+1)
                                                text.setAttribute('fill-opacity',0)
                                            else{
                                                text.innerHTML = keyByValue(dta.churnRegionMonth.catesRegion, Number(text.innerHTML))
                                            }
                                        }
                                        // change label month
                                        if ((text.getAttribute('text-anchor') === 'end') && (text.getAttribute('fill') === '#1c2752')) {
                                            if(Object.keys(dta.churnRegionMonth.catesMonth).length == 1){
                                                if (text.innerHTML == 0.5 || text.innerHTML == 0.0 || text.innerHTML == 1.5)
                                                    text.setAttribute('fill-opacity', 0)
                                                else {
                                                    if(text.innerHTML == 1.0){
                                                        text.innerHTML = keyByValue(dta.churnRegionMonth.catesMonth, 1)
                                                    }
                                                }
                                            }
                                            else{
                                                if(text.innerHTML == 0 || text.innerHTML >= Object.keys(dta.churnRegionMonth.catesMonth).length+1)
                                                    text.setAttribute('fill-opacity',0)
                                                else{
                                                    text.innerHTML = keyByValue(dta.churnRegionMonth.catesMonth, Number(text.innerHTML))
                                                }
                                            }
                                        }
                                    });
                                    // remove circle value =0
                                    Array.prototype.forEach.call(document.getElementById('churn4').getElementsByTagName('circle'), function(circle) {
                                        if(circle.getAttribute('r') == 5 && Number(dta.churnRegionMonth.isNull) == 1)
                                            circle.setAttribute('r', 1)
                                    })
                                })
                                var dataRegionMonth = google.visualization.arrayToDataTable(getDataChurn(dta.churnRegionMonth.data,  "Month", "Location"))
                                if(Object.keys(dta.churnRegionMonth.catesMonth).length == 1)
                                    optionsRegion.hAxis.gridlines.count = 4
                                else
                                    optionsRegion.hAxis.gridlines.count = Object.keys(dta.churnRegionMonth.catesMonth).length+2
                                optionsRegion.vAxis.gridlines.count = Object.keys(dta.churnRegionMonth.catesRegion).length+2
                                optionsRegion.chartArea.left =170;
                                optionsRegion.colorAxis.colors = ['#F6CECE', '#B40404'];
                                chartRegionMonth.draw(dataRegionMonth, optionsRegion)
                                google.visualization.events.addListener(chartRegionMonth, 'onmouseover', function (event) {
                                    var rate = dataRegionMonth.getValue(event.row, 3);
                                    var xAxis = dataRegionMonth.getValue(event.row, 1);
                                    var yAxis = dataRegionMonth.getValue(event.row, 2);
                                    var percent = dataRegionMonth.getValue(event.row, 4);
                                    var contracts = dataRegionMonth.getValue(event.row, 5);
                                    var x = mouseX - 225;
                                    if($(window).width() < 992){
                                        mouseY = mouseY - 870
                                    }
                                    else{
                                        mouseY = mouseY -600
                                    }
                                    var y = mouseY
                                    if(!(Number(percent == 0) && Number(rate) == 0)){
                                        $('#churn4_tooltip').html('<div><p><b>Month:</b> ' + keyByValue(dta.churnRegionMonth.catesMonth, xAxis) +'</p><p><b>Location:</b> '+ keyByValue( dta.churnRegionMonth.catesRegion, yAxis) +
                                                '</p><p><b>Rate:</b> '+ rate +' %</p><p><b>Percent:</b> '+ percent +' %</p><p><b>Number of contracts: </b>'+contracts+'</p></div>').css({
                                            'top': y,
                                            'left': x
                                        }).fadeIn('slow');
                                    }
                                    // remove circle value =0
                                    Array.prototype.forEach.call(document.getElementById('churn4').getElementsByTagName('circle'), function(circle) {
                                        if(Number(dta.churnRegionMonth.isNull) == 1 && (circle.getAttribute('fill') == 'none' || circle.getAttribute('r') == 5)){
                                            circle.setAttribute('r', 1)
                                        }
                                    })
                                })
                                google.visualization.events.addListener(chartRegionMonth, 'onmouseout', handlerOut)
                                // Number of Contracts That Have Checklist(s) by Region (%) 2-3 sai
                                Highcharts.chart('churn3', {
                                    chart: {
                                        type: 'heatmap',
                                        marginTop: 40,
                                        marginBottom: 70,
                                        plotBorderWidth: 1
                                    },
                                    title: {
                                        text: ''
                                    },
                                    xAxis: {
                                        categories: dta.heatmapCL.cateX
                                    },
                                    yAxis: {
                                        categories: dta.heatmapCL.cateY,
                                        title: null
                                    },
                                    colorAxis: {
                                        minColor: '#FFFFFF',
                                        maxColor: '#3498DB',
                                        type: 'logarithmic',
                                        stops: [
                                            [0, '#FFFFFF'],
                                            [0.41, '#e3ecef'],
                                            [1, '#3498DB']
                                        ]
                                    },
                                    legend: {
                                        align: 'right',
                                        layout: 'vertical',
                                        margin: 0,
                                        verticalAlign: 'top',
                                        y: 25,
                                        symbolHeight: 280
                                    },
                                    plotOptions: {
                                        series: {
                                            dataLabels:{
                                                formatter:function(){
                                                    var nf = new Intl.NumberFormat();
                                                    return nf.format(this.point.value)+" %";
                                                }
                                            }
                                        }
                                    },
                                    tooltip: {
                                        formatter: function () {
                                            return 'Month: <b>' + this.series.xAxis.categories[this.point.x] +'</b><br/>Location: <b>'+ this.series.yAxis.categories[this.point.y] + '</b><br/>Number of contracts: <b>' +
                                                    this.point.name +'</b>';
                                        }
                                    },
                                    series: [{
                                        name: 'total contracts',
                                        borderWidth: 0.1,
                                        borderColor: '#78c679',
                                        data: getdataHeatMapRegionMonth( dta.heatmapCL.data, dta.heatmapCL.dataX, dta.heatmapCL.dataY),
                                        dataLabels: {
                                            enabled: true,
                                            color: '#000000',
                                            style: {
                                                "fontSize": "10px"
                                            }
                                        }
                                    }]

                                });
                                // bubble charts To Bao Tri & Month
                                if(dta.churnTBTMonth.data.length <= 0){
                                    $('#bubleTBT_overlay').hide()
                                    $('#bubleTBT').hide()
                                }
                                else{
                                    $('#bubleTBT_overlay').show()
                                    $('#bubleTBT').show()
                                }
                                $('#churn5_txtMin').text(dta.churnTBTMonth.minPercent)
                                $('#churn5_txtMax').text(dta.churnTBTMonth.maxPercent)
                                $('#churn5_circle2').text(Number(dta.churnTBTMonth.minPercent + (dta.churnTBTMonth.maxPercent-dta.churnTBTMonth.minPercent)/5*2).toFixed(2))
                                $('#churn5_circle3').text(Number(dta.churnTBTMonth.minPercent + (dta.churnTBTMonth.maxPercent-dta.churnTBTMonth.minPercent)/5*3).toFixed(2))
                                var chartTBTMonth = new google.visualization.BubbleChart(document.getElementById('bubleTBT'))
                                google.visualization.events.addListener(chartTBTMonth, 'ready', function () {
                                    Array.prototype.forEach.call(document.getElementById('bubleTBT').getElementsByTagName('text'), function(text) {
                                        if ((text.getAttribute('text-anchor') === 'end') && (text.getAttribute('fill') === '#444444')) {
                                            if(text.innerHTML == 0 || text.innerHTML == undefined || text.innerHTML == Object.keys(dta.churnTBTMonth.catesTBT).length+1)
                                                text.setAttribute('fill-opacity',0)
                                            else{
                                                text.innerHTML = keyByValue(dta.churnTBTMonth.catesTBT, Number(text.innerHTML))
                                            }
                                        }
                                        // change label month
                                        if ((text.getAttribute('text-anchor') === 'end') && (text.getAttribute('fill') === '#1c2752')) {
                                            if(Object.keys(dta.churnTBTMonth.catesMonth).length == 1){
                                                if (text.innerHTML == 0.5 || text.innerHTML == 0.0 || text.innerHTML == 1.5)
                                                    text.setAttribute('fill-opacity', 0)
                                                else {
                                                    if(text.innerHTML == 1.0){
                                                        text.innerHTML = keyByValue(dta.churnTBTMonth.catesMonth, 1)
                                                    }
                                                }
                                            }
                                            else{
                                                if(text.innerHTML == 0 || text.innerHTML >= Object.keys(dta.churnTBTMonth.catesMonth).length+1)
                                                    text.setAttribute('fill-opacity',0)
                                                else{
                                                    text.innerHTML = keyByValue(dta.churnTBTMonth.catesMonth, Number(text.innerHTML))
                                                }
                                            }
                                        }
                                    });
                                    // remove circle value =0
                                    Array.prototype.forEach.call(document.getElementById('bubleTBT').getElementsByTagName('circle'), function(circle) {
                                        if(circle.getAttribute('r') == 5 && Number(dta.churnTBTMonth.isNull) == 1)
                                            circle.setAttribute('r', 1)
                                    })
                                })
                                var dataTBTMonth = google.visualization.arrayToDataTable(getDataChurn(dta.churnTBTMonth.data,  "Month", "TBT"))
                                if(Object.keys(dta.churnTBTMonth.catesMonth).length == 1)
                                    optionsRegion.hAxis.gridlines.count = 4
                                else
                                    optionsRegion.hAxis.gridlines.count = Object.keys(dta.churnTBTMonth.catesMonth).length+2
                                optionsRegion.vAxis.gridlines.count = Object.keys(dta.churnTBTMonth.catesTBT).length+2
                                optionsRegion.chartArea.left =170;
                                optionsRegion.colorAxis.colors = ['#F5F6CE', 'green'];
                                chartTBTMonth.draw(dataTBTMonth, optionsRegion)
                                google.visualization.events.addListener(chartTBTMonth, 'onmouseover', function (event) {
                                    var rate = dataTBTMonth.getValue(event.row, 3);
                                    var xAxis = dataTBTMonth.getValue(event.row, 1);
                                    var yAxis = dataTBTMonth.getValue(event.row, 2);
                                    var percent = dataTBTMonth.getValue(event.row, 4);
                                    var contracts = dataTBTMonth.getValue(event.row, 5);
                                    var x = mouseX - 225;
                                    if($(window).width() < 992){
                                        mouseY = mouseY - 870
                                    }
                                    else{
                                        mouseY = mouseY -1020
                                    }
                                    var y = mouseY
                                    if(!(Number(percent == 0) && Number(rate) == 0)){
                                        $('#bubleTBT_tooltip').html('<div><p><b>Month:</b> ' + keyByValue(dta.churnTBTMonth.catesMonth, xAxis) +'</p><p><b>Doi Tac:</b> '+ keyByValue( dta.churnTBTMonth.catesTBT, yAxis) +
                                                '</p><p><b>Rate:</b> '+ rate +' %</p><p><b>Percent:</b> '+ percent +' %</p><p><b>Number of contracts: </b>'+contracts+'</p></div>').css({
                                            'top': y,
                                            'left': x
                                        }).fadeIn('slow');
                                    }
                                    // remove circle value =0
                                    Array.prototype.forEach.call(document.getElementById('bubleTBT').getElementsByTagName('circle'), function(circle) {
                                        if(Number(dta.churnTBTMonth.isNull) == 1 && (circle.getAttribute('fill') == 'none' || circle.getAttribute('r') == 5)){
                                            circle.setAttribute('r', 1)
                                        }
                                    })
                                })
                                google.visualization.events.addListener(chartTBTMonth, 'onmouseout', handlerOut)
                                // sparkline table
                                var tBodyTBT = parseTbChurnRate(dta.tbTBT, dta.tbTBT.arrMonth, 1)
                                $('#tbChurn1').html("").append(tBodyTBT)
                                $('.sparkline1').sparkline('html',{
                                    type: 'line',
                                    width: '320px',
                                    height: '15px',
                                    lineColor: '#16a085',
                                    fillColor: '#ffffff',
                                    lineWidth: 1,
                                    spotColor: '#e21212',
                                    minSpotColor: '#132186',
                                    maxSpotColor: '#132186',
                                    highlightLineColor: '#ffffff',
                                    valueSpots:{'0:':'#e21212'},
                                    tooltipFormat: '{{offset:names}}: <b>{{y:value}}</b>',
                                    tooltipValueLookups: {
                                        names: dta.tbTBT.arrMonth
                                    }
                                });
                            }
                            else if(tab_name == "tabAge"){
                                if(dta.cLRegionAge.cateY.length > 7) $('#churn5').attr('style','width: auto; height:450px')
                                else $('#churn5').attr('style','height:350px;width: auto')
                                Highcharts.chart('churn5', {
                                    chart: {
                                        type: 'heatmap',
                                        marginTop: 40,
                                        marginBottom: 70,
                                        plotBorderWidth: 1
                                    },
                                    title: {
                                        text: ''
                                    },
                                    xAxis: {
                                        categories: dta.cLRegionAge.cateX
                                    },
                                    yAxis: {
                                        categories: dta.cLRegionAge.cateY,
                                        title: null
                                    },
                                    colorAxis: {
                                        minColor: '#FFFFFF',
                                        maxColor: '#f1b53d'
                                    },
                                    legend: {
                                        align: 'right',
                                        layout: 'vertical',
                                        margin: 0,
                                        verticalAlign: 'top',
                                        y: 25,
                                        symbolHeight: 280
                                    },
                                    plotOptions: {
                                        series: {
                                            dataLabels:{
                                                formatter:function(){
                                                    var nf = new Intl.NumberFormat();
                                                    return nf.format(this.point.value)+" %";
                                                }
                                            }
                                        }
                                    },
                                    tooltip: {
                                        formatter: function () {
                                            return 'Month: <b>' + this.series.xAxis.categories[this.point.x] +'</b><br/>Location: <b>'+ this.series.yAxis.categories[this.point.y] + '</b><br/>Number of contracts: <b>' +
                                                    this.point.name +'</b>';
                                        }
                                    },
                                    series: [{
                                        name: 'total contracts',
                                        borderWidth: 0.1,
                                        borderColor: '#78c679',
                                        data: getdataHeatMapRegionMonth( dta.cLRegionAge.data, dta.cLRegionAge.dataX, dta.cLRegionAge.dataY),
                                        dataLabels: {
                                            enabled: true,
                                            color: '#000000',
                                            style: {
                                                "fontSize": "10px"
                                            }
                                        }
                                    }]

                                });
                                // bubble charts Age & Location
                                if(dta.trendAgeLocation.data.length <= 0){
                                    $('#churn6_overlay').hide()
                                    $('#churn6').hide()
                                }
                                else{
                                    $('#churn6_overlay').show()
                                    $('#churn6').show()
                                }
                                $('#churn6_txtMin').text(dta.trendAgeLocation.minPercent)
                                $('#churn6_txtMax').text(dta.trendAgeLocation.maxPercent)
                                $('#churn6_circle2').text(Number(dta.trendAgeLocation.minPercent + (dta.trendAgeLocation.maxPercent-dta.trendAgeLocation.minPercent)/5*2).toFixed(2))
                                $('#churn6_circle3').text(Number(dta.trendAgeLocation.minPercent + (dta.trendAgeLocation.maxPercent-dta.trendAgeLocation.minPercent)/5*3).toFixed(2))
                                var chartRegionAge = new google.visualization.BubbleChart(document.getElementById('churn6'))
                                Object.keys(dta.trendAgeLocation.catesRegion).length >8 ? $('#churn6').attr('style','height: 550px'): $('#churn6').attr('style','height: 420px')
                                google.visualization.events.addListener(chartRegionAge, 'ready', function () {
                                    Array.prototype.forEach.call(document.getElementById('churn6').getElementsByTagName('text'), function(text) {
                                        if ((text.getAttribute('text-anchor') === 'end') && (text.getAttribute('fill') === '#444444')) {
                                            if(text.innerHTML == 0 || text.innerHTML == undefined || text.innerHTML == Object.keys(dta.trendAgeLocation.catesRegion).length+1)
                                                text.setAttribute('fill-opacity',0)
                                            else{
                                                text.innerHTML = keyByValue(dta.trendAgeLocation.catesRegion, Number(text.innerHTML))
                                            }
                                        }
                                        // change label month
                                        if ((text.getAttribute('text-anchor') === 'middle') && (text.getAttribute('fill') === '#444444')) {
                                            if(Object.keys(dta.trendAgeLocation.catesMonth).length == 1){
                                                if (text.innerHTML == 0.5 || text.innerHTML == 0.0 || text.innerHTML == 1.5)
                                                    text.setAttribute('fill-opacity', 0)
                                                else {
                                                    if(text.innerHTML == 1.0){
                                                        text.innerHTML = keyByValue(dta.trendAgeLocation.catesMonth, 1)
                                                    }
                                                }
                                            }
                                            else{
                                                if(text.innerHTML == 0 || text.innerHTML >= Object.keys(dta.trendAgeLocation.catesMonth).length+1)
                                                    text.setAttribute('fill-opacity',0)
                                                else{
                                                    text.innerHTML = keyByValue(dta.trendAgeLocation.catesMonth, Number(text.innerHTML))
                                                }
                                            }
                                        }
                                    });
                                    // remove circle value =0
                                    Array.prototype.forEach.call(document.getElementById('churn6').getElementsByTagName('circle'), function(circle) {
                                        if(circle.getAttribute('r') == 5 && Number(dta.trendAgeLocation.isNull) == 1)
                                            circle.setAttribute('r', 1)
                                    })
                                })
                                var dataRegionAge = google.visualization.arrayToDataTable(getDataChurn(dta.trendAgeLocation.data,  "Location", "Age"))
                                if(Object.keys(dta.trendAgeLocation.catesMonth).length == 1)
                                    options.hAxis.gridlines.count = 4
                                else
                                    options.hAxis.gridlines.count = Object.keys(dta.trendAgeLocation.catesMonth).length+2
                                options.vAxis.gridlines.count = Object.keys(dta.trendAgeLocation.catesRegion).length+2
                                //options.chartArea.left =170;
                                chartRegionAge.draw(dataRegionAge, options)
                                google.visualization.events.addListener(chartRegionAge, 'onmouseover', function (event) {
                                    var rate = dataRegionAge.getValue(event.row, 3);
                                    var xAxis = dataRegionAge.getValue(event.row, 1);
                                    var yAxis = dataRegionAge.getValue(event.row, 2);
                                    var percent = dataRegionAge.getValue(event.row, 4);
                                    var contracts = dataRegionAge.getValue(event.row, 5);
                                    var x = mouseX - 6625;
                                    if($(window).width() < 992){
                                        mouseY = mouseY - 870
                                    }
                                    else{
                                        mouseY = mouseY -600
                                    }
                                    var y = mouseY
                                    if(!(Number(percent == 0) && Number(rate) == 0)){
                                        $('#churn6_tooltip').html('<div><p><b>Age:</b> ' + keyByValue(dta.trendAgeLocation.catesMonth, xAxis) +'</p><p><b>Location:</b> '+ keyByValue( dta.trendAgeLocation.catesRegion, yAxis) +
                                                '</p><p><b>Rate:</b> '+ rate +' %</p><p><b>Percent:</b> '+ percent +' %</p><p><b>Number of contracts: </b>'+contracts+'</p></div>').css({
                                            'top': y,
                                            'left': x
                                        }).fadeIn('slow');
                                    }
                                    // remove circle value =0
                                    Array.prototype.forEach.call(document.getElementById('churn6').getElementsByTagName('circle'), function(circle) {
                                        if(Number(dta.trendAgeLocation.isNull) == 1 && (circle.getAttribute('fill') == 'none' || circle.getAttribute('r') == 5)){
                                            circle.setAttribute('r', 1)
                                        }
                                    })
                                })
                                google.visualization.events.addListener(chartRegionAge, 'onmouseout', handlerOut)
                            }
                            else if(tab_name == "tabTime"){
                                if(dta.cLRegionTime.cateY.length > 7) $('#churn7').attr('style','width: auto; height:450px')
                                else $('#churn7').attr('style','height:350px;width: auto')
                                Highcharts.chart('churn7', {
                                    chart: {
                                        type: 'heatmap',
                                        marginTop: 40,
                                        marginBottom: 70,
                                        plotBorderWidth: 1
                                    },
                                    title: {
                                        text: ''
                                    },
                                    xAxis: {
                                        categories: dta.cLRegionTime.cateX
                                    },
                                    yAxis: {
                                        categories: dta.cLRegionTime.cateY,
                                        title: null
                                    },
                                    colorAxis: {
                                        minColor: '#ffffe5',
                                        maxColor: '#006837',
                                        type: 'logarithmic',
                                        stops: [
                                            [0, '#ffffe5'],
                                            [0.67, '#78c679'],
                                            [1, '#006837']
                                        ]
                                    },
                                    legend: {
                                        align: 'right',
                                        layout: 'vertical',
                                        margin: 0,
                                        verticalAlign: 'top',
                                        y: 25,
                                        symbolHeight: 280
                                    },
                                    plotOptions: {
                                        series: {
                                            dataLabels:{
                                                formatter:function(){
                                                    var nf = new Intl.NumberFormat();
                                                    return nf.format(this.point.value);
                                                }
                                            }
                                        }
                                    },
                                    tooltip: {
                                        formatter: function () {
                                            return 'ProcessTime: <b>' + this.series.xAxis.categories[this.point.x] +'</b><br/>Location: <b>'+ this.series.yAxis.categories[this.point.y] + '</b><br/>Number of contracts: <b>' +
                                                    this.point.value +'</b>';
                                        }
                                    },
                                    series: [{
                                        name: 'total contracts',
                                        borderWidth: 0.1,
                                        borderColor: '#78c679',
                                        data: dta.cLRegionTime.data,
                                        dataLabels: {
                                            enabled: true,
                                            color: '#000000',
                                            style: {
                                                "fontSize": "10px"
                                            }
                                        }
                                    }]

                                });
                                // bubble charts Processing Time & Location
                                if(dta.trendTimeLocation.data.length <= 0){
                                    $('#churn8_overlay').hide()
                                    $('#churn8').hide()
                                }
                                else{
                                    $('#churn8_overlay').show()
                                    $('#churn8').show()
                                }
                                $('#churn8_txtMin').text(dta.trendTimeLocation.minPercent)
                                $('#churn8_txtMax').text(dta.trendTimeLocation.maxPercent)
                                $('#churn8_circle2').text(Number(dta.trendTimeLocation.minPercent + (dta.trendTimeLocation.maxPercent-dta.trendTimeLocation.minPercent)/5*2).toFixed(2))
                                $('#churn8_circle3').text(Number(dta.trendTimeLocation.minPercent + (dta.trendTimeLocation.maxPercent-dta.trendTimeLocation.minPercent)/5*3).toFixed(2))
                                var chartRegionTime = new google.visualization.BubbleChart(document.getElementById('churn8'))
                                Object.keys(dta.trendTimeLocation.catesRegion).length >8 ? $('#churn8').attr('style','height: 550px'): $('#churn8').attr('style','height: 420px')
                                google.visualization.events.addListener(chartRegionTime, 'ready', function () {
                                    Array.prototype.forEach.call(document.getElementById('churn8').getElementsByTagName('text'), function(text) {
                                        if ((text.getAttribute('text-anchor') === 'end') && (text.getAttribute('fill') === '#444444')) {
                                            if(text.innerHTML == 0 || text.innerHTML == undefined || text.innerHTML == Object.keys(dta.trendTimeLocation.catesRegion).length+1)
                                                text.setAttribute('fill-opacity',0)
                                            else{
                                                text.innerHTML = keyByValue(dta.trendTimeLocation.catesRegion, Number(text.innerHTML))
                                            }
                                        }
                                        // change label month
                                        if ((text.getAttribute('text-anchor') === 'middle') && (text.getAttribute('fill') === '#444444')) {
                                            if(Object.keys(dta.trendTimeLocation.catesMonth).length == 1){
                                                if (text.innerHTML == 0.5 || text.innerHTML == 0.0 || text.innerHTML == 1.5)
                                                    text.setAttribute('fill-opacity', 0)
                                                else {
                                                    if(text.innerHTML == 1.0){
                                                        text.innerHTML = keyByValue(dta.trendTimeLocation.catesMonth, 1)
                                                    }
                                                }
                                            }
                                            else{
                                                if(text.innerHTML == 0 || text.innerHTML >= Object.keys(dta.trendTimeLocation.catesMonth).length+1)
                                                    text.setAttribute('fill-opacity',0)
                                                else{
                                                    text.innerHTML = keyByValue(dta.trendTimeLocation.catesMonth, Number(text.innerHTML))
                                                }
                                            }
                                        }
                                    });
                                    // remove circle value =0
                                    Array.prototype.forEach.call(document.getElementById('churn8').getElementsByTagName('circle'), function(circle) {
                                        if(circle.getAttribute('r') == 5 && Number(dta.trendTimeLocation.isNull) == 1)
                                            circle.setAttribute('r', 1)
                                    })
                                })
                                var dataRegionTime = google.visualization.arrayToDataTable(getDataChurn(dta.trendTimeLocation.data,  "Location", "Time"))
                                if(Object.keys(dta.trendTimeLocation.catesMonth).length == 1)
                                    options.hAxis.gridlines.count = 4
                                else
                                    options.hAxis.gridlines.count = Object.keys(dta.trendTimeLocation.catesMonth).length+2
                                options.vAxis.gridlines.count = Object.keys(dta.trendTimeLocation.catesRegion).length+2
                                chartRegionTime.draw(dataRegionTime, options)
                                google.visualization.events.addListener(chartRegionTime, 'onmouseover', function (event) {
                                    var rate = dataRegionTime.getValue(event.row, 3);
                                    var xAxis = dataRegionTime.getValue(event.row, 1);
                                    var yAxis = dataRegionTime.getValue(event.row, 2);
                                    var percent = dataRegionTime.getValue(event.row, 4);
                                    var contracts = dataRegionTime.getValue(event.row, 5);
                                    var x = mouseX - 6625;
                                    if($(window).width() < 992){
                                        mouseY = mouseY - 870
                                    }
                                    else{
                                        mouseY = mouseY -600
                                    }
                                    var y = mouseY
                                    if(!(Number(percent == 0) && Number(rate) == 0)){
                                        $('#churn8_tooltip').html('<div><p><b>Processing Time:</b> ' + keyByValue(dta.trendTimeLocation.catesMonth, xAxis) +'</p><p><b>Location:</b> '+ keyByValue( dta.trendTimeLocation.catesRegion, yAxis) +
                                                '</p><p><b>Rate:</b> '+ rate +' %</p><p><b>Percent:</b> '+ percent +' %</p><p><b>Number of contracts: </b>'+contracts+'</p></div>').css({
                                            'top': y,
                                            'left': x
                                        }).fadeIn('slow');
                                    }
                                    // remove circle value =0
                                    Array.prototype.forEach.call(document.getElementById('churn8').getElementsByTagName('circle'), function(circle) {
                                        if(Number(dta.trendTimeLocation.isNull) == 1 && (circle.getAttribute('fill') == 'none' || circle.getAttribute('r') == 5)){
                                            circle.setAttribute('r', 1)
                                        }
                                    })
                                })
                                google.visualization.events.addListener(chartRegionTime, 'onmouseout', handlerOut)
                            }
                            else{
                                // tab Reason and position
                                var count = 0
                                if (count == 0) {
                                    count = 1;
                                    var width = 1;
                                    var id = setInterval(frame, 10);
                                    function frame() {
                                        if (width >= 100) {
                                            clearInterval(id);
                                            count = 0;
                                        } else {
                                            width++;
                                            $('.divBar').attr('style','width:'+width+'%')
                                        }
                                    }
                                }
                                if(dta.cLRegionCause.cateY.length > 7) $('#churn9').attr('style','width: auto; height:430px')
                                else $('#churn9').attr('style','height:350px;width: auto')
                                /* NGUYEN NHAN XAY RA LOI */
                                Highcharts.chart('churn9', {
                                    chart: {
                                        type: 'heatmap',
                                        marginTop: 20,
                                        marginBottom: 100,
                                        plotBorderWidth: 1
                                    },
                                    title: {
                                        text: ''
                                    },
                                    xAxis: {
                                        categories: dta.cLRegionCause.cateX
                                    },
                                    yAxis: {
                                        categories: dta.cLRegionCause.cateY,
                                        title: null
                                    },
                                    colorAxis: {
                                        minColor: '#ffffe5',
                                        maxColor: '#006837',
                                        type: 'logarithmic',
                                        stops: [
                                            [0, '#ffffe5'],
                                            [0.67, '#78c679'],
                                            [1, '#006837']
                                        ]
                                    },
                                    legend: {
                                        align: 'right',
                                        layout: 'vertical',
                                        margin: 0,
                                        verticalAlign: 'top',
                                        y: 25,
                                        symbolHeight: 280
                                    },
                                    plotOptions: {
                                        series: {
                                            dataLabels:{
                                                formatter:function(){
                                                    var nf = new Intl.NumberFormat();
                                                    return nf.format(this.point.value);
                                                }
                                            }
                                        }
                                    },
                                    tooltip: {
                                        formatter: function () {
                                            return 'Cause: <b>' + this.series.xAxis.categories[this.point.x] +'</b><br/>Location: <b>'+ this.series.yAxis.categories[this.point.y] + '</b><br/>Number of contracts: <b>' +
                                                    this.point.value +'</b>';
                                        }
                                    },
                                    series: [{
                                        name: 'total contracts',
                                        borderWidth: 0.1,
                                        borderColor: '#78c679',
                                        data: dta.cLRegionCause.data,
                                        dataLabels: {
                                            enabled: true,
                                            color: '#000000',
                                            style: {
                                                "fontSize": "10px"
                                            }
                                        }
                                    }]

                                });
                                // bubble charts Cause & Location
                                if(dta.trendCauseLocation.data.length <= 0){
                                    $('#churn10_overlay').hide()
                                    $('#churn10').hide()
                                }
                                else{
                                    $('#churn10_overlay').show()
                                    $('#churn10').show()
                                }
                                $('#churn10_txtMin').text(dta.trendCauseLocation.minPercent)
                                $('#churn10_txtMax').text(dta.trendCauseLocation.maxPercent)
                                $('#churn10_circle2').text(Number(dta.trendCauseLocation.minPercent + (dta.trendCauseLocation.maxPercent-dta.trendCauseLocation.minPercent)/5*2).toFixed(2))
                                $('#churn10_circle3').text(Number(dta.trendCauseLocation.minPercent + (dta.trendCauseLocation.maxPercent-dta.trendCauseLocation.minPercent)/5*3).toFixed(2))
                                var chartRegionCause = new google.visualization.BubbleChart(document.getElementById('churn10'))
                                Object.keys(dta.trendCauseLocation.catesRegion).length >8 ? $('#churn10').attr('style','height: 570px'): $('#churn8').attr('style','height: 540px')
                                google.visualization.events.addListener(chartRegionCause, 'ready', function () {
                                    Array.prototype.forEach.call(document.getElementById('churn10').getElementsByTagName('text'), function(text) {
                                        if ((text.getAttribute('text-anchor') === 'end') && (text.getAttribute('fill') === '#444444')) {
                                            if(text.innerHTML == 0 || text.innerHTML == undefined || text.innerHTML == Object.keys(dta.trendCauseLocation.catesRegion).length+1)
                                                text.setAttribute('fill-opacity',0)
                                            else{
                                                text.innerHTML = keyByValue(dta.trendCauseLocation.catesRegion, Number(text.innerHTML))
                                            }
                                        }
                                        // change label month
                                        if ((text.getAttribute('text-anchor') === 'end') && (text.getAttribute('fill') === '#1c2752')) {
                                            if(Object.keys(dta.trendCauseLocation.catesMonth).length == 1){
                                                if (text.innerHTML == 0.5 || text.innerHTML == 0.0 || text.innerHTML == 1.5)
                                                    text.setAttribute('fill-opacity', 0)
                                                else {
                                                    if(text.innerHTML == 1.0){
                                                        text.innerHTML = keyByValue(dta.trendCauseLocation.catesMonth, 1)
                                                    }
                                                }
                                            }
                                            else{
                                                if(text.innerHTML == 0 || text.innerHTML >= Object.keys(dta.trendCauseLocation.catesMonth).length+1)
                                                    text.setAttribute('fill-opacity',0)
                                                else{
                                                    text.innerHTML = keyByValue(dta.trendCauseLocation.catesMonth, parseInt(Number(text.innerHTML)+0.3))
                                                }
                                            }
                                        }
                                    });
                                    // remove circle value =0
                                    Array.prototype.forEach.call(document.getElementById('churn10').getElementsByTagName('circle'), function(circle) {
                                        if(circle.getAttribute('r') == 5 && Number(dta.trendCauseLocation.isNull) == 1)
                                            circle.setAttribute('r', 1)
                                    })
                                })
                                var dataRegionCause = google.visualization.arrayToDataTable(getDataChurn(dta.trendCauseLocation.data,  "Location", "Cause"))
                                if(Object.keys(dta.trendCauseLocation.catesMonth).length == 1)
                                    optionsCause.hAxis.gridlines.count = 4
                                else
                                    optionsCause.hAxis.gridlines.count = Object.keys(dta.trendCauseLocation.catesMonth).length+2
                                optionsCause.vAxis.gridlines.count = Object.keys(dta.trendCauseLocation.catesRegion).length+2
                                optionsCause.chartArea.bottom = 90
                                chartRegionCause.draw(dataRegionCause, optionsCause)
                                google.visualization.events.addListener(chartRegionCause, 'onmouseover', function (event) {
                                    var rate = dataRegionCause.getValue(event.row, 3);
                                    var xAxis = dataRegionCause.getValue(event.row, 1);
                                    var yAxis = dataRegionCause.getValue(event.row, 2);
                                    var percent = dataRegionCause.getValue(event.row, 4);
                                    var contracts = dataRegionCause.getValue(event.row, 5);
                                    var x = mouseX - 6625;
                                    if($(window).width() < 992){
                                        mouseY = mouseY - 870
                                    }
                                    else{
                                        mouseY = mouseY -600
                                    }
                                    var y = mouseY
                                    if(!(Number(percent == 0) && Number(rate) == 0)){
                                        $('#churn10_tooltip').html('<div><p><b>Cause:</b> ' + keyByValue(dta.trendCauseLocation.catesMonth, xAxis) +'</p><p><b>Location:</b> '+ keyByValue( dta.trendCauseLocation.catesRegion, yAxis) +
                                                '</p><p><b>Rate:</b> '+ rate +' %</p><p><b>Percent:</b> '+ percent +' %</p><p><b>Number of contracts: </b>'+contracts+'</p></div>').css({
                                            'top': y,
                                            'left': x
                                        }).fadeIn('slow');
                                    }
                                    // remove circle value =0
                                    Array.prototype.forEach.call(document.getElementById('churn10').getElementsByTagName('circle'), function(circle) {
                                        if(Number(dta.trendCauseLocation.isNull) == 1 && (circle.getAttribute('fill') == 'none' || circle.getAttribute('r') == 5)){
                                            circle.setAttribute('r', 1)
                                        }
                                    })
                                })
                                google.visualization.events.addListener(chartRegionCause, 'onmouseout', handlerOut)

                                /* VI TRI XAY RA LOI */
                                if(dta.cLRegionPosition.cateY.length > 7) $('#churn11').attr('style','width: auto; height:430px')
                                else $('#churn11').attr('style','height:350px;width: auto')
                                Highcharts.chart('churn11', {
                                    chart: {
                                        type: 'heatmap',
                                        marginTop: 20,
                                        marginBottom: 100,
                                        plotBorderWidth: 1
                                    },
                                    title: {
                                        text: ''
                                    },
                                    xAxis: {
                                        categories: dta.cLRegionPosition.cateX
                                    },
                                    yAxis: {
                                        categories: dta.cLRegionPosition.cateY,
                                        title: null
                                    },
                                    colorAxis: {
                                        minColor: '#ffffe5',
                                        maxColor: '#006837',
                                        type: 'logarithmic',
                                        stops: [
                                            [0, '#ffffe5'],
                                            [0.67, '#78c679'],
                                            [1, '#006837']
                                        ]
                                    },
                                    legend: {
                                        align: 'right',
                                        layout: 'vertical',
                                        margin: 0,
                                        verticalAlign: 'top',
                                        y: 25,
                                        symbolHeight: 280
                                    },
                                    plotOptions: {
                                        series: {
                                            dataLabels:{
                                                formatter:function(){
                                                    var nf = new Intl.NumberFormat();
                                                    return nf.format(this.point.value);
                                                }
                                            }
                                        }
                                    },
                                    tooltip: {
                                        formatter: function () {
                                            return 'Position: <b>' + this.series.xAxis.categories[this.point.x] +'</b><br/>Location: <b>'+ this.series.yAxis.categories[this.point.y] + '</b><br/>Number of contracts: <b>' +
                                                    this.point.value +'</b>';
                                        }
                                    },
                                    series: [{
                                        name: 'total contracts',
                                        borderWidth: 0.1,
                                        borderColor: '#78c679',
                                        data: dta.cLRegionPosition.data,
                                        dataLabels: {
                                            enabled: true,
                                            color: '#000000',
                                            style: {
                                                "fontSize": "10px"
                                            }
                                        }
                                    }]

                                });
                                // bubble charts Position & Location
                                if(dta.trendPositionLocation.data.length <= 0){
                                    $('#churn12_overlay').hide()
                                    $('#churn12').hide()
                                }
                                else{
                                    $('#churn12_overlay').show()
                                    $('#churn12').show()
                                }
                                $('#churn12_txtMin').text(dta.trendPositionLocation.minPercent)
                                $('#churn12_txtMax').text(dta.trendPositionLocation.maxPercent)
                                $('#churn12_circle2').text(Number(dta.trendPositionLocation.minPercent + (dta.trendPositionLocation.maxPercent-dta.trendPositionLocation.minPercent)/5*2).toFixed(2))
                                $('#churn12_circle3').text(Number(dta.trendPositionLocation.minPercent + (dta.trendPositionLocation.maxPercent-dta.trendPositionLocation.minPercent)/5*3).toFixed(2))
                                var chartRegionPosition = new google.visualization.BubbleChart(document.getElementById('churn12'))
                                Object.keys(dta.trendPositionLocation.catesRegion).length >8 ? $('#churn10').attr('style','height: 570px'): $('#churn8').attr('style','height: 540px')
                                google.visualization.events.addListener(chartRegionPosition, 'ready', function () {
                                    Array.prototype.forEach.call(document.getElementById('churn12').getElementsByTagName('text'), function(text) {
                                        if ((text.getAttribute('text-anchor') === 'end') && (text.getAttribute('fill') === '#444444')) {
                                            if(text.innerHTML == 0 || text.innerHTML == undefined || text.innerHTML == Object.keys(dta.trendPositionLocation.catesRegion).length+1)
                                                text.setAttribute('fill-opacity',0)
                                            else{
                                                text.innerHTML = keyByValue(dta.trendPositionLocation.catesRegion, Number(text.innerHTML))
                                            }
                                        }
                                        // change label month
                                        if ((text.getAttribute('text-anchor') === 'end') && (text.getAttribute('fill') === '#1c2752')) {
                                            if(Object.keys(dta.trendPositionLocation.catesMonth).length == 1){
                                                if (text.innerHTML == 0.5 || text.innerHTML == 0.0 || text.innerHTML == 1.5)
                                                    text.setAttribute('fill-opacity', 0)
                                                else {
                                                    if(text.innerHTML == 1.0){
                                                        text.innerHTML = keyByValue(dta.trendPositionLocation.catesMonth, 1)
                                                    }
                                                }
                                            }
                                            else{
                                                if(text.innerHTML == 0 || text.innerHTML >= Object.keys(dta.trendPositionLocation.catesMonth).length+1)
                                                    text.setAttribute('fill-opacity',0)
                                                else{
                                                    text.innerHTML = keyByValue(dta.trendPositionLocation.catesMonth, parseInt(Number(text.innerHTML)+0.3))
                                                }
                                            }
                                        }
                                    });
                                    // remove circle value =0
                                    Array.prototype.forEach.call(document.getElementById('churn12').getElementsByTagName('circle'), function(circle) {
                                        if(circle.getAttribute('r') == 5 && Number(dta.trendPositionLocation.isNull) == 1)
                                            circle.setAttribute('r', 1)
                                    })
                                })
                                var dataRegionPosition = google.visualization.arrayToDataTable(getDataChurn(dta.trendPositionLocation.data,  "Location", "Position"))
                                if(Object.keys(dta.trendCauseLocation.catesMonth).length == 1)
                                    optionsCause.hAxis.gridlines.count = 4
                                else
                                    optionsCause.hAxis.gridlines.count = Object.keys(dta.trendPositionLocation.catesMonth).length+2
                                optionsCause.vAxis.gridlines.count = Object.keys(dta.trendPositionLocation.catesRegion).length+2
                                optionsCause.chartArea.bottom = 80
                                chartRegionPosition.draw(dataRegionPosition, optionsCause)
                                google.visualization.events.addListener(chartRegionPosition, 'onmouseover', function (event) {
                                    var rate = dataRegionPosition.getValue(event.row, 3);
                                    var xAxis = dataRegionPosition.getValue(event.row, 1);
                                    var yAxis = dataRegionPosition.getValue(event.row, 2);
                                    var percent = dataRegionPosition.getValue(event.row, 4);
                                    var contracts = dataRegionPosition.getValue(event.row, 5);
                                    var x = mouseX - 6625;
                                    if($(window).width() < 992){
                                        mouseY = mouseY - 870
                                    }
                                    else{
                                        mouseY = mouseY -600
                                    }
                                    var y = mouseY
                                    if(!(Number(percent == 0) && Number(rate) == 0)){
                                        $('#churn12_tooltip').html('<div><p><b>Position:</b> ' + keyByValue(dta.trendPositionLocation.catesMonth, xAxis) +'</p><p><b>Location:</b> '+ keyByValue( dta.trendPositionLocation.catesRegion, yAxis) +
                                                '</p><p><b>Rate:</b> '+ rate +' %</p><p><b>Percent:</b> '+ percent +' %</p><p><b>Number of contracts: </b>'+contracts+'</p></div>').css({
                                            'top': y,
                                            'left': x
                                        }).fadeIn('slow');
                                    }
                                    // remove circle value =0
                                    Array.prototype.forEach.call(document.getElementById('churn12').getElementsByTagName('circle'), function(circle) {
                                        if(Number(dta.trendPositionLocation.isNull) == 1 && (circle.getAttribute('fill') == 'none' || circle.getAttribute('r') == 5)){
                                            circle.setAttribute('r', 1)
                                        }
                                    })
                                })
                                google.visualization.events.addListener(chartRegionPosition, 'onmouseout', handlerOut)
                            }
                        }
                        else{
                            alert("Error when execute query. Please check again your system!")
                        }
                    },
                    complete: function () {
                        $('#commentBox').show();
                        $('#'+tab_name).waitMe("hide");
                    }
                });
            }

            // click apply fitler
            $('.apply').click(function () {
                ajaxGetChurnChecklist()
            });
            // click refresh fitler
            $('.btnRefresh').click(function () {
                $('.slAge').val('').trigger('change')
                $('.slPackage').val('').trigger('change')
                $('.slCause').val('*').trigger('change')
                $('.slPosition').val('*').trigger('change')
                $('.slProcess').val('*').trigger('change')
                $('.slTime').val('24').trigger('change')
                $('.slGrpChl').val('*').trigger('change')
                $('.checkbox').removeAttr('checked').iCheck('update')
                $(".monthPicker").datepicker("update", $('#monthCurr').val())
                $(".region").jstree("deselect_all")
                $('#province').val("")
                $('#tabName').val("")
                $('#commentBox').hide()
                ajaxGetChurnChecklist()
            })
            // click comment insert
            $('.btnCmt').click(function () {
                var fields = {
                    "csrfToken": document.querySelector('input[name=csrfToken]').value,
                    "comment"  : $(this).parent().parent().find('.comment').val(),
                    "tabName"  : "Checklist_"+$('#tabName').val()
                }
                insertComment(fields)
            });
        }

        function getParamFields(token){
            var boxes = $('.statusDiv .checkbox:checked');
            var status = ""
            boxes.each(function(i, chkbox) {
                status += chkbox.value
            });
            $('#status').val(status)
            var obj = {
                "csrfToken" : token,
                "region"  : $('#province').val() == "All" ? "": $('#province').val(),
                "age"    : $('.ageDiv .select2-selection__choice').text().substring(1,$('.ageDiv .select2-selection__choice').text().length).split('x').join(','),
                "package": $('.packageDiv .select2-selection__choice').text().substring(1,$('.packageDiv .select2-selection__choice').text().length).split('x').join(','),
                "month"  : $('.monthGrp').val(),
                "status" : status,
                "tabName" : $('#tabName').val(),
                "typeCurr"    : $('#typeCurr').val(),
                "topType"     : $('#typeArr').val(),
                "cause"      : $('.slCause').val(),
                "position" : $('.slPosition').val(),
                "processTime" : $('.slProcess').val(),
                "timeCL"    : $('.slTime').val(),
                "groupCL"   : $('.slGrpChl').val()
            }
            //console.log(obj)
            return obj
        }
</script>